{% extends "nurses/base.html" %}
{% load static %}

{% block title %}HMS | Nurse Activity Report{% endblock %}

{% block content %}

<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-5-theme/1.3.0/select2-bootstrap-5-theme.min.css" rel="stylesheet">

  {%include "nurses/nurses.css"%}

<div class="generate-reports-page">
    <div class="container dashboard-container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body text-center py-3">
                        <div class="icon-wrapper mx-auto mb-2">
                            <i class="fas fa-chart-bar text-white fa-lg"></i>
                        </div>
                        <h4 class="mb-2 text-dark">Nurse Reports Dashboard</h4>
                     

                        <!-- Generate Reports Button -->
                        <button class="btn btn-lg generate-btn px-4 py-2" data-bs-toggle="modal" data-bs-target="#reportsModal">
                            <i class="fas fa-chart-line me-2"></i>
                            Generate Reports
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Reports Generation Modal -->
    <div class="modal fade" id="reportsModal" tabindex="-1" aria-labelledby="reportsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title" id="reportsModalLabel">
                        <i class="fas fa-chart-bar me-1"></i>
                        Generate Reports
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-3">
                    <form id="reportForm" novalidate>
                        <div class="mb-2">
                            <label for="selectUser" class="form-label">User *</label>
                            <select class="form-select form-select-sm" id="selectUser" required>
                                <option value="">Search for a user...</option>
                                <option value="dr_smith">Dr. Sarah Smith</option>
                                <option value="nurse_johnson">Nurse Jennifer Johnson</option>
                                <option value="dr_williams">Dr. Michael Williams</option>
                                <option value="nurse_brown">Nurse Patricia Brown</option>
                                <option value="admin_davis">Admin Lisa Davis</option>
                                <option value="dr_garcia">Dr. Maria Garcia</option>
                                <option value="nurse_wilson">Nurse Robert Wilson</option>
                                <option value="dr_lee">Dr. James Lee</option>
                                <option value="nurse_taylor">Nurse Amanda Taylor</option>
                                <option value="admin_martinez">Admin Carlos Martinez</option>
                                <option value="dr_anderson">Dr. Emily Anderson</option>
                                <option value="nurse_thomas">Nurse David Thomas</option>
                            </select>
                            <div class="invalid-feedback">Please select a user.</div>
                        </div>

                        <div class="mb-2">
                            <label for="reportType" class="form-label">Report Type *</label>
                            <select class="form-select form-select-sm" id="reportType" required>
                                <option value="">Select type...</option>
                                <option value="patient_list">Patient List</option>
                                <option value="admitted_patients">Admitted Patients</option>
                                <option value="vitals">Vitals</option>
                                <option value="nurse_notes">Nurse Notes</option>
                                <option value="referrals">Referrals</option>
                            </select>
                            <div class="invalid-feedback">Please select a report type.</div>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Date Filter</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="dateFilter" id="allDates" value="all" checked>
                                <label class="form-check-label" for="allDates">All Dates</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="dateFilter" id="dateRange" value="range">
                                <label class="form-check-label" for="dateRange">Date Range</label>
                            </div>
                        </div>

                        <div id="dateFields" class="date-fields mb-2">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label for="startDate" class="form-label">Start</label>
                                    <input type="date" class="form-control form-control-sm" id="startDate" disabled>
                                    <div class="invalid-feedback">Select start date.</div>
                                </div>
                                <div class="col-6">
                                    <label for="endDate" class="form-label">End</label>
                                    <input type="date" class="form-control form-control-sm" id="endDate" disabled>
                                    <div class="invalid-feedback">Select valid end date.</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-generate-report btn-sm" onclick="generateReport()">
                        <i class="fas fa-download me-1"></i>
                        Generate
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>
                        Report Generated Successfully
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-file-download fa-4x text-success"></i>
                    </div>
                    <h5>Your report is ready!</h5>
                    <p class="text-muted">The report has been generated and is available for download.</p>
                    <button class="btn btn-success">
                        <i class="fas fa-download me-1"></i>
                        Download Report
                    </button>
                </div>
            </div>
        </div>
    </div>


</div>

<section class="content">
    <div class="container-fluid">



        <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ total_vitals_recorded }}</h3>
                        <p>Vitals Recorded</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <a href="#" class="small-box-footer">
                        Today: {{ vitals_today }} <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ nursing_notes_added }}</h3>
                        <p>Nursing Notes Added</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-sticky-note"></i>
                    </div>
                    <a href="#" class="small-box-footer">
                        Today: {{ nursing_notes_today }} <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ admissions_processed }}</h3>
                        <p>Patients Admitted</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <a href="#" class="small-box-footer">
                        Today: {{ admissions_today }} <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ discharges_processed }}</h3>
                        <p>Patients Discharged</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <a href="#" class="small-box-footer">
                        Today: {{ discharges_today }} <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                <div class="small-box bg-primary">
                    <div class="inner">
                        <h3>{{ referrals_made }}</h3>
                        <p>Referrals Made</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-share-alt"></i>
                    </div>
                    <a href="#" class="small-box-footer">
                        Today: {{ referrals_today }} <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                <div class="small-box bg-secondary">
                    <div class="inner">
                        <h3>{{ handovers_logged }}</h3>
                        <p>Handovers Logged</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <a href="#" class="small-box-footer">
                        Today: {{ handovers_today }} <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            {# Add more summary boxes if needed #}
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-heartbeat mr-2"></i>
                            Recent Vitals Recorded
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-info">{{ recent_vitals|length }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Patient</th>
                                        <th>Temp (°C)</th>
                                        <th>BP</th>
                                        <th>Pulse</th>
                                        <th>BMI</th> {# Added BMI column header #}
                                        <th>Recorded At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for vital in recent_vitals %}
                                    <tr>
                                        <td><strong>{{ vital.patient.full_name }}</strong></td>
                                        <td>{{ vital.temperature|default:"N/A" }}</td>
                                        <td>{{ vital.blood_pressure|default:"N/A" }}</td>
                                        <td>{{ vital.pulse|default:"N/A" }}</td>
                                        <td>{{ vital.bmi|default:"N/A" }}</td> {# Displaying BMI #}
                                        <td>
                                            <small class="text-muted">
                                                {{ vital.recorded_at|date:"M d, Y H:i" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            {# Changed colspan to 6 #}
                                            <i class="fas fa-notes-medical fa-2x mb-2"></i>
                                            <br>No recent vital signs recorded by you.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card card-success">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-sticky-note mr-2"></i>
                            Recent Nursing Notes
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-success">{{ recent_nursing_notes|length }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Patient</th>
                                        <th>Note Type</th>
                                        <th>Notes Summary</th>
                                        <th>Date/Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for note in recent_nursing_notes %}
                                    <tr>
                                        <td><strong>{{ note.patient.full_name }}</strong></td>
                                        <td><span class="badge badge-primary">{{ note.get_note_type_display }}</span></td>
                                        <td>{{ note.notes|truncatechars:50 }}</td>
                                        <td>
                                            <small class="text-muted">
                                                {{ note.created_at|date:"M d, Y H:i" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <i class="fas fa-file-alt fa-2x mb-2"></i>
                                            <br>No recent nursing notes added by you.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-hospital-user mr-2"></i>
                            Recent Patients Admitted
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-warning">{{ recent_admissions|length }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Patient</th>
                                        <th>Reason</th>
                                        <th>Admitted On</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for admission in recent_admissions %}
                                    <tr>
                                        <td><strong>{{ admission.patient.full_name }}</strong></td>
                                        <td>{{ admission.admission_reason|truncatechars:50 }}</td>
                                        <td>
                                            <small class="text-muted">
                                                {{ admission.admission_date|date:"M d, Y" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">
                                            <i class="fas fa-bed fa-2x mb-2"></i>
                                            <br>No recent admissions processed by you.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card card-danger">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            Recent Patients Discharged
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-danger">{{ recent_discharges|length }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Patient</th>
                                        <th>Summary</th>
                                        <th>Discharged On</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for discharge in recent_discharges %}
                                    <tr>
                                        <td><strong>{{ discharge.patient.full_name }}</strong></td>
                                        <td>{{ discharge.discharge_notes|truncatechars:50 }}</td>
                                        <td>
                                            <small class="text-muted">
                                                {{ discharge.discharge_date|date:"M d, Y" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">
                                            <i class="fas fa-procedures fa-2x mb-2"></i>
                                            <br>No recent discharges processed by you.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-share-alt mr-2"></i>
                            Recent Referrals Made
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-primary">{{ recent_referrals|length }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Patient</th>
                                        <th>Department</th>
                                        <th>Notes Summary</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for referral in recent_referrals %}
                                    <tr>
                                        <td><strong>{{ referral.patient.full_name }}</strong></td>
                                        <td>{{ referral.department.name }}</td>
                                        <td>{{ referral.notes|truncatechars:50 }}</td>
                                        <td>
                                            <small class="text-muted">
                                                {{ referral.created_at|date:"M d, Y H:i" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <i class="fas fa-paper-plane fa-2x mb-2"></i>
                                            <br>No recent referrals made by you.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card card-secondary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-exchange-alt mr-2"></i>
                            Recent Handovers Logged
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-secondary">{{ recent_handovers|length }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Patient</th>
                                        <th>Handover To</th>
                                        <th>Notes Summary</th>
                                        <th>Date/Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for handover in recent_handovers %}
                                    <tr>
                                        <td><strong>{{ handover.patient.full_name }}</strong></td>
                                        <td>{{ handover.recipient.get_full_name }}</td>
                                        <td>{{ handover.notes|truncatechars:50 }}</td>
                                        <td>
                                            <small class="text-muted">
                                                {{ handover.timestamp|date:"M d, Y H:i" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <i class="fas fa-handshake fa-2x mb-2"></i>
                                            <br>No recent handovers logged by you.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<!--GENERATE REPORT BUTTON JS-->


<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>

<script>
    // Initialize Select2 for user selection
    $(document).ready(function () {
        $('#selectUser').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'Search for a user...',
            allowClear: true,
            dropdownParent: $('#reportsModal')
        });
    });

    // Date filter functionality
    const allDatesRadio = document.getElementById('allDates');
    const dateRangeRadio = document.getElementById('dateRange');
    const dateFields = document.getElementById('dateFields');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');

    function toggleDateFields() {
        if (dateRangeRadio.checked) {
            dateFields.classList.add('enabled');
            startDateInput.disabled = false;
            endDateInput.disabled = false;
            startDateInput.required = true;
            endDateInput.required = true;
        } else {
            dateFields.classList.remove('enabled');
            startDateInput.disabled = true;
            endDateInput.disabled = true;
            startDateInput.required = false;
            endDateInput.required = false;
            startDateInput.value = '';
            endDateInput.value = '';
        }
    }

    allDatesRadio.addEventListener('change', toggleDateFields);
    dateRangeRadio.addEventListener('change', toggleDateFields);

    // Form validation
    function validateForm() {
        const form = document.getElementById('reportForm');
        const selectUser = $('#selectUser');
        const reportType = document.getElementById('reportType');
        let isValid = true;

        // Clear previous validation states
        form.classList.remove('was-validated');

        // Validate Select2 user field
        if (!selectUser.val()) {
            selectUser.next('.select2-container').find('.select2-selection').addClass('is-invalid');
            document.getElementById('selectUser').classList.add('is-invalid');
            isValid = false;
        } else {
            selectUser.next('.select2-container').find('.select2-selection').removeClass('is-invalid');
            document.getElementById('selectUser').classList.remove('is-invalid');
            document.getElementById('selectUser').classList.add('is-valid');
        }

        if (!reportType.value) {
            reportType.classList.add('is-invalid');
            isValid = false;
        } else {
            reportType.classList.remove('is-invalid');
            reportType.classList.add('is-valid');
        }

        // Validate date range if selected
        if (dateRangeRadio.checked) {
            if (!startDateInput.value) {
                startDateInput.classList.add('is-invalid');
                isValid = false;
            } else {
                startDateInput.classList.remove('is-invalid');
                startDateInput.classList.add('is-valid');
            }

            if (!endDateInput.value) {
                endDateInput.classList.add('is-invalid');
                isValid = false;
            } else if (startDateInput.value && endDateInput.value <= startDateInput.value) {
                endDateInput.classList.add('is-invalid');
                isValid = false;
            } else {
                endDateInput.classList.remove('is-invalid');
                endDateInput.classList.add('is-valid');
            }
        }

        return isValid;
    }

    function generateReport() {
        if (validateForm()) {
            const generateBtn = document.querySelector('.btn-generate-report');
            const originalText = generateBtn.innerHTML;

            // Show loading state
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            generateBtn.disabled = true;

            // Simulate report generation
            setTimeout(() => {
                // Hide the main modal
                const reportsModal = bootstrap.Modal.getInstance(document.getElementById('reportsModal'));
                reportsModal.hide();

                // Show success modal
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();

                // Reset the button
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;

                // Reset form
                document.getElementById('reportForm').reset();
                $('#selectUser').val(null).trigger('change');
                toggleDateFields();
            }, 2000);
        }
    }

    // Add pulse animation to generate button periodically
    setInterval(() => {
        const btn = document.querySelector('.generate-btn');
        btn.classList.add('pulse');
        setTimeout(() => btn.classList.remove('pulse'), 2000);
    }, 10000);

    // Initialize date fields state
    toggleDateFields();
</script>

        {% endblock %}



