{% extends "hms_admin/base.html" %} {# Or {% extends "hms_admin" %} if you have a specific hms_admin base template #}
{% load static %}

{% block title %}HMS | Admin Department Reports{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Departmental Reports (Admin)</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'hms_admin' %}">Home</a></li>
                    <li class="breadcrumb-item active">Departmental Reports</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="generate-reports-page">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-4">
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-bar me-1"></i>
                            Generate Department Reports
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="departmentReportForm" novalidate>
                            {% csrf_token %} {# Required for AJAX POST requests #}

                            <div class="mb-3">
                                <label for="selectDepartment" class="form-label">Select Department <span
                                        class="text-danger">*</span></label>
                                <select class="form-control select2bs4" id="selectDepartment" name="department_id"
                                    style="width: 100%;" required>
                                    <option value="" disabled selected>Select a department...</option>
                                    {% for department in departments %}
                                    <option value="{{ department.id }}">{{ department.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select a department.</div>
                            </div>

                            <div class="mb-3">
                                <label for="reportType" class="form-label">Report Type <span
                                        class="text-danger">*</span></label>
                                <select class="form-control select2bs4" id="reportType" name="report_type" required
                                    style="width: 100%;" disabled>
                                    <option value="" disabled selected>Select report type...</option>
                                    {# Options will be dynamically loaded via JavaScript #}
                                </select>
                                <div class="invalid-feedback">Please select a report type.</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Date Filter</label>
                                <div class="d-flex flex-wrap">
                                    <div class="form-check form-check-inline me-3">
                                        <input class="form-check-input" type="radio" name="dateFilter" id="allDates"
                                            value="" checked>
                                        <label class="form-check-label" for="allDates">All Dates</label>
                                    </div>
                                    <div class="form-check form-check-inline me-3">
                                        <input class="form-check-input" type="radio" name="dateFilter" id="dateRange"
                                            value="range">
                                        <label class="form-check-label" for="dateRange">Date Range</label>
                                    </div>
                                    <div class="form-check form-check-inline me-3">
                                        <input class="form-check-input" type="radio" name="dateFilter" id="todayFilter"
                                            value="today">
                                        <label class="form-check-label" for="todayFilter">Today</label>
                                    </div>
                                    <div class="form-check form-check-inline me-3">
                                        <input class="form-check-input" type="radio" name="dateFilter" id="weekFilter"
                                            value="week">
                                        <label class="form-check-label" for="weekFilter">This Week</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="dateFilter" id="monthFilter"
                                            value="month">
                                        <label class="form-check-label" for="monthFilter">This Month</label>
                                    </div>
                                </div>
                            </div>

                            <div id="dateFields" class="date-fields mb-3" style="display: none;">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label for="startDate" class="form-label">Start Date</label>
                                        <input type="date" class="form-control form-control-sm" id="startDate" name="start_date" disabled>
                                        <div class="invalid-feedback">Select start date.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="endDate" class="form-label">End Date</label>
                                        <input type="date" class="form-control form-control-sm" id="endDate" name="end_date" disabled>
                                        <div class="invalid-feedback">Select valid end date.</div>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block mt-3">
                                <i class="fas fa-chart-line me-2"></i>
                                Generate Report
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div id="reportDisplayArea" class="card card-info" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title" id="reportResultTitle">Generated Report</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" id="exportExcelBtn" style="display: none;">
                                <i class="fas fa-file-excel"></i> Export to Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0" id="reportTableBody">
                        {# Report data will be loaded here #}
                    </div>
                    <div class="card-footer text-center" id="reportTableFooter" style="display: none;">
                        <span class="text-muted" id="recordCount">Total Records: 0</span>
                    </div>
                </div>
                <div id="noReportMessage" class="alert alert-info text-center" role="alert">
                    <i class="fas fa-info-circle"></i> Select a department and report type, then click 'Generate Report'.
                </div>
            </div>
        </div>
    </div>

    {# Success and Error Modals (Copied from reports.html) #}
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>
                        Report Generated Successfully
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-file-download fa-4x text-success"></i>
                    </div>
                    <h5 id="successMessage">Your report is ready!</h5>
                    <p class="text-muted" id="successDetails">The report has been generated and displayed below.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error Generating Report
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-exclamation-triangle fa-4x text-danger"></i>
                    </div>
                    <h5>An error occurred</h5>
                    <p class="text-muted" id="errorMessage">Please try again or contact support.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize Select2 for department and report type dropdowns
    $('#selectDepartment').select2({
        theme: 'bootstrap4'
    });
    $('#reportType').select2({
        theme: 'bootstrap4'
    });

    // Event listener for Department selection change
    $('#selectDepartment').on('change', function() {
        var departmentId = $(this).val();
        var reportTypeSelect = $('#reportType');
        var generateReportBtn = $('button[type="submit"]');

        // Disable report type dropdown and generate button initially
        reportTypeSelect.prop('disabled', true).val('').trigger('change'); // Clear and disable
        generateReportBtn.prop('disabled', true);
        $('#dateFields').hide(); // Hide date fields when department changes
        $('#startDate').prop('disabled', true);
        $('#endDate').prop('disabled', true);
        $('input[name="dateFilter"][value=""]').prop('checked', true); // Reset date filter to All Dates

        if (departmentId) {
            // Make AJAX call to get report types
            $.ajax({
                url: '{% url "get_department_report_types" %}', // Ensure this URL is correct
                data: {
                    'department_id': departmentId
                },
                dataType: 'json',
                success: function(data) {
                    reportTypeSelect.empty(); // Clear existing options
                    reportTypeSelect.append('<option value="" disabled selected>Select report type...</option>');
                    $.each(data.report_types, function(key, value) {
                        reportTypeSelect.append('<option value="' + value.value + '">' + value.label + '</option>');
                    });
                    reportTypeSelect.prop('disabled', false); // Enable the dropdown
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching report types:", error);
                    reportTypeSelect.empty().append('<option value="" disabled selected>Error loading types...</option>');
                    reportTypeSelect.prop('disabled', true);
                    alert('Error loading report types. Please try again.');
                }
            });
        }
    });

    // Event listener for Report Type selection change
    $('#reportType').on('change', function() {
        // Enable the generate report button once a report type is selected
        if ($(this).val()) {
            $('button[type="submit"]').prop('disabled', false);
        } else {
            $('button[type="submit"]').prop('disabled', true);
        }
    });

    // Event listener for Date Filter radio buttons
    $('input[name="dateFilter"]').on('change', function() {
        if ($(this).val() === 'range') {
            $('#dateFields').slideDown();
            $('#startDate').prop('disabled', false).attr('required', true);
            $('#endDate').prop('disabled', false).attr('required', true);
        } else {
            $('#dateFields').slideUp();
            $('#startDate').prop('disabled', true).removeAttr('required');
            $('#endDate').prop('disabled', true).removeAttr('required');
        }
    });

    // Handle form submission for generating the report
    $('#departmentReportForm').on('submit', function(e) {
        e.preventDefault(); // Prevent default form submission

        var form = $(this);
        if (!form[0].checkValidity()) {
            form.addClass('was-validated');
            return;
        }

        var departmentId = $('#selectDepartment').val();
        var reportType = $('#reportType').val();
        var dateFilter = $('input[name="dateFilter"]:checked').val();
        var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();
        var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

        // Show loading indicator
        Swal.fire({
            title: 'Generating Report...',
            html: 'Please wait while your report is being prepared.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        $.ajax({
            url: '{% url "generate_department_report" %}', // Ensure this URL is correct
            type: 'POST',
            data: {
                'department_id': departmentId,
                'report_type': reportType,
                'date_filter': dateFilter,
                'start_date': startDate,
                'end_date': endDate,
                'csrfmiddlewaretoken': csrfToken
            },
            success: function(response) {
                Swal.close(); // Close loading spinner
                if (response.success) {
                    $('#reportResultTitle').text(response.title);
                    $('#reportTableBody').html(response.html_table);
                    $('#recordCount').text('Total Records: ' + response.record_count);
                    $('#reportTableFooter').show();
                    $('#reportDisplayArea').show();
                    $('#noReportMessage').hide();

                    // Show success modal
                    $('#successMessage').text(response.message);
                    $('#successModal').modal('show');
                } else {
                    $('#reportDisplayArea').hide();
                    $('#noReportMessage').html('<i class="fas fa-exclamation-circle"></i> ' + response.message).show();
                    $('#errorMessage').text(response.message);
                    $('#errorModal').modal('show');
                }
            },
            error: function(xhr, status, error) {
                Swal.close(); // Close loading spinner
                console.error("Error generating report:", error);
                $('#reportDisplayArea').hide();
                $('#noReportMessage').html('<i class="fas fa-exclamation-triangle"></i> An unexpected error occurred. Please try again.').show();
                $('#errorMessage').text('An unexpected error occurred while generating the report.');
                $('#errorModal').modal('show');
            }
        });
    });

    // You might also need to handle the export Excel button if you have that functionality
    $('#exportExcelBtn').on('click', function() {
        // Implement Excel export logic here, e.g., make another AJAX call or navigate to a download URL
        alert('Export to Excel functionality not yet implemented.');
    });
});
</script>
{% endblock %}