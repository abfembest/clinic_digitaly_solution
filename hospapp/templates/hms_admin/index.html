{% extends "hms_admin/base.html" %}
{% load static %}

{% block title %}HMS | Admin Dashboard{% endblock %}

{% block content %}

<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">Admin Dashboard</h1>
            </div><!-- /.col -->
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'hms_admin' %}">Home</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>
        </div><!-- /.row -->
    </div><!-- /.container-fluid -->
</div>
<!-- /.content-header -->

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Info boxes (Small Boxes) -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ total_patients }}</h3>
                        <p>Total Patients</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-ios-people"></i>
                    </div>
                    <a href="{% url 'register_patient' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ patients_admitted }}</h3>
                        <p>Patients Admitted</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-ios-hospital"></i>
                    </div>
                    <a href="{% url 'admit_patient' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ pending_lab_tests }}</h3>
                        <p>Pending Lab Tests</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-flask"></i>
                    </div>
                    <a href="{% url 'lab_test_entry' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>₦{{ pending_bills|floatformat:2 }}</h3>
                        <p>Pending Patient Bills</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-cash"></i>
                    </div>
                    <a href="{% url 'patient_payment_tracker' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
        </div>
        <!-- /.row -->

        <!-- Second row of Info boxes for staff roles -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-primary">
                    <div class="inner">
                        <h3>{{ staff_active_count }}</h3>
                        <p>Active Staff Members</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-person-stalker"></i>
                    </div>
                    <a href="{% url 'staff_profiles' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-secondary">
                    <div class="inner">
                        <h3>{{ total_doctors }}</h3>
                        <p>Total Doctors</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-medkit"></i>
                    </div>
                    <a href="{% url 'staff_profiles' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-light text-dark">
                    <div class="inner">
                        <h3>{{ total_nurses }}</h3>
                        <p>Total Nurses</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-help-buoy"></i>
                    </div>
                    <a href="{% url 'staff_profiles' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-dark">
                    <div class="inner">
                        <h3>{{ upcoming_appointments_today }}</h3>
                        <p>Appointments Today</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-calendar"></i>
                    </div>
                    <a href="{% url 'schedule_appointment' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
        </div>
        <!-- /.row (second row of info boxes) -->

        <div class="row">
            <div class="col-md-7">
                <!-- Financial Overview Card -->
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="far fa-chart-bar"></i> Monthly Financial Overview ({{ current_month|date:"F" }} {{ current_year }})
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 border-right">
                                <h4 class="text-success mb-0">₦{{ monthly_revenue|floatformat:2 }}</h4>
                                <p class="text-muted">Total Revenue</p>
                            </div>
                            <div class="col-md-6">
                                <h4 class="text-danger mb-0">₦{{ monthly_expenses|floatformat:2 }}</h4>
                                <p class="text-muted">Total Expenses</p>
                            </div>
                        </div>
                        <hr>
                        <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                            <canvas id="monthlyRegistrationsChart"></canvas>
                        </div>
                    </div>
                </div>
                <!-- /.card -->
            </div>
            <!-- /.col -->

            <div class="col-md-5">
                <!-- Recently Registered Patients -->
                <div class="card card-info card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-user-plus mr-1"></i> Recently Registered Patients
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-primary">{{ new_patients_last_30_days }} new in 30 days</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <ul class="users-list clearfix">
                            {% for patient in recent_patients %}
                            <li>
                                {% if patient.photo %}
                                <img src="{{ patient.photo.url }}" alt="{{ patient.full_name }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">
                                {% else %}
                                <img src="{% static 'dist/img/default-avatar.png' %}" alt="Default Avatar" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">
                                {% endif %}
                                <a class="users-list-name" href="#">{{ patient.full_name|truncatechars:15 }}</a>
                                <span class="users-list-date">{{ patient.date_registered|date:"M d" }}</span>
                            </li>
                            {% empty %}
                            <li class="text-center p-3 text-muted">No recent patient registrations.</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="card-footer text-center">
                        <a href="{% url 'register_patient' %}" class="uppercase">View All Patients</a>
                    </div>
                </div>
                <!-- /.card -->
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->

        <div class="row">
            <div class="col-md-12">
                <!-- Recent Appointments Table -->
                <div class="card card-success card-outline">
                    <div class="card-header border-transparent">
                        <h3 class="card-title"><i class="ion ion-clipboard mr-1"></i> Recent Upcoming Appointments</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table m-0">
                                <thead>
                                    <tr>
                                        <th>Patient</th>
                                        <th>Department</th>
                                        <th>Scheduled Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for appointment in recent_appointments %}
                                    <tr>
                                        <td><a href="#">{{ appointment.patient.full_name }}</a></td>
                                        <td><span class="badge badge-primary">{{ appointment.department.name }}</span></td>
                                        <td>
                                            <div class="sparkbar" data-color="#00a65a" data-height="20">
                                                {{ appointment.scheduled_time|date:"M d, Y P" }}
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">No upcoming appointments found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer text-center">
                        <a href="{% url 'schedule_appointment' %}" class="uppercase">View All Appointments</a>
                    </div>
                </div>
                <!-- /.card -->
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->

    </div><!--/. container-fluid -->
</section>
<!-- /.content -->

{% endblock %}

{% block extra_js %}
<!-- ChartJS -->
<script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
<script>
    $(document).ready(function () {
        // Wait for DOM to be ready and ensure Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded properly');
            return;
        }

        // Get context with jQuery - using 'get' method on an HTML element
        var canvas = document.getElementById('monthlyRegistrationsChart');
        if (!canvas) {
            console.error('Canvas element not found');
            return;
        }

        var ctx = canvas.getContext('2d');

        // Safely parse JSON data with error handling
        var monthlyRegistrationsLabels, monthlyRegistrationsData;
        
        try {
            monthlyRegistrationsLabels = JSON.parse('{{ monthly_registrations_labels_json|escapejs }}');
            monthlyRegistrationsData = JSON.parse('{{ monthly_registrations_data_json|escapejs }}');
        } catch (e) {
            console.error('Error parsing chart data:', e);
            // Fallback data
            monthlyRegistrationsLabels = ['No Data'];
            monthlyRegistrationsData = [0];
        }

        // Ensure data is valid
        if (!Array.isArray(monthlyRegistrationsLabels) || !Array.isArray(monthlyRegistrationsData)) {
            console.error('Invalid chart data format');
            monthlyRegistrationsLabels = ['No Data'];
            monthlyRegistrationsData = [0];
        }

        var monthlyRegistrationsChartData = {
            labels: monthlyRegistrationsLabels,
            datasets: [
                {
                    label: 'Patient Registrations',
                    backgroundColor: 'rgba(60,141,188,0.2)',
                    borderColor: 'rgba(60,141,188,1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointBackgroundColor: '#3b8bba',
                    pointBorderColor: 'rgba(60,141,188,1)',
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(60,141,188,1)',
                    data: monthlyRegistrationsData,
                    fill: true,
                    tension: 0.4
                }
            ]
        };

        var monthlyRegistrationsChartOptions = {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff'
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0
                    }
                },
                y: {
                    grid: {
                        display: true,
                        color: 'rgba(0,0,0,0.1)'
                    },
                    ticks: {
                        beginAtZero: true,
                        precision: 0,
                        callback: function(value) {
                            return Number.isInteger(value) ? value : '';
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        };

        // Create the Line Chart with error handling
        try {
            new Chart(ctx, {
                type: 'line',
                data: monthlyRegistrationsChartData,
                options: monthlyRegistrationsChartOptions
            });
        } catch (error) {
            console.error('Error creating chart:', error);
            // Show error message in the chart container
            document.querySelector('.chart-container').innerHTML = 
                '<div class="alert alert-warning text-center">Chart could not be loaded. Please refresh the page.</div>';
        }
    });
</script>

<script>
    // Adding default avatar if photo is not available for users list in AdminLTE
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('.users-list img').forEach(img => {
            img.onerror = function() {
                this.onerror = null; // Prevent infinite loop
                this.src = "{% static 'dist/img/default-avatar.png' %}"; // Path to your default avatar image
            };
        });
    });
</script>
{% endblock %}