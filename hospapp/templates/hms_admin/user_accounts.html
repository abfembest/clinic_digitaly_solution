{% extends "hms_admin/base.html" %}
{% load static %} {# Ensure static files are loaded #}

{% block title %}HMS | User Management{% endblock %}

{% block content %}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">User Management</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'hms_admin' %}">Home</a></li>
                    <li class="breadcrumb-item active">User Management</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        <div class="row mb-3">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ total_users }}</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ active_users }}</h3>
                        <p>Active Users</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ inactive_users }}</h3>
                        <p>Inactive Users</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-times"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ role_counts|length }}</h3> {# Displaying count of unique roles #}
                        <p>User Roles</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-cog"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            {% for role_name, count in role_counts.items %}
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box role-filter-card" data-role="{{ role_name }}" style="cursor: pointer;">
                    <span class="info-box-icon bg-primary">
                        {# Dynamic icons based on role name #}
                        {% if role_name == 'Doctor' %}
                            <i class="fas fa-user-md"></i>
                        {% elif role_name == 'Nurse' %}
                            <i class="fas fa-user-nurse"></i>
                        {% elif role_name == 'Administrator' %}
                            <i class="fas fa-user-shield"></i>
                        {% elif role_name == 'Lab Technician' %}
                            <i class="fas fa-flask"></i>
                        {% elif role_name == 'Pharmacy' %}
                            <i class="fas fa-pills"></i>
                        {% elif role_name == 'Receptionist' %}
                            <i class="fas fa-desk"></i>
                        {% elif role_name == 'Account' %}
                            <i class="fas fa-cash-register"></i>
                        {% else %}
                            <i class="fas fa-user"></i>
                        {% endif %}
                    </span>
                    <div class="info-box-content">
                        <span class="info-box-text">{{ role_name }}</span>
                        <span class="info-box-number">{{ count }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users mr-2"></i>
                    System Users
                </h3>
                <div class="card-tools">
                    <div class="row">
                        <div class="col-auto">
                            <label for="roleFilter" class="sr-only">Filter by Role:</label>
                            <select id="roleFilter" class="form-control form-control-sm" style="width: 150px;" onchange="filterTable()">
                                <option value="">All Roles</option>
                                {% for choice in Staff.ROLE_CHOICES %}
                                    {# Use the display name for the option value as that's what's in the table cell #}
                                    <option value="{{ choice.1 }}">{{ choice.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-auto">
                            <label for="statusFilter" class="sr-only">Filter by Status:</label>
                            <select id="statusFilter" class="form-control form-control-sm" style="width: 120px;" onchange="filterTable()">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="usersTable">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Date Joined</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            {# Add data attributes to the row for easier JavaScript access #}
                            <tr data-user-id="{{ user.id }}"
                                data-username="{{ user.username }}"
                                data-email="{{ user.email }}"
                                data-first-name="{{ user.first_name|default:'' }}"
                                data-last-name="{{ user.last_name|default:'' }}"
                                data-role-display="{{ user.staff.get_role_display|default:'No Role' }}"
                                data-role-key="{{ user.staff.role|default:'' }}" {# Added for edit modal mapping #}
                                data-department="{{ user.staff.department.name|default:'Not assigned' }}"
                                data-phone="{{ user.staff.phone_number|default:'' }}"
                                data-is-active="{{ user.is_active|yesno:'true,false' }}"
                                data-user-photo-url="{% if user.staff.photo %}{{ user.staff.photo.url }}{% else %}{% static 'dist/img/default-avatar.png' %}{% endif %}">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <strong>{{ user.username }}</strong>
                                </td>
                                <td>
                                    {% if user.staff.photo %}
                                        <img src="{{ user.staff.photo.url }}" alt="User Photo"
                                             class="img-circle elevation-1" style="width: 30px; height: 30px; margin-right: 5px; object-fit: cover;">
                                    {% else %}
                                        <img src="{% static 'dist/img/default-avatar.png' %}" alt="Default User Photo"
                                             class="img-circle elevation-1" style="width: 30px; height: 30px; margin-right: 5px; object-fit: cover;">
                                    {% endif %}
                                    {{ user.get_full_name|default:"Not provided" }}
                                </td>
                                <td>
                                    {% if user.email %}
                                        <a href="mailto:{{ user.email }}">{{ user.email }}</a>
                                    {% else %}
                                        <span class="text-muted">Not provided</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff %}
                                        <span class="badge badge-info">{{ user.staff.get_role_display }}</span>
                                    {% else %}
                                        <span class="badge badge-secondary">No Role</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff.department %}
                                        {{ user.staff.department.name }}
                                    {% else %}
                                        <span class="text-muted">Not assigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff.phone_number %}
                                        <a href="tel:{{ user.staff.phone_number }}">{{ user.staff.phone_number }}</a>
                                    {% else %}
                                        <span class="text-muted">Not provided</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_active %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-check mr-1"></i>Active
                                        </span>
                                    {% else %}
                                        <span class="badge badge-secondary">
                                            <i class="fas fa-times mr-1"></i>Inactive
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff.date_joined %}
                                        {{ user.staff.date_joined|date:"M d, Y" }}
                                    {% else %}
                                        {{ user.date_joined|date:"M d, Y" }}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-info btn-sm"
                                                onclick="viewUserProfile('{{ user.id }}')" title="View Profile">
                                            <i class="fas fa-eye"></i>
                                        </button>

                                        <button type="button" class="btn btn-primary btn-sm"
                                                onclick="editUser('{{ user.id }}')" title="Edit User">
                                            <i class="fas fa-edit"></i>
                                        </button>

                                        <button type="button" class="btn btn-warning btn-sm"
                                                onclick="toggleUserStatus('{{ user.id }}', '{{ user.username }}', {{ user.is_active|yesno:'true,false' }})"
                                                title="{% if user.is_active %}Disable{% else %}Enable{% endif %} User">
                                            {% if user.is_active %}
                                                <i class="fas fa-user-slash"></i>
                                            {% else %}
                                                <i class="fas fa-user-check"></i>
                                            {% endif %}
                                        </button>

                                        <button type="button" class="btn btn-secondary btn-sm dropdown-toggle dropdown-toggle-split"
                                                data-toggle="dropdown" title="More Actions">
                                            <span class="sr-only">Toggle Dropdown</span>
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item set-password-btn" href="#" data-user-id="{{ user.id }}" data-username="{{ user.username }}">
                                                <i class="fas fa-key mr-2"></i>Set New Password
                                            </a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center text-muted py-4">
                                    <i class="fas fa-users fa-3x mb-3"></i>
                                    <p>No users found.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer">
                <div class="row">
                    <div class="col-sm-6">
                        <p class="text-muted mb-0">
                            <span id="userCount">Showing {{ users|length }} of {{ total_users }} users</span>
                        </p>
                    </div>
                    <div class="col-sm-6 text-right">
                        <button type="button" class="btn btn-primary btn-sm" onclick="addNewUser()">
                            <i class="fas fa-plus mr-1"></i>Add New User
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="exportUsers()">
                            <i class="fas fa-download mr-1"></i>Export Users
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="printUsers()">
                            <i class="fas fa-print mr-1"></i>Print
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<div class="modal fade" id="userProfileModal" tabindex="-1" role="dialog" aria-labelledby="userProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userProfileModalLabel">User Profile</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="userProfileContent">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading profile...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title text-white" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    {% csrf_token %}
                    <input type="hidden" id="editUserId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editUsername">Username</label>
                                <input type="text" class="form-control" id="editUsername" required>
                                <div class="invalid-feedback">Please enter a username.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editEmail">Email address</label>
                                <input type="email" class="form-control" id="editEmail" required>
                                <div class="invalid-feedback">Please enter a valid email address.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editFirstName">First Name</label>
                                <input type="text" class="form-control" id="editFirstName">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editLastName">Last Name</label>
                                <input type="text" class="form-control" id="editLastName">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editRole">Role</label>
                                <select class="form-control select2" id="editRole" style="width: 100%;" required>
                                    <option value="">Select Role</option>
                                    {% for choice in Staff.ROLE_CHOICES %}
                                        <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select a role.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPhone">Phone Number</label>
                                <input type="text" class="form-control" id="editPhone">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="editIsActive">
                        <label class="form-check-label" for="editIsActive">Active User</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    {% csrf_token %} {# Include CSRF token for Django forms #}
                    <div class="form-group">
                        <label for="addUsername">Username</label>
                        <input type="text" class="form-control" id="addUsername" required>
                        <div class="invalid-feedback">Please enter a username (min 3 characters).</div>
                    </div>
                    <div class="form-group">
                        <label for="addEmail">Email address</label>
                        <input type="email" class="form-control" id="addEmail" required>
                        <div class="invalid-feedback">Please enter a valid email address.</div>
                    </div>
                    <div class="form-group">
                        <label for="addPassword">Password</label>
                        <input type="password" class="form-control" id="addPassword" required>
                        <div class="invalid-feedback">Password must be at least 8 characters long and meet complexity requirements.</div>
                    </div>
                    <div class="form-group">
                        <label for="addConfirmPassword">Confirm Password</label>
                        <input type="password" class="form-control" id="addConfirmPassword" required>
                        <div class="invalid-feedback">Passwords do not match.</div>
                    </div>
                     <div class="form-group">
                        <label for="addFirstName">First Name</label>
                        <input type="text" class="form-control" id="addFirstName">
                    </div>
                    <div class="form-group">
                        <label for="addLastName">Last Name</label>
                        <input type="text" class="form-control" id="addLastName">
                    </div>
                    <div class="form-group">
                        <label for="addRole">Role</label>
                        <select class="form-control select2" id="addRole" style="width: 100%;" required>
                            <option value="">Select Role</option>
                            {% for choice in Staff.ROLE_CHOICES %}
                                <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Please select a role.</div>
                    </div>
                    <div class="form-group">
                        <label for="addPhone">Phone Number</label>
                        <input type="text" class="form-control" id="addPhone">
                    </div>
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="addIsActive" checked>
                        <label class="form-check-label" for="addIsActive">Active User</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveNewUser()">Add User</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="statusToggleModal" tabindex="-1" role="dialog" aria-labelledby="statusToggleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusToggleModalLabel">Confirm Status Change</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to <span id="statusAction"></span> user <strong id="statusUsername"></strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusToggle">Confirm</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="setPasswordModal" tabindex="-1" role="dialog" aria-labelledby="setPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setPasswordModalLabel">Set New Password</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Set a new password for user <strong id="setPasswordUsername"></strong>:</p>
                <form id="setPasswordForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                        <div class="invalid-feedback">Password must be at least 8 characters long.</div>
                    </div>
                    <div class="form-group">
                        <label for="confirmNewPassword">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmNewPassword" required>
                        <div class="invalid-feedback">Passwords do not match.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSetPassword">Set Password</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_scripts %}
<script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>
<script src="{% static 'plugins/jszip/jszip.min.js' %}"></script>
<script src="{% static 'plugins/pdfmake/pdfmake.min.js' %}"></script>
<script src="{% static 'plugins/pdfmake/vfs_fonts.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>
<script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>

<script>
    let usersTable;
    let currentUserId = null;
    let currentUsername = null;
    let currentIsActive = null;

    $(function () {
        // Initialize Select2 Elements
        $('.select2').select2();

        // DataTables initialization
        usersTable = $('#usersTable').DataTable({
            "paging": true,
            "lengthChange": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true,
            "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"],
            "columnDefs": [
                { "orderable": false, "targets": [0, 9] },
                { "searchable": false, "targets": [0, 9] }
            ]
        });

        // Attach event listeners for role and status filters
        $('#roleFilter').on('change', function() {
            filterTable();
        });

        $('#statusFilter').on('change', function() {
            filterTable();
        });

        // Event listener for role cards to apply filter
        $('.role-filter-card').on('click', function() {
            const role = $(this).data('role');
            $('#roleFilter').val(role).trigger('change');
            updateActiveRoleCard(role);
        });

        // Update user count on initial load and after any DataTables draw
        usersTable.on('draw.dt', function() {
            updateUserCount();
        });
        updateUserCount();

        // Setup form validation for modals
        setupFormValidation();

        // Handle specific modal button clicks for AJAX

        // Status Toggle Confirmation
        $('#confirmStatusToggle').on('click', function() {
            const userId = currentUserId;
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            $('#statusToggleModal').modal('hide');

            $.ajax({
                url: "{% url 'toggle_user_status' user_id=0 %}".replace('/0/', `/${userId}/`),
                method: 'POST',
                data: {
                    csrfmiddlewaretoken: csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        showAlert('success', response.message || `User ${currentUsername} status toggled successfully.`);
                        location.reload(); // Reload page to reflect changes
                    } else {
                        showAlert('error', response.message || 'Failed to toggle user status.');
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.message || 'An error occurred while toggling user status.';
                    showAlert('error', errorMsg);
                }
            });
        });

        // Set Password Confirmation - Updated to use the endpoint that generates password
        $('#confirmSetPassword').on('click', function() {
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            $('#setPasswordModal').modal('hide');

            $.ajax({
                url: "{% url 'set_user_password' user_id=0 %}".replace('/0/', `/${currentUserId}/`),
                method: 'POST',
                data: {
                    csrfmiddlewaretoken: csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        // Show the generated password to the admin
                        const passwordAlert = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <strong>Password Updated Successfully!</strong><br>
                                <strong>Username:</strong> ${response.username}<br>
                                <strong>New Password:</strong> <code>${response.new_password}</code><br>
                                <small>Please save this password and share it with the user securely.</small>
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        `;
                        $('.content-header').after(passwordAlert);
                        
                        // Auto-hide after 15 seconds for security
                        setTimeout(function() {
                            $('.alert-success').fadeOut();
                        }, 15000);
                    } else {
                        showAlert('error', response.message || 'Failed to set new password.');
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.message || 'An error occurred while setting the password.';
                    showAlert('error', errorMsg);
                }
            });
        });

        // Set Password Modal Event Handlers
        $('.set-password-btn').on('click', function(e) {
            e.preventDefault();
            currentUserId = $(this).data('user-id');
            currentUsername = $(this).data('username');
            $('#setPasswordUsername').text(currentUsername);
            $('#setPasswordModal').modal('show');
        });

        // Edit User Modal Event Handlers (if you have them separately, although onclick is used)
        $('.edit-user-btn').on('click', function(e) {
            e.preventDefault();
            const userId = $(this).data('user-id');
            editUser(userId);
        });

        // Add User Modal Event Handler (if you have them separately, although onclick is used)
        $('.add-user-btn').on('click', function(e) {
            e.preventDefault();
            addNewUser();
        });

        // Save User Changes Event Handler (if you have them separately, although onclick is used)
        $('#saveUserChanges').on('click', function() {
            saveUserChanges();
        });

        // Save New User Event Handler (if you have them separately, although onclick is used)
        $('#saveNewUser').on('click', function() {
            saveNewUser();
        });
    });

    // Function to filter the table based on role and status
    function filterTable() {
        const roleFilter = $('#roleFilter').val();
        const statusFilter = $('#statusFilter').val();
        
        // Apply filters to DataTable
        usersTable.column(4).search(roleFilter).draw(); // Role column
        usersTable.column(7).search(statusFilter).draw(); // Status column
        
        updateUserCount();
        updateActiveRoleCard(roleFilter);
    }

    // Function to update active role card styling
    function updateActiveRoleCard(selectedRole) {
        $('.role-filter-card').removeClass('bg-gradient-primary').addClass('bg-light');
        if (selectedRole) {
            $(`.role-filter-card[data-role="${selectedRole}"]`).removeClass('bg-light').addClass('bg-gradient-primary');
        }
    }

    // Function to update user count display
    function updateUserCount() {
        const info = usersTable.page.info();
        const totalUsers = {{ total_users }};
        $('#userCount').text(`Showing ${info.recordsDisplay} of ${totalUsers} users`);
    }

    // Function to view user profile
    function viewUserProfile(userId) {
        const row = $(`tr[data-user-id="${userId}"]`);
        const userData = {
            username: row.data('username'),
            email: row.data('email'),
            firstName: row.data('first-name'),
            lastName: row.data('last-name'),
            role: row.data('role-display'),
            department: row.data('department'),
            phone: row.data('phone'),
            isActive: row.data('is-active'),
            photoUrl: row.data('user-photo-url')
        };

        const profileHtml = `
            <div class="row">
                <div class="col-md-4 text-center">
                    <img src="${userData.photoUrl}" alt="User Photo" class="img-circle elevation-2" style="width: 120px; height: 120px; object-fit: cover;">
                </div>
                <div class="col-md-8">
                    <table class="table table-borderless">
                        <tr><th>Username:</th><td>${userData.username}</td></tr>
                        <tr><th>Full Name:</th><td>${userData.firstName} ${userData.lastName}</td></tr>
                        <tr><th>Email:</th><td>${userData.email || 'Not provided'}</td></tr>
                        <tr><th>Role:</th><td><span class="badge badge-info">${userData.role}</span></td></tr>
                        <tr><th>Department:</th><td>${userData.department}</td></tr>
                        <tr><th>Phone:</th><td>${userData.phone || 'Not provided'}</td></tr>
                        <tr><th>Status:</th><td>
                            ${userData.isActive === 'true' ? 
                                '<span class="badge badge-success"><i class="fas fa-check mr-1"></i>Active</span>' : 
                                '<span class="badge badge-secondary"><i class="fas fa-times mr-1"></i>Inactive</span>'
                            }
                        </td></tr>
                    </table>
                </div>
            </div>
        `;

        $('#userProfileContent').html(profileHtml);
        $('#userProfileModal').modal('show');
    }

    // Function to edit user
    function editUser(userId) {
        const row = $(`tr[data-user-id="${userId}"]`);
        
        // Populate the edit form with current user data
        $('#editUserId').val(userId);
        $('#editUsername').val(row.data('username'));
        $('#editEmail').val(row.data('email'));
        $('#editFirstName').val(row.data('first-name'));
        $('#editLastName').val(row.data('last-name'));
        $('#editRole').val(row.data('role-key')).trigger('change');
        $('#editPhone').val(row.data('phone'));
        $('#editIsActive').prop('checked', row.data('is-active') === 'true');
        
        $('#editUserModal').modal('show');
    }

    // Function to save user changes
    function saveUserChanges() {
        const form = $('#editUserForm')[0];
        
        // Reset validation states
        $('.form-control').removeClass('is-invalid');
        
        // Validate form
        if (!validateEditForm()) {
            return;
        }
        
        const userId = $('#editUserId').val();
        const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        
        $.ajax({
            url: "{% url 'edit_user' user_id=0 %}".replace('/0/', `/${userId}/`),
            method: 'POST',
            data: {
                csrfmiddlewaretoken: csrfToken,
                username: $('#editUsername').val(),
                email: $('#editEmail').val(),
                first_name: $('#editFirstName').val(),
                last_name: $('#editLastName').val(),
                role: $('#editRole').val(),
                phone_number: $('#editPhone').val(),
                is_active: $('#editIsActive').is(':checked')
            },
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message || 'User updated successfully.');
                    $('#editUserModal').modal('hide');
                    location.reload(); // Reload to reflect changes
                } else {
                    showAlert('error', response.message || 'Failed to update user.');
                }
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON?.message || 'An error occurred while updating the user.';
                showAlert('error', errorMsg);
            }
        });
    }

    // Function to add new user
    function addNewUser() {
        // Reset form
        $('#addUserForm')[0].reset();
        $('.form-control').removeClass('is-invalid');
        $('#addIsActive').prop('checked', true);
        $('#addUserModal').modal('show');
    }

    // Function to save new user
    function saveNewUser() {
        const form = $('#addUserForm')[0];
        
        // Reset validation states
        $('.form-control').removeClass('is-invalid');
        
        // Validate form
        if (!validateAddForm()) {
            return;
        }
        
        const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        
        $.ajax({
            url: "{% url 'add_user' %}",
            method: 'POST',
            data: {
                csrfmiddlewaretoken: csrfToken,
                username: $('#addUsername').val(),
                email: $('#addEmail').val(),
                password: $('#addPassword').val(),
                first_name: $('#addFirstName').val(),
                last_name: $('#addLastName').val(),
                role: $('#addRole').val(),
                phone_number: $('#addPhone').val(),
                is_active: $('#addIsActive').is(':checked')
            },
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message || 'User added successfully.');
                    $('#addUserModal').modal('hide');
                    location.reload(); // Reload to show new user
                } else {
                    showAlert('error', response.message || 'Failed to add user.');
                }
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON?.message || 'An error occurred while adding the user.';
                showAlert('error', errorMsg);
            }
        });
    }

    // Function to toggle user status
    function toggleUserStatus(userId, username, isActive) {
        currentUserId = userId;
        currentUsername = username;
        currentIsActive = isActive;
        
        const action = isActive ? 'disable' : 'enable';
        $('#statusAction').text(action);
        $('#statusUsername').text(username);
        $('#statusToggleModal').modal('show');
    }

    // Function to export users
    function exportUsers() {
        usersTable.button('.buttons-excel').trigger();
    }

    // Function to print users
    function printUsers() {
        usersTable.button('.buttons-print').trigger();
    }

    // Form validation functions
    function setupFormValidation() {
        // Real-time validation for add user form
        $('#addPassword, #addConfirmPassword').on('input', function() {
            validatePasswordMatch('#addPassword', '#addConfirmPassword');
        });
        
        $('#newPassword, #confirmNewPassword').on('input', function() {
            validatePasswordMatch('#newPassword', '#confirmNewPassword');
        });
    }

    function validateAddForm() {
        let isValid = true;
        
        // Username validation
        if ($('#addUsername').val().length < 3) {
            $('#addUsername').addClass('is-invalid');
            isValid = false;
        }
        
        // Email validation
        const email = $('#addEmail').val();
        if (email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                $('#addEmail').addClass('is-invalid');
                isValid = false;
            }
        }
        
        // Password validation
        if ($('#addPassword').val().length < 8) {
            $('#addPassword').addClass('is-invalid');
            isValid = false;
        }
        
        // Confirm password validation
        if ($('#addPassword').val() !== $('#addConfirmPassword').val()) {
            $('#addConfirmPassword').addClass('is-invalid');
            isValid = false;
        }
        
        // Role validation
        if (!$('#addRole').val()) {
            $('#addRole').addClass('is-invalid');
            isValid = false;
        }
        
        return isValid;
    }

    function validateEditForm() {
        let isValid = true;
        
        // Username validation
        if ($('#editUsername').val().length < 3) {
            $('#editUsername').addClass('is-invalid');
            isValid = false;
        }
        
        // Email validation
        const email = $('#editEmail').val();
        if (email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                $('#editEmail').addClass('is-invalid');
                isValid = false;
            }
        }
        
        // Role validation
        if (!$('#editRole').val()) {
            $('#editRole').addClass('is-invalid');
            isValid = false;
        }
        
        return isValid;
    }

    function validatePasswordForm(newPassword, confirmPassword) {
        let isValid = true;
        
        if (newPassword.length < 5) {
            $('#newPassword').addClass('is-invalid');
            isValid = false;
        }
        
        if (newPassword !== confirmPassword) {
            $('#confirmNewPassword').addClass('is-invalid');
            isValid = false;
        }
        
        return isValid;
    }

    function validatePasswordMatch(passwordId, confirmPasswordId) {
        const password = $(passwordId).val();
        const confirmPassword = $(confirmPasswordId).val();
        
        if (password && confirmPassword && password !== confirmPassword) {
            $(confirmPasswordId).addClass('is-invalid');
        } else {
            $(confirmPasswordId).removeClass('is-invalid');
        }
    }

    // Utility function to show alerts
    function showAlert(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;
        
        // Remove existing alerts
        $('.alert').remove();
        
        // Add new alert at the top of the content
        $('.content-header').after(alertHtml);
        
        // Auto-hide success alerts after 5 seconds
        if (type === 'success') {
            setTimeout(function() {
                $('.alert-success').fadeOut();
            }, 5000);
        }
    }
</script>
{% endblock %}