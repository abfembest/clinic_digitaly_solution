{% extends "hms_admin/base.html" %}

{% block title %}HMS | User Management{% endblock %}

{% block content %}

<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">User Management</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'hms_admin' %}">Home</a></li>
                    <li class="breadcrumb-item active">User Management</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        
        <!-- Statistics Cards Row -->
        <div class="row mb-3">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ total_users }}</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ active_users }}</h3>
                        <p>Active Users</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ inactive_users }}</h3>
                        <p>Inactive Users</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-times"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ role_counts|length }}</h3>
                        <p>User Roles</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-cog"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Role Distribution Cards -->
        <div class="row mb-3">
            {% for role_name, count in role_counts.items %}
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box role-filter-card" data-role="{{ role_name }}" style="cursor: pointer;">
                    <span class="info-box-icon bg-primary">
                        {% if role_name == 'Doctor' %}
                            <i class="fas fa-user-md"></i>
                        {% elif role_name == 'Nurse' %}
                            <i class="fas fa-user-nurse"></i>
                        {% elif role_name == 'Administrator' %}
                            <i class="fas fa-user-shield"></i>
                        {% elif role_name == 'Lab Technician' %}
                            <i class="fas fa-flask"></i>
                        {% elif role_name == 'Pharmacy' %}
                            <i class="fas fa-pills"></i>
                        {% elif role_name == 'Receptionist' %}
                            <i class="fas fa-desk"></i>
                        {% else %}
                            <i class="fas fa-user"></i>
                        {% endif %}
                    </span>
                    <div class="info-box-content">
                        <span class="info-box-text">{{ role_name }}</span>
                        <span class="info-box-number">{{ count }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Main Users Table Card -->
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users mr-2"></i>
                    System Users
                </h3>
                <div class="card-tools">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Role Filter Dropdown -->
                            <select id="roleFilter" class="form-control form-control-sm" style="width: 150px;">
                                <option value="">All Roles</option>
                                {% for role_name, count in role_counts.items %}
                                <option value="{{ role_name }}">{{ role_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <!-- Status Filter -->
                            <select id="statusFilter" class="form-control form-control-sm" style="width: 120px;">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="usersTable">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Date Joined</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr data-user-id="{{ user.id }}">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <strong>{{ user.username }}</strong>
                                </td>
                                <td>
                                    {% if user.staff.photo %}
                                        <img src="{{ user.staff.photo.url }}" alt="User Photo" 
                                             class="img-circle elevation-1" style="width: 30px; height: 30px;">
                                    {% endif %}
                                    {{ user.get_full_name|default:"Not provided" }}
                                </td>
                                <td>
                                    {% if user.email %}
                                        <a href="mailto:{{ user.email }}">{{ user.email }}</a>
                                    {% else %}
                                        <span class="text-muted">Not provided</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff %}
                                        <span class="badge badge-info">{{ user.staff.get_role_display }}</span>
                                    {% else %}
                                        <span class="badge badge-secondary">No Role</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff.department %}
                                        {{ user.staff.department.name }}
                                    {% else %}
                                        <span class="text-muted">Not assigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff.phone_number %}
                                        <a href="tel:{{ user.staff.phone_number }}">{{ user.staff.phone_number }}</a>
                                    {% else %}
                                        <span class="text-muted">Not provided</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_active %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-check mr-1"></i>Active
                                        </span>
                                    {% else %}
                                        <span class="badge badge-secondary">
                                            <i class="fas fa-times mr-1"></i>Inactive
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff.date_joined %}
                                        {{ user.staff.date_joined|date:"M d, Y" }}
                                    {% else %}
                                        {{ user.date_joined|date:"M d, Y" }}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-info btn-sm" 
                                                onclick="viewUserProfile({{ user.id }})" title="View Profile">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        
                                        <button type="button" class="btn btn-primary btn-sm" 
                                                onclick="editUser({{ user.id }})" title="Edit User">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        
                                        <button type="button" class="btn btn-warning btn-sm" 
                                                onclick="toggleUserStatus({{ user.id }}, '{{ user.username }}', {{ user.is_active|yesno:'true,false' }})"
                                                title="{% if user.is_active %}Disable{% else %}Enable{% endif %} User">
                                            {% if user.is_active %}
                                                <i class="fas fa-user-slash"></i>
                                            {% else %}
                                                <i class="fas fa-user-check"></i>
                                            {% endif %}
                                        </button>
                                        
                                        <button type="button" class="btn btn-secondary btn-sm dropdown-toggle dropdown-toggle-split" 
                                                data-toggle="dropdown" title="More Actions">
                                            <span class="sr-only">Toggle Dropdown</span>
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="#" onclick="resetPassword({{ user.id }}, '{{ user.username }}')">
                                                <i class="fas fa-key mr-2"></i>Reset Password
                                            </a>
                                            <div class="dropdown-divider"></div>
                                            <a class="dropdown-item text-danger" href="#" onclick="deleteUser({{ user.id }}, '{{ user.username }}')">
                                                <i class="fas fa-trash mr-2"></i>Delete User
                                            </a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center text-muted py-4">
                                    <i class="fas fa-users fa-3x mb-3"></i>
                                    <p>No users found.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Card Footer with Actions -->
            <div class="card-footer">
                <div class="row">
                    <div class="col-sm-6">
                        <p class="text-muted mb-0">
                            <span id="userCount">Showing {{ users|length }} of {{ total_users }} users</span>
                        </p>
                    </div>
                    <div class="col-sm-6 text-right">
                        <button type="button" class="btn btn-primary btn-sm" onclick="addNewUser()">
                            <i class="fas fa-plus mr-1"></i>Add New User
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="exportUsers()">
                            <i class="fas fa-download mr-1"></i>Export Users
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="printUsers()">
                            <i class="fas fa-print mr-1"></i>Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- User Profile Modal -->
<div class="modal fade" id="userProfileModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">
                    <i class="fas fa-user mr-2"></i>User Profile
                </h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="userProfileContent">
                <!-- Profile content will be loaded here -->
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading profile...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">
                    <i class="fas fa-edit mr-2"></i>Edit User
                </h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="editUserContent">
                <form id="editUserForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editUsername">Username</label>
                                <input type="text" class="form-control" id="editUsername" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editEmail">Email</label>
                                <input type="email" class="form-control" id="editEmail" name="email">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editFirstName">First Name</label>
                                <input type="text" class="form-control" id="editFirstName" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editLastName">Last Name</label>
                                <input type="text" class="form-control" id="editLastName" name="last_name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editRole">Role</label>
                                <select class="form-control" id="editRole" name="role">
                                    <option value="">Select Role</option>
                                    <option value="Doctor">Doctor</option>
                                    <option value="Nurse">Nurse</option>
                                    <option value="Administrator">Administrator</option>
                                    <option value="Lab Technician">Lab Technician</option>
                                    <option value="Pharmacy">Pharmacy</option>
                                    <option value="Receptionist">Receptionist</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPhone">Phone Number</label>
                                <input type="tel" class="form-control" id="editPhone" name="phone_number">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="editIsActive" name="is_active">
                            <label class="custom-control-label" for="editIsActive">Active User</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">
                    <i class="fas fa-plus mr-2"></i>Add New User
                </h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addUsername">Username <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="addUsername" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addEmail">Email</label>
                                <input type="email" class="form-control" id="addEmail" name="email">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addPassword">Password <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="addPassword" name="password" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addConfirmPassword">Confirm Password <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="addConfirmPassword" name="confirm_password" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addFirstName">First Name</label>
                                <input type="text" class="form-control" id="addFirstName" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addLastName">Last Name</label>
                                <input type="text" class="form-control" id="addLastName" name="last_name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addRole">Role <span class="text-danger">*</span></label>
                                <select class="form-control" id="addRole" name="role" required>
                                    <option value="">Select Role</option>
                                    <option value="Doctor">Doctor</option>
                                    <option value="Nurse">Nurse</option>
                                    <option value="Administrator">Administrator</option>
                                    <option value="Lab Technician">Lab Technician</option>
                                    <option value="Pharmacy">Pharmacy</option>
                                    <option value="Receptionist">Receptionist</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addPhone">Phone Number</label>
                                <input type="tel" class="form-control" id="addPhone" name="phone_number">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="addIsActive" name="is_active" checked>
                            <label class="custom-control-label" for="addIsActive">Active User</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Toggle Modal -->
<div class="modal fade" id="statusToggleModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Confirm Action</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmStatusToggle">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Reset Password</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="resetPasswordMessage">Are you sure you want to reset the password for this user?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle mr-2"></i>
                    A new temporary password will be generated and displayed.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmPasswordReset">Reset Password</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-danger">Delete User</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteUserMessage">Are you sure you want to delete this user?</p>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. All user data will be permanently deleted.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmUserDelete">Delete User</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let usersTable;
let currentUserId = null;
let usersData = [];

$(document).ready(function() {
    // Store original table data for filtering
    $('#usersTable tbody tr').each(function() {
        const $row = $(this);
        if ($row.find('td').length > 1) { // Skip empty row
            usersData.push({
                element: $row,
                username: $row.find('td:eq(1)').text().trim(),
                fullName: $row.find('td:eq(2)').text().trim(),
                email: $row.find('td:eq(3)').text().trim(),
                role: $row.find('td:eq(4)').text().trim(),
                department: $row.find('td:eq(5)').text().trim(),
                phone: $row.find('td:eq(6)').text().trim(),
                status: $row.find('td:eq(7)').text().trim(),
                dateJoined: $row.find('td:eq(8)').text().trim()
            });
        }
    });

    // Initialize DataTable with enhanced options
    usersTable = $('#usersTable').DataTable({
        "responsive": true,
        "lengthChange": true,
        "autoWidth": false,
        "searching": true,
        "paging": true,
        "pageLength": 25,
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        "info": true,
        "ordering": true,
        "order": [[1, "asc"]], // Sort by username
        "columnDefs": [
            { "orderable": false, "targets": [0, 9] }, // Disable sorting for # and Actions columns
            { "searchable": false, "targets": [0, 9] }, // Disable search for # and Actions columns
        ],
        "language": {
            "emptyTable": "No users found",
            "zeroRecords": "No matching users found",
            "search": "Search users:",
            "lengthMenu": "Show _MENU_ users per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ users",
            "infoEmpty": "No users available",
            "infoFiltered": "(filtered from _MAX_ total users)"
        },
        "dom": 'Bfrtip',
        "buttons": [
            {
                extend: 'copy',
                className: 'btn btn-default btn-sm',
                text: '<i class="fas fa-copy"></i> Copy',
                exportOptions: {
                    columns: [1, 2, 3, 4, 5, 6, 7, 8] // Exclude # and Actions columns
                }
            },
            {
                extend: 'csv',
                className: 'btn btn-default btn-sm',
                text: '<i class="fas fa-file-csv"></i> CSV',
                exportOptions: {
                    columns: [1, 2, 3, 4, 5, 6, 7, 8]
                }
            },
            {
                extend: 'excel',
                className: 'btn btn-default btn-sm',
                text: '<i class="fas fa-file-excel"></i> Excel',
                exportOptions: {
                    columns: [1, 2, 3, 4, 5, 6, 7, 8]
                }
            },
            {
                extend: 'pdf',
                className: 'btn btn-default btn-sm',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                exportOptions: {
                    columns: [1, 2, 3, 4, 5, 6, 7, 8]
                }
            },
            {
                extend: 'print',
                className: 'btn btn-default btn-sm',
                text: '<i class="fas fa-print"></i> Print',
                exportOptions: {
                    columns: [1, 2, 3, 4, 5, 6, 7, 8]
                }
            }
        ],
        "drawCallback": function(settings) {
            updateUserCount();
        }
    });

    // Hide DataTable buttons (we'll use custom buttons)
    $('.dt-buttons').hide();

    // Role filter functionality
    $('#roleFilter').on('change', function() {
        const selectedRole = $(this).val();
        filterTable();
        updateActiveRoleCard(selectedRole);
    });

    // Status filter functionality
    $('#statusFilter').on('change', function() {
        filterTable();
    });

    // Role card click filtering
    $('.role-filter-card').on('click', function() {
        const roleName = $(this).data('role');
        $('#roleFilter').val(roleName);
        filterTable();
        updateActiveRoleCard(roleName);
    });

    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Auto-hide alerts
    setTimeout(function() {
        $('.alert').fadeOut('slow');
    }, 5000);

    // Form validation setup
    setupFormValidation();
});

// Custom filter function
function filterTable() {
    const roleFilter = $('#roleFilter').val().toLowerCase();
    const statusFilter = $('#statusFilter').val().toLowerCase();
    
    let searchTerm = '';
    if (usersTable.search()) {
        searchTerm = usersTable.search().toLowerCase();
    }
    
    usersTable.rows().every(function() {
        const data = this.data();
        const $row = $(this.node());
        
        let showRow = true;
        
        // Role filter
        if (roleFilter && !$row.find('td:eq(4)').text().toLowerCase().includes(roleFilter)) {
            showRow = false;
        }
        
        // Status filter
        if (statusFilter && !$row.find('td:eq(7)').text().toLowerCase().includes(statusFilter)) {
            showRow = false;
        }
        
        // Search term filter
        if (searchTerm) {
            const rowText = $row.text().toLowerCase();
            if (!rowText.includes(searchTerm)) {
                showRow = false;
            }
        }
        
        // Show/hide row
        if (showRow) {
            $row.show();
        } else {
            $row.hide();