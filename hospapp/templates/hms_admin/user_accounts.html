{% extends "hms_admin/base.html" %}

{% load static %}

{% block title %}HMS | User Management{% endblock %}

{% block content %}

<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">User Management</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'hms_admin' %}">Home</a></li>
                    <li class="breadcrumb-item active">User Management</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        
        <!-- Statistics Cards Row -->
        <div class="row mb-3">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ total_users }}</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ active_users }}</h3>
                        <p>Active Users</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ inactive_users }}</h3>
                        <p>Inactive Users</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-times"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ role_counts|length }}</h3>
                        <p>User Roles</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-cog"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Role Distribution Cards -->
        <div class="row mb-3">
            {% for role_name, count in role_counts.items %}
            <div class="col-md-3 col-sm-6 col-12">
                <div class="info-box role-filter-card" data-role="{{ role_name }}" style="cursor: pointer;">
                    <span class="info-box-icon bg-primary">
                        {% if role_name == 'Doctor' %}
                            <i class="fas fa-user-md"></i>
                        {% elif role_name == 'Nurse' %}
                            <i class="fas fa-user-nurse"></i>
                        {% elif role_name == 'Administrator' %}
                            <i class="fas fa-user-shield"></i>
                        {% elif role_name == 'Lab Technician' %}
                            <i class="fas fa-flask"></i>
                        {% elif role_name == 'Pharmacy' %}
                            <i class="fas fa-pills"></i>
                        {% elif role_name == 'Receptionist' %}
                            <i class="fas fa-desk"></i>
                        {% else %}
                            <i class="fas fa-user"></i>
                        {% endif %}
                    </span>
                    <div class="info-box-content">
                        <span class="info-box-text">{{ role_name }}</span>
                        <span class="info-box-number">{{ count }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Main Users Table Card -->
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users mr-2"></i>
                    System Users
                </h3>
                <div class="card-tools">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Role Filter Dropdown -->
                            <select id="roleFilter" class="form-control form-control-sm" style="width: 150px;">
                                <option value="">All Roles</option>
                                {% for role_name, count in role_counts.items %}
                                <option value="{{ role_name }}">{{ role_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <!-- Status Filter -->
                            <select id="statusFilter" class="form-control form-control-sm" style="width: 120px;">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="usersTable">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Date Joined</th>
                                <th style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr data-user-id="{{ user.id }}">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <strong>{{ user.username }}</strong>
                                </td>
                                <td>
                                    {% if user.staff.photo %}
                                        <img src="{{ user.staff.photo.url }}" alt="User Photo" 
                                             class="img-circle elevation-1" style="width: 30px; height: 30px;">
                                    {% endif %}
                                    {{ user.get_full_name|default:"Not provided" }}
                                </td>
                                <td>
                                    {% if user.email %}
                                        <a href="mailto:{{ user.email }}">{{ user.email }}</a>
                                    {% else %}
                                        <span class="text-muted">Not provided</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff %}
                                        <span class="badge badge-info">{{ user.staff.get_role_display }}</span>
                                    {% else %}
                                        <span class="badge badge-secondary">No Role</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff.department %}
                                        {{ user.staff.department.name }}
                                    {% else %}
                                        <span class="text-muted">Not assigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff.phone_number %}
                                        <a href="tel:{{ user.staff.phone_number }}">{{ user.staff.phone_number }}</a>
                                    {% else %}
                                        <span class="text-muted">Not provided</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_active %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-check mr-1"></i>Active
                                        </span>
                                    {% else %}
                                        <span class="badge badge-secondary">
                                            <i class="fas fa-times mr-1"></i>Inactive
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.staff.date_joined %}
                                        {{ user.staff.date_joined|date:"M d, Y" }}
                                    {% else %}
                                        {{ user.date_joined|date:"M d, Y" }}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-info btn-sm" 
                                                onclick="viewUserProfile({{ user.id }})" title="View Profile">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        
                                        <button type="button" class="btn btn-primary btn-sm" 
                                                onclick="editUser({{ user.id }})" title="Edit User">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        
                                        <button type="button" class="btn btn-warning btn-sm" 
                                                onclick="toggleUserStatus({{ user.id }}, '{{ user.username }}', {{ user.is_active|yesno:'true,false' }})"
                                                title="{% if user.is_active %}Disable{% else %}Enable{% endif %} User">
                                            {% if user.is_active %}
                                                <i class="fas fa-user-slash"></i>
                                            {% else %}
                                                <i class="fas fa-user-check"></i>
                                            {% endif %}
                                        </button>
                                        
                                        <button type="button" class="btn btn-secondary btn-sm dropdown-toggle dropdown-toggle-split" 
                                                data-toggle="dropdown" title="More Actions">
                                            <span class="sr-only">Toggle Dropdown</span>
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="#" onclick="resetPassword({{ user.id }}, '{{ user.username }}')">
                                                <i class="fas fa-key mr-2"></i>Reset Password
                                            </a>
                                            <div class="dropdown-divider"></div>
                                            <a class="dropdown-item text-danger" href="#" onclick="deleteUser({{ user.id }}, '{{ user.username }}')">
                                                <i class="fas fa-trash mr-2"></i>Delete User
                                            </a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center text-muted py-4">
                                    <i class="fas fa-users fa-3x mb-3"></i>
                                    <p>No users found.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Card Footer with Actions -->
            <div class="card-footer">
                <div class="row">
                    <div class="col-sm-6">
                        <p class="text-muted mb-0">
                            <span id="userCount">Showing {{ users|length }} of {{ total_users }} users</span>
                        </p>
                    </div>
                    <div class="col-sm-6 text-right">
                        <button type="button" class="btn btn-primary btn-sm" onclick="addNewUser()">
                            <i class="fas fa-plus mr-1"></i>Add New User
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="exportUsers()">
                            <i class="fas fa-download mr-1"></i>Export Users
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="printUsers()">
                            <i class="fas fa-print mr-1"></i>Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- User Profile Modal -->
<div class="modal fade" id="userProfileModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">
                    <i class="fas fa-user mr-2"></i>User Profile
                </h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="userProfileContent">
                <!-- Profile content will be loaded here -->
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading profile...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">
                    <i class="fas fa-edit mr-2"></i>Edit User
                </h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="editUserContent">
                <form id="editUserForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editUsername">Username</label>
                                <input type="text" class="form-control" id="editUsername" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editEmail">Email</label>
                                <input type="email" class="form-control" id="editEmail" name="email">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editFirstName">First Name</label>
                                <input type="text" class="form-control" id="editFirstName" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editLastName">Last Name</label>
                                <input type="text" class="form-control" id="editLastName" name="last_name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editRole">Role</label>
                                <select class="form-control" id="editRole" name="role">
                                    <option value="">Select Role</option>
                                    <option value="Doctor">Doctor</option>
                                    <option value="Nurse">Nurse</option>
                                    <option value="Administrator">Administrator</option>
                                    <option value="Lab Technician">Lab Technician</option>
                                    <option value="Pharmacy">Pharmacy</option>
                                    <option value="Receptionist">Receptionist</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="editPhone">Phone Number</label>
                                <input type="tel" class="form-control" id="editPhone" name="phone_number">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="editIsActive" name="is_active">
                            <label class="custom-control-label" for="editIsActive">Active User</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">
                    <i class="fas fa-plus mr-2"></i>Add New User
                </h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addUsername">Username <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="addUsername" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addEmail">Email</label>
                                <input type="email" class="form-control" id="addEmail" name="email">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addPassword">Password <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="addPassword" name="password" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addConfirmPassword">Confirm Password <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="addConfirmPassword" name="confirm_password" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addFirstName">First Name</label>
                                <input type="text" class="form-control" id="addFirstName" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addLastName">Last Name</label>
                                <input type="text" class="form-control" id="addLastName" name="last_name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addRole">Role <span class="text-danger">*</span></label>
                                <select class="form-control" id="addRole" name="role" required>
                                    <option value="">Select Role</option>
                                    <option value="Doctor">Doctor</option>
                                    <option value="Nurse">Nurse</option>
                                    <option value="Administrator">Administrator</option>
                                    <option value="Lab Technician">Lab Technician</option>
                                    <option value="Pharmacy">Pharmacy</option>
                                    <option value="Receptionist">Receptionist</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addPhone">Phone Number</label>
                                <input type="tel" class="form-control" id="addPhone" name="phone_number">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="addIsActive" name="is_active" checked>
                            <label class="custom-control-label" for="addIsActive">Active User</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Toggle Modal -->
<div class="modal fade" id="statusToggleModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Confirm Action</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmStatusToggle">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Reset Password</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="resetPasswordMessage">Are you sure you want to reset the password for this user?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle mr-2"></i>
                    A new temporary password will be generated and displayed.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmPasswordReset">Reset Password</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-danger">Delete User</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteUserMessage">Are you sure you want to delete this user?</p>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. All user data will be permanently deleted.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmUserDelete">Delete User</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let usersTable;
let currentUserId = null;
let usersData = [];

$(document).ready(function() {
    // Store original table data for filtering
    $('#usersTable tbody tr').each(function() {
        const $row = $(this);
        if ($row.find('td').length > 1) { // Skip empty row
            usersData.push({
                element: $row,
                username: $row.find('td:eq(1)').text().trim(),
                fullName: $row.find('td:eq(2)').text().trim(),
                email: $row.find('td:eq(3)').text().trim(),
                role: $row.find('td:eq(4)').text().trim(),
                department: $row.find('td:eq(5)').text().trim(),
                phone: $row.find('td:eq(6)').text().trim(),
                status: $row.find('td:eq(7)').text().trim(),
                dateJoined: $row.find('td:eq(8)').text().trim()
            });
        }
    });

    // Initialize DataTable with enhanced options
    usersTable = $('#usersTable').DataTable({
        "responsive": true,
        "lengthChange": true,
        "autoWidth": false,
        "searching": true,
        "paging": true,
        "pageLength": 25,
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        "info": true,
        "ordering": true,
        "order": [[1, "asc"]], // Sort by username
        "columnDefs": [
            { "orderable": false, "targets": [0, 9] }, // Disable sorting for # and Actions columns
            { "searchable": false, "targets": [0, 9] }, // Disable search for # and Actions columns
        ],
        "language": {
            "emptyTable": "No users found",
            "zeroRecords": "No matching users found",
            "search": "Search users:",
            "lengthMenu": "Show _MENU_ users per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ users",
            "infoEmpty": "No users available",
            "infoFiltered": "(filtered from _MAX_ total users)"
        },
        "drawCallback": function(settings) {
            updateUserCount();
        }
    });

    // Role filter functionality
    $('#roleFilter').on('change', function() {
        const selectedRole = $(this).val();
        filterTable();
        updateActiveRoleCard(selectedRole);
    });

    // Status filter functionality
    $('#statusFilter').on('change', function() {
        filterTable();
    });

    // Role card click filtering
    $('.role-filter-card').on('click', function() {
        const roleName = $(this).data('role');
        $('#roleFilter').val(roleName);
        filterTable();
        updateActiveRoleCard(roleName);
    });

    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Auto-hide alerts
    setTimeout(function() {
        $('.alert').fadeOut('slow');
    }, 5000);

    // Form validation setup
    setupFormValidation();
});

// Custom filter function
function filterTable() {
    const roleFilter = $('#roleFilter').val();
    const statusFilter = $('#statusFilter').val();
    
    // Clear existing search
    usersTable.search('').columns().search('').draw();
    
    // Apply role filter
    if (roleFilter) {
        usersTable.column(4).search(roleFilter, false, false);
    }
    
    // Apply status filter
    if (statusFilter) {
        usersTable.column(7).search(statusFilter, false, false);
    }
    
    usersTable.draw();
    updateUserCount();
}

// Update active role card highlighting
function updateActiveRoleCard(selectedRole) {
    $('.role-filter-card .info-box-icon').removeClass('bg-warning').addClass('bg-primary');
    if (selectedRole) {
        $(`.role-filter-card[data-role="${selectedRole}"] .info-box-icon`).removeClass('bg-primary').addClass('bg-warning');
    }
}

// Update user count display
function updateUserCount() {
    const info = usersTable.page.info();
    const displayed = info.recordsDisplay;
    const total = info.recordsTotal;
    $('#userCount').text(`Showing ${displayed} of ${total} users`);
}

// View user profile function
function viewUserProfile(userId) {
    currentUserId = userId;
    
    // Reset modal content
    $('#userProfileContent').html(`
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">Loading profile...</p>
        </div>
    `);
    
    $('#userProfileModal').modal('show');
    
    // Simulate loading user profile (replace with actual AJAX call)
    setTimeout(function() {
        const $row = $(`tr[data-user-id="${userId}"]`);
        const username = $row.find('td:eq(1)').text().trim();
        const fullName = $row.find('td:eq(2)').text().trim();
        const email = $row.find('td:eq(3) a').text() || $row.find('td:eq(3)').text().trim();
        const role = $row.find('td:eq(4) .badge').text().trim();
        const department = $row.find('td:eq(5)').text().trim();
        const phone = $row.find('td:eq(6) a').text() || $row.find('td:eq(6)').text().trim();
        const status = $row.find('td:eq(7) .badge').text().trim();
        const dateJoined = $row.find('td:eq(8)').text().trim();
        
        const profileHtml = `
            <div class="row">
                <div class="col-md-4 text-center">
                    <img src="/static/img/default-avatar.png" alt="User Photo" class="img-circle elevation-2" style="width: 120px; height: 120px;">
                    <h5 class="mt-2">${fullName || username}</h5>
                    <span class="badge badge-${status.toLowerCase().includes('active') ? 'success' : 'secondary'}">${status}</span>
                </div>
                <div class="col-md-8">
                    <table class="table table-borderless">
                        <tr><td><strong>Username:</strong></td><td>${username}</td></tr>
                        <tr><td><strong>Email:</strong></td><td>${email || 'Not provided'}</td></tr>
                        <tr><td><strong>Role:</strong></td><td>${role}</td></tr>
                        <tr><td><strong>Department:</strong></td><td>${department}</td></tr>
                        <tr><td><strong>Phone:</strong></td><td>${phone || 'Not provided'}</td></tr>
                        <tr><td><strong>Date Joined:</strong></td><td>${dateJoined}</td></tr>
                    </table>
                </div>
            </div>
        `;
        
        $('#userProfileContent').html(profileHtml);
    }, 1000);
}

// Edit user function
function editUser(userId) {
    currentUserId = userId;
    
    // Find user data from the table
    const $row = $(`tr[data-user-id="${userId}"]`);
    const username = $row.find('td:eq(1)').text().trim();
    const fullName = $row.find('td:eq(2)').text().replace(/\s+/g, ' ').trim();
    const email = $row.find('td:eq(3) a').text() || '';
    const role = $row.find('td:eq(4) .badge').text().trim();
    const phone = $row.find('td:eq(6) a').text() || '';
    const isActive = $row.find('td:eq(7) .badge-success').length > 0;
    
    // Split full name
    const nameParts = fullName.split(' ');
    const firstName = nameParts[0] || '';
    const lastName = nameParts.slice(1).join(' ') || '';
    
    // Populate form
    $('#editUsername').val(username);
    $('#editEmail').val(email);
    $('#editFirstName').val(firstName);
    $('#editLastName').val(lastName);
    $('#editRole').val(role === 'No Role' ? '' : role);
    $('#editPhone').val(phone);
    $('#editIsActive').prop('checked', isActive);
    
    $('#editUserModal').modal('show');
}

// In saveUserChanges() function
function saveUserChanges() {
    if (!validateEditForm()) {
        return;
    }

    const userId = currentUserId;
    const username = $('#editUsername').val();
    const email = $('#editEmail').val();
    const firstName = $('#editFirstName').val();
    const lastName = $('#editLastName').val();
    const role = $('#editRole').val();
    const phone = $('#editPhone').val();
    const isActive = $('#editIsActive').is(':checked');
    const csrfToken = $('input[name="csrfmiddlewaretoken"]').val(); // Get CSRF token

    $.ajax({
        url: `/admin/users/${userId}/edit/`, // Your Django URL for editing a user
        method: 'POST',
        data: {
            username: username,
            email: email,
            first_name: firstName,
            last_name: lastName,
            role: role,
            phone_number: phone, // Assuming your model uses phone_number
            is_active: isActive,
            csrfmiddlewaretoken: csrfToken
        },
        success: function(response) {
            if (response.success) { // Assuming your Django view sends a JSON response with success: true/false
                showAlert('success', 'User updated successfully!');
                $('#editUserModal').modal('hide');
                updateTableRow(); // Update UI after successful server update
            } else {
                showAlert('danger', response.message || 'Failed to update user.');
            }
        },
        error: function(xhr, status, error) {
            showAlert('danger', 'An error occurred while saving changes.');
            console.error('AJAX Error:', status, error);
        }
    });
}

// Add new user function
function addNewUser() {
    // Reset form
    $('#addUserForm')[0].reset();
    $('#addIsActive').prop('checked', true);
    $('#addUserModal').modal('show');
}

// Save new user
function saveNewUser() {
    if (!validateAddForm()) {
        return;
    }
    
    // Simulate saving (replace with actual AJAX call)
    showAlert('success', 'User created successfully!');
    $('#addUserModal').modal('hide');
    
    // Reload page or add new row to table
    setTimeout(() => location.reload(), 1500);
}

// Toggle user status
function toggleUserStatus(userId, username, isActive) {
    currentUserId = userId;
    const action = isActive ? 'disable' : 'enable';
    const message = `Are you sure you want to ${action} user "${username}"?`;
    
    $('#modalMessage').text(message);
    $('#statusToggleModal').modal('show');
    
    $('#confirmStatusToggle').off('click').on('click', function() {
        // Simulate status toggle (replace with actual AJAX call)
        showAlert('success', `User ${action}d successfully!`);
        $('#statusToggleModal').modal('hide');
        
        // Update the status in the table
        const $row = $(`tr[data-user-id="${userId}"]`);
        const $statusCell = $row.find('td:eq(7)');
        if (isActive) {
            $statusCell.html('<span class="badge badge-secondary"><i class="fas fa-times mr-1"></i>Inactive</span>');
        } else {
            $statusCell.html('<span class="badge badge-success"><i class="fas fa-check mr-1"></i>Active</span>');
        }
        
        // Update the action button
        const $actionBtn = $row.find('button[onclick*="toggleUserStatus"]');
        if (isActive) {
            $actionBtn.attr('onclick', $actionBtn.attr('onclick').replace('true', 'false'));
            $actionBtn.attr('title', 'Enable User');
            $actionBtn.html('<i class="fas fa-user-check"></i>');
        } else {
            $actionBtn.attr('onclick', $actionBtn.attr('onclick').replace('false', 'true'));
            $actionBtn.attr('title', 'Disable User');
            $actionBtn.html('<i class="fas fa-user-slash"></i>');
        }
    });
}

// Reset password function
function resetPassword(userId, username) {
    currentUserId = userId;
    $('#resetPasswordMessage').text(`Are you sure you want to reset the password for user "${username}"?`);
    $('#resetPasswordModal').modal('show');
    
    $('#confirmPasswordReset').off('click').on('click', function() {
        // Simulate password reset (replace with actual AJAX call)
        const newPassword = generateRandomPassword();
        showAlert('success', `Password reset successfully! New password: <strong>${newPassword}</strong>`);
        $('#resetPasswordModal').modal('hide');
    });
}

// Delete user function
function deleteUser(userId, username) {
    currentUserId = userId;
    $('#deleteUserMessage').text(`Are you sure you want to delete user "${username}"?`);
    $('#deleteUserModal').modal('show');
    
    $('#confirmUserDelete').off('click').on('click', function() {
        // Simulate user deletion (replace with actual AJAX call)
        showAlert('success', 'User deleted successfully!');
        $('#deleteUserModal').modal('hide');
        
        // Remove the row from table
        $(`tr[data-user-id="${userId}"]`).fadeOut(500, function() {
            $(this).remove();
            usersTable.draw();
        });
    });
}

// Export users function
function exportUsers() {
    const format = prompt('Choose export format:\n1. CSV\n2. Excel\n3. PDF\n\nEnter 1, 2, or 3:');
    
    let exportType = '';
    switch(format) {
        case '1':
            exportType = 'CSV';
            break;
        case '2':
            exportType = 'Excel';
            break;
        case '3':
            exportType = 'PDF';
            break;
        default:
            return;
    }
    
    showAlert('info', `Exporting users to ${exportType} format...`);
    // Simulate export (replace with actual export functionality)
}

// Print users function
function printUsers() {
    window.print();
}

// Update table row after edit
function updateTableRow() {
    const $row = $(`tr[data-user-id="${currentUserId}"]`);
    const username = $('#editUsername').val();
    const email = $('#editEmail').val();
    const firstName = $('#editFirstName').val();
    const lastName = $('#editLastName').val();
    const role = $('#editRole').val();
    const phone = $('#editPhone').val();
    const isActive = $('#editIsActive').is(':checked');
    
    // Update table cells
    $row.find('td:eq(1)').html(`<strong>${username}</strong>`);
    $row.find('td:eq(2)').text(`${firstName} ${lastName}`.trim());
    $row.find('td:eq(3)').html(email ? `<a href="mailto:${email}">${email}</a>` : '<span class="text-muted">Not provided</span>');
    $row.find('td:eq(4)').html(`<span class="badge badge-info">${role || 'No Role'}</span>`);
    $row.find('td:eq(6)').html(phone ? `<a href="tel:${phone}">${phone}</a>` : '<span class="text-muted">Not provided</span>');
    $row.find('td:eq(7)').html(isActive ? 
        '<span class="badge badge-success"><i class="fas fa-check mr-1"></i>Active</span>' : 
        '<span class="badge badge-secondary"><i class="fas fa-times mr-1"></i>Inactive</span>'
    );
}

// Form validation functions
function validateEditForm() {
    const username = $('#editUsername').val().trim();
    const email = $('#editEmail').val().trim();
    
    if (!username) {
        showAlert('warning', 'Username is required.');
        $('#editUsername').focus();
        return false;
    }
    
    if (email && !isValidEmail(email)) {
        showAlert('warning', 'Please enter a valid email address.');
        $('#editEmail').focus();
        return false;
    }
    
    return true;
}

function validateAddForm() {
    const username = $('#addUsername').val().trim();
    const password = $('#addPassword').val();
    const confirmPassword = $('#addConfirmPassword').val();
    const email = $('#addEmail').val().trim();
    const role = $('#addRole').val();
    
    if (!username) {
        showAlert('warning', 'Username is required.');
        $('#addUsername').focus();
        return false;
    }
    
    if (!password) {
        showAlert('warning', 'Password is required.');
        $('#addPassword').focus();
        return false;
    }
    
    if (password.length < 8) {
        showAlert('warning', 'Password must be at least 8 characters long.');
        $('#addPassword').focus();
        return false;
    }
    
    if (password !== confirmPassword) {
        showAlert('warning', 'Passwords do not match.');
        $('#addConfirmPassword').focus();
        return false;
    }
    
    if (!role) {
        showAlert('warning', 'Please select a role.');
        $('#addRole').focus();
        return false;
    }
    
    if (email && !isValidEmail(email)) {
        showAlert('warning', 'Please enter a valid email address.');
        $('#addEmail').focus();
        return false;
    }
    
    return true;
}

// Setup form validation
function setupFormValidation() {
    // Real-time validation for add user form
    $('#addConfirmPassword').on('keyup blur', function() {
        const password = $('#addPassword').val();
        const confirmPassword = $(this).val();
        
        if (confirmPassword && password !== confirmPassword) {
            $(this).addClass('is-invalid');
            $(this).siblings('.invalid-feedback').remove();
            $(this).after('<div class="invalid-feedback">Passwords do not match.</div>');
        } else {
            $(this).removeClass('is-invalid');
            $(this).siblings('.invalid-feedback').remove();
        }
    });
    
    // Username validation
    $('#addUsername, #editUsername').on('blur', function() {
        const username = $(this).val().trim();
        if (username && username.length < 3) {
            $(this).addClass('is-invalid');
            $(this).siblings('.invalid-feedback').remove();
            $(this).after('<div class="invalid-feedback">Username must be at least 3 characters long.</div>');
        } else {
            $(this).removeClass('is-invalid');
            $(this).siblings('.invalid-feedback').remove();
        }
    });
    
    // Email validation
    $('#addEmail, #editEmail').on('blur', function() {
        const email = $(this).val().trim();
        if (email && !isValidEmail(email)) {
            $(this).addClass('is-invalid');
            $(this).siblings('.invalid-feedback').remove();
            $(this).after('<div class="invalid-feedback">Please enter a valid email address.</div>');
        } else {
            $(this).removeClass('is-invalid');
            $(this).siblings('.invalid-feedback').remove();
        }
    });
}

// Utility functions
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    
    // Remove existing alerts
    $('.alert:not(.alert-permanent)').remove();
    
    // Add new alert at the top of content
    $('.content-header').after(alertHtml);
    
    // Auto-hide after 5 seconds
    setTimeout(function() {
        $('.alert:not(.alert-permanent)').fadeOut('slow');
    }, 5000);
}

// Generate random password
function generateRandomPassword() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    let password = '';
    for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

// Password strength indicator
function checkPasswordStrength(password) {
    let strength = 0;
    const checks = {
        length: password.length >= 8,
        lowercase: /[a-z]/.test(password),
        uppercase: /[A-Z]/.test(password),
        numbers: /\d/.test(password),
        symbols: /[^A-Za-z0-9]/.test(password)
    };
    
    strength = Object.values(checks).filter(Boolean).length;
    
    return {
        score: strength,
        checks: checks,
        text: strength < 2 ? 'Weak' : strength < 4 ? 'Medium' : 'Strong'
    };
}

// Add password strength indicator to add user form
$(document).on('keyup', '#addPassword', function() {
    const password = $(this).val();
    if (password) {
        const strength = checkPasswordStrength(password);
        const color = strength.score < 2 ? 'danger' : strength.score < 4 ? 'warning' : 'success';
        
        $(this).siblings('.password-strength').remove();
        $(this).after(`
            <div class="password-strength">
                <small class="text-${color}">
                    Password strength: ${strength.text}
                    ${strength.score < 3 ? '(Try adding uppercase, numbers, or symbols)' : ''}
                </small>
            </div>
        `);
    } else {
        $(this).siblings('.password-strength').remove();
    }
});
</script>
{% endblock %}