{% extends "accounts/base.html" %}

{% load humanize %}

{% block title %}HMS | Accounts Home{% endblock %}

{% block extra_css %}
<!-- Additional CSS for better styling -->
<style>
    .small-box {
        transition: all 0.3s ease;
    }
    .small-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .progress-group {
        margin-bottom: 15px;
    }
    #revenueChart, #paymentStatusChart {
        max-height: 300px;
    }
    .menu-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .menu-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .menu-card .card-body {
        padding: 2rem 1.5rem;
    }
    .menu-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    .stat-number {
        font-size: 1.8rem;
        font-weight: bold;
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Finance Dashboard</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        
        <!-- Dashboard Header Info -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-outline card-primary">
                    <div class="card-body py-3">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="mb-1"><i class="fas fa-heartbeat text-danger mr-2"></i>Fertility Clinic Financial System</h4>
                                <p class="text-muted mb-0">Comprehensive financial management and analytics</p>
                            </div>
                            <div class="col-md-4 text-right">
                                <p class="mb-1"><i class="far fa-calendar-alt mr-1"></i><span id="currentDate">Loading...</span></p>
                                <p class="mb-1"><i class="far fa-clock mr-1"></i><span id="currentTime" class="font-weight-bold">Loading...</span></p>
                                <p class="mb-0"><i class="fas fa-user-circle mr-1"></i>Welcome back, <strong class="text-capitalize">{{user.username}}</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Small boxes (Stat box) -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3 class="stat-number">₦{{ total_revenue|floatformat:0|intcomma }}</h3>
                        <p>Total Revenue</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <a href="{% url 'financial_reports' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3 class="stat-number">₦{{ monthly_income|floatformat:0|intcomma }}</h3>
                        <p>Monthly Income</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <a href="{% url 'patient_payment_tracker' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3 class="stat-number">₦{{ pending_payments|floatformat:0|intcomma }}</h3>
                        <p>Pending Payments ({{ pending_payments_count }})</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <a href="{% url 'patient_payment_tracker' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3 class="stat-number">₦{{ outstanding_balance|floatformat:0|intcomma }}</h3>
                        <p>Outstanding Balance</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <a href="{% url 'patient_payment_tracker' %}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
        </div>

        <!-- Charts and Quick Actions Row -->
        <div class="row mb-4">
            <!-- Revenue Chart -->
            <div class="col-lg-8 col-md-12 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-area mr-1"></i>
                            Revenue Trends (Last 6 Months)
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side Column -->
            <div class="col-lg-4 col-md-12">
                <!-- Payment Status Pie Chart -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie mr-1"></i>
                            Payment Status
                        </h3>
                    </div>
                    <div class="card-body p-3">
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="paymentStatusChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="border-right">
                                        <span class="text-success"><i class="fas fa-check-circle"></i></span>
                                        <h6 class="font-weight-bold text-success">{{ paid_count }}</h6>
                                        <small class="text-muted">Paid</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="border-right">
                                        <span class="text-warning"><i class="fas fa-clock"></i></span>
                                        <h6 class="font-weight-bold text-warning">{{ pending_count }}</h6>
                                        <small class="text-muted">Pending</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <span class="text-danger"><i class="fas fa-exclamation-triangle"></i></span>
                                    <h6 class="font-weight-bold text-danger">{{ overdue_count }}</h6>
                                    <small class="text-muted">Overdue</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bolt mr-1"></i>
                            Quick Actions
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm mb-2" onclick="location.href='{% url 'patient_payment_tracker' %}'">
                                <i class="fas fa-plus mr-1"></i>Record Payment
                            </button>
                            <button class="btn btn-outline-success btn-sm mb-2" onclick="location.href='{% url 'patient_payment_tracker' %}'">
                                <i class="fas fa-file-alt mr-1"></i>Generate Invoice
                            </button>
                            <button class="btn btn-outline-warning btn-sm mb-2" onclick="location.href='{% url 'financial_reports' %}'">
                                <i class="fas fa-download mr-1"></i>Export Report
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="location.href='{% url 'budget_planning' %}'">
                                <i class="fas fa-calculator mr-1"></i>Budget Calculator
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Modules -->
        <div class="row mb-4">
            <div class="col-12">
                <h4 class="mb-3"><i class="fas fa-th-large mr-2"></i>System Modules</h4>
            </div>
            <!-- Payments & Balances -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card menu-card card-outline card-success h-100" onclick="location.href='{% url 'patient_payment_tracker' %}'">
                    <div class="card-body text-center py-4">
                        <div class="menu-icon text-success">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <h5 class="card-title font-weight-bold">Payments & Balances</h5>
                        <p class="card-text text-muted">Track patient payments and balances</p>
                        <div class="mt-3">
                            <span class="badge badge-success px-3 py-2">
                                <i class="fas fa-arrow-right mr-1"></i>Access Module
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Income & Expenditure -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card menu-card card-outline card-warning h-100" onclick="location.href='{% url 'institution_financials' %}'">
                    <div class="card-body text-center py-4">
                        <div class="menu-icon text-warning">
                            <i class="fas fa-landmark"></i>
                        </div>
                        <h5 class="card-title font-weight-bold">Income & Expenditure</h5>
                        <p class="card-text text-muted">Manage institutional finances</p>
                        <div class="mt-3">
                            <span class="badge badge-warning px-3 py-2">
                                <i class="fas fa-arrow-right mr-1"></i>Access Module
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports & Summaries -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card menu-card card-outline card-primary h-100" onclick="location.href='{% url 'financial_reports' %}'">
                    <div class="card-body text-center py-4">
                        <div class="menu-icon text-primary">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h5 class="card-title font-weight-bold">Reports & Summaries</h5>
                        <p class="card-text text-muted">Generate financial reports</p>
                        <div class="mt-3">
                            <span class="badge badge-primary px-3 py-2">
                                <i class="fas fa-arrow-right mr-1"></i>Access Module
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Planning -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card menu-card card-outline card-info h-100" onclick="location.href='{% url 'budget_planning' %}'">
                    <div class="card-body text-center py-4">
                        <div class="menu-icon text-info">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <h5 class="card-title font-weight-bold">Budget Planning</h5>
                        <p class="card-text text-muted">Plan budgets and targets</p>
                        <div class="mt-3">
                            <span class="badge badge-info px-3 py-2">
                                <i class="fas fa-arrow-right mr-1"></i>Access Module
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section -->
        <div class="row">
            <!-- Recent Transactions -->
            <div class="col-lg-8 col-md-12 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-history mr-1"></i>
                            Recent Transactions
                        </h3>
                        <div class="card-tools">
                            <a href="{% url 'patient_payment_tracker' %}" class="btn btn-tool">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Patient</th>
                                    <th>Service</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentTransactions">
                                {% for transaction in recent_transactions %}
                                <tr>
                                    <td>{{ transaction.payment_date|date:"M d, Y" }}</td>
                                    <td>
                                        {% if transaction.patient.full_name %}
                                            {{ transaction.patient.full_name }}
                                        {% else %}
                                            {{ transaction.patient.username }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if transaction.service %}
                                            {{ transaction.service.name|default:"General Payment" }}
                                        {% else %}
                                            General Payment
                                        {% endif %}
                                    </td>
                                    <td class="{% if transaction.status == 'completed' %}text-success{% elif transaction.status == 'pending' %}text-warning{% else %}text-danger{% endif %}">
                                        ₦{{ transaction.amount|floatformat:0|intcomma }}
                                    </td>
                                    <td>
                                        {% if transaction.status == 'completed' %}
                                            <span class="badge badge-success">Paid</span>
                                        {% elif transaction.status == 'pending' %}
                                            <span class="badge badge-warning">Pending</span>
                                        {% elif transaction.status == 'failed' %}
                                            <span class="badge badge-danger">Failed</span>
                                        {% else %}
                                            <span class="badge badge-secondary">{{ transaction.status|title }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                        No recent transactions available
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if recent_transactions %}
                    <div class="card-footer">
                        <a href="{% url 'patient_payment_tracker' %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-list mr-1"></i>View All Transactions
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Right Side Bottom -->
            <div class="col-lg-4 col-md-12">
                <!-- Budget Overview -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-balance-scale mr-1"></i>
                            Monthly Budget Overview
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="progress-group">
                            <span class="progress-text">Revenue Target</span>
                            <span class="float-right"><b>₦{{ monthly_income|floatformat:0|intcomma }}</b>/₦{{ monthly_target|floatformat:0|intcomma|default:"500,000" }}</span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-success" style="width: {% widthratio monthly_income monthly_target|default:500000 100 %}%"></div>
                            </div>
                        </div>
                        <div class="progress-group">
                            <span class="progress-text">Operating Expenses</span>
                            <span class="float-right"><b>₦{{ monthly_expenses|floatformat:0|intcomma|default:"180,000" }}</b>/₦200,000</span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-warning" style="width: {% widthratio monthly_expenses|default:180000 200000 100 %}%"></div>
                            </div>
                        </div>
                        <div class="progress-group">
                            <span class="progress-text">Outstanding Payments</span>
                            <span class="float-right"><b>₦{{ outstanding_balance|floatformat:0|intcomma }}</b></span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-danger" style="width: {% if outstanding_balance > 0 %}75{% else %}0{% endif %}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="{% url 'budget_planning' %}" class="btn btn-sm btn-info">
                            <i class="fas fa-arrow-circle-right mr-1"></i>Plan Budget
                        </a>
                    </div>
                </div>

                <!-- Action Cards -->
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="card card-outline card-danger">
                            <div class="card-body text-center py-3">
                                <i class="fas fa-sign-out-alt fa-2x text-danger mb-2"></i>
                                <h6>End Session</h6>
                                <a href="{% url 'logout' %}" class="btn btn-danger btn-sm">
                                    <i class="fas fa-lock mr-1"></i>Logout
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="card card-outline card-info">
                            <div class="card-body text-center py-3">
                                <i class="fas fa-cog fa-2x text-info mb-2"></i>
                                <h6>Settings</h6>
                                <button class="btn btn-info btn-sm" onclick="alert('Settings page coming soon!')">
                                    <i class="fas fa-tools mr-1"></i>Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Pass Django data to JavaScript - ensuring data is available
const chartData = {
    revenueLabels: {{ revenue_labels|safe }},
    revenueIncome: {{ revenue_income|safe }},
    revenueExpenses: {{ revenue_expenses|safe }},
    paymentStatusLabels: {{ payment_status_labels|safe }},
    paymentStatusValues: {{ payment_status_values|safe }}
};

// Dashboard initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard initializing with data:', chartData);
    
    // Initialize date/time display
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // Initialize charts with delay to ensure Chart.js is loaded
    setTimeout(function() {
        initializeCharts();
    }, 500);

    // Initialize hover effects
    initializeHoverEffects();

    // Initialize number animations
    animateNumbers();
});

// Date and Time Update Function
function updateDateTime() {
    try {
        const now = new Date();
        
        // Update date
        const dateElement = document.getElementById('currentDate');
        if (dateElement) {
            dateElement.textContent = now.toLocaleDateString('en-GB', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        // Update time
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
            timeElement.textContent = now.toLocaleTimeString('en-GB', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }
    } catch (error) {
        console.error('Error updating date/time:', error);
    }
}

// Charts Initialization
function initializeCharts() {
    console.log('Initializing charts...');
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded. Please ensure Chart.js is included.');
        // Create fallback displays
        createFallbackCharts();
        return;
    }

    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx && chartData.revenueLabels && chartData.revenueIncome) {
        try {
            new Chart(revenueCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.revenueLabels,
                    datasets: [{
                        label: 'Revenue (₦)',
                        data: chartData.revenueIncome,
                        borderColor: '#17a2b8',
                        backgroundColor: 'rgba(23, 162, 184, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#17a2b8',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }, {
                        label: 'Expenses (₦)',
                        data: chartData.revenueExpenses,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#dc3545',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return '₦' + (value/1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '₦' + (value/1000).toFixed(0) + 'K';
                                    } else {
                                        return '₦' + value.toLocaleString();
                                    }
                                }
                            },
                            grid: {
                                borderColor: '#e9ecef',
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                borderColor: '#e9ecef',
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#fff',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ₦' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
            console.log('Revenue chart created successfully');
        } catch (error) {
            console.error('Error creating revenue chart:', error);
        }
    }

    // Payment Status Pie Chart
    const paymentCtx = document.getElementById('paymentStatusChart');
    if (paymentCtx && chartData.paymentStatusLabels && chartData.paymentStatusValues) {
        try {
            new Chart(paymentCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: chartData.paymentStatusLabels,
                    datasets: [{
                        data: chartData.paymentStatusValues,
                        backgroundColor: [
                            '#28a745',
                            '#ffc107',
                            '#dc3545'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverBorderWidth: 5,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#fff',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 2000
                    }
                }
            });
            console.log('Payment status chart created successfully');
        } catch (error) {
            console.error('Error creating payment status chart:', error);
        }
    }
}

// Fallback for when Chart.js is not available
function createFallbackCharts() {
    console.log('Creating fallback chart displays...');
    
    // Revenue chart fallback
    const revenueCanvas = document.getElementById('revenueChart');
    if (revenueCanvas) {
        const parent = revenueCanvas.parentElement;
        parent.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Chart Loading...</h5>
                <p class="text-muted">Please ensure Chart.js is properly loaded</p>
            </div>
        `;
    }
    
    // Payment status chart fallback
    const paymentCanvas = document.getElementById('paymentStatusChart');
    if (paymentCanvas) {
        const parent = paymentCanvas.parentElement;
        parent.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Chart Loading...</h5>
                <p class="text-muted">Please ensure Chart.js is properly loaded</p>
            </div>`;
    }
}

// Hover Effects for Cards
function initializeHoverEffects() {
    console.log('Initializing hover effects...');
    
    // Menu cards hover effects
    const menuCards = document.querySelectorAll('.menu-card');
    menuCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
            this.style.transition = 'all 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        });
    });
    
    // Small boxes hover effects
    const smallBoxes = document.querySelectorAll('.small-box');
    smallBoxes.forEach(box => {
        box.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
            this.style.transition = 'all 0.3s ease';
        });
        
        box.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        });
    });
}

// Number Animation
function animateNumbers() {
    console.log('Animating numbers...');
    
    const numberElements = document.querySelectorAll('.stat-number');
    
    numberElements.forEach(element => {
        const finalValue = element.textContent.replace(/[₦,]/g, '');
        const numericValue = parseInt(finalValue) || 0;
        
        if (numericValue > 0) {
            animateCounter(element, 0, numericValue, 2000);
        }
    });
}

// Counter Animation Function
function animateCounter(element, start, end, duration) {
    const startTime = performance.now();
    const originalText = element.textContent;
    
    function updateCounter(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function for smooth animation
        const easedProgress = 1 - Math.pow(1 - progress, 3);
        const currentValue = Math.floor(start + (end - start) * easedProgress);
        
        // Format the number with commas and currency symbol
        const formattedValue = '₦' + currentValue.toLocaleString();
        element.textContent = formattedValue;
        
        if (progress < 1) {
            requestAnimationFrame(updateCounter);
        } else {
            // Ensure final value is displayed correctly
            element.textContent = originalText;
        }
    }
    
    requestAnimationFrame(updateCounter);
}

// Utility Functions
function formatCurrency(amount) {
    return '₦' + parseFloat(amount).toLocaleString('en-NG', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
}

function formatNumber(number) {
    if (number >= 1000000) {
        return (number / 1000000).toFixed(1) + 'M';
    } else if (number >= 1000) {
        return (number / 1000).toFixed(0) + 'K';
    } else {
        return number.toLocaleString();
    }
}

// Refresh Dashboard Data
function refreshDashboard() {
    console.log('Refreshing dashboard data...');
    
    // Show loading indicator
    const refreshButton = document.querySelector('[data-refresh="dashboard"]');
    if (refreshButton) {
        refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        refreshButton.disabled = true;
    }
    
    // Simulate data refresh (replace with actual AJAX call if needed)
    setTimeout(() => {
        // Re-animate numbers
        animateNumbers();
        
        // Reset refresh button
        if (refreshButton) {
            refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            refreshButton.disabled = false;
        }
        
        // Show success message
        showNotification('Dashboard data refreshed successfully!', 'success');
    }, 2000);
}

// Notification System
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Quick Actions Functions
function recordPayment() {
    console.log('Redirecting to record payment...');
    window.location.href = '/accounts/payments/';
}

function generateInvoice() {
    console.log('Redirecting to generate invoice...');
    window.location.href = '/accounts/payments/';
}

function exportReport() {
    console.log('Redirecting to export reports...');
    window.location.href = '/accounts/reports/';
}

function budgetCalculator() {
    console.log('Redirecting to budget calculator...');
    window.location.href = '/accounts/budget/';
}

// Keyboard Shortcuts
document.addEventListener('keydown', function(event) {
    // Alt + R: Refresh Dashboard
    if (event.altKey && event.key === 'r') {
        event.preventDefault();
        refreshDashboard();
    }
    
    // Alt + P: Record Payment
    if (event.altKey && event.key === 'p') {
        event.preventDefault();
        recordPayment();
    }
    
    // Alt + I: Generate Invoice
    if (event.altKey && event.key === 'i') {
        event.preventDefault();
        generateInvoice();
    }
    
    // Alt + E: Export Report
    if (event.altKey && event.key === 'e') {
        event.preventDefault();
        exportReport();
    }
});

// Error Handling
window.addEventListener('error', function(event) {
    console.error('Dashboard error:', event.error);
    showNotification('An error occurred while loading the dashboard. Please refresh the page.', 'danger');
});

// Print Functionality
function printDashboard() {
    // Hide elements that shouldn't be printed
    const elementsToHide = document.querySelectorAll('.btn, .card-tools, .small-box-footer');
    elementsToHide.forEach(el => el.style.display = 'none');
    
    window.print();
    
    // Show elements again
    elementsToHide.forEach(el => el.style.display = '');
}

// Export Dashboard Data
function exportDashboardData() {
    const data = {
        totalRevenue: chartData.revenueIncome.reduce((a, b) => a + b, 0),
        monthlyIncome: chartData.revenueIncome[chartData.revenueIncome.length - 1],
        pendingPayments: document.querySelector('.bg-warning .stat-number').textContent,
        outstandingBalance: document.querySelector('.bg-danger .stat-number').textContent,
        exportDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `dashboard-data-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

// Responsive Chart Resize
window.addEventListener('resize', function() {
    // Charts will automatically resize due to responsive: true option
    console.log('Window resized, charts will auto-adjust');
});

// Page Visibility API - Pause/Resume when tab is not visible
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        console.log('Dashboard tab is now hidden');
        // You can pause real-time updates here if needed
    } else {
        console.log('Dashboard tab is now visible');
        // Resume updates and refresh time
        updateDateTime();
    }
});

// Initialize tooltips if Bootstrap is available
document.addEventListener('DOMContentLoaded', function() {
    if (typeof $ !== 'undefined' && $.fn.tooltip) {
        $('[data-toggle="tooltip"]').tooltip();
    }
});

// Console welcome message
console.log('%c🏥 HMS Finance Dashboard Loaded Successfully! 💰', 
    'color: #28a745; font-size: 16px; font-weight: bold;');
console.log('%cKeyboard Shortcuts:', 'color: #17a2b8; font-weight: bold;');
console.log('Alt + R: Refresh Dashboard');
console.log('Alt + P: Record Payment');
console.log('Alt + I: Generate Invoice');
console.log('Alt + E: Export Report');
</script>
{% endblock %}