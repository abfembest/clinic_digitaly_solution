{% extends "accounts/base.html" %}

{% block title %}HMS | Accounts Home{% endblock %}

{% block extra_css %}
<!-- Additional CSS for better styling -->
<style>
    .small-box {
        transition: all 0.3s ease;
    }
    .small-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .progress-group {
        margin-bottom: 15px;
    }
    #revenueChart, #paymentStatusChart {
        max-height: 300px;
    }
    .menu-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .menu-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .menu-card .card-body {
        padding: 2rem 1.5rem;
    }
    .menu-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Finance Dashboard</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        
        <!-- Dashboard Header Info -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card card-outline card-primary">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="mb-1"><i class="fas fa-heartbeat text-danger mr-2"></i>Fertility Clinic Financial System</h4>
                                <p class="text-muted mb-0">Comprehensive financial management and analytics</p>
                            </div>
                            <div class="col-md-4 text-right">
                                <p class="mb-1"><i class="far fa-calendar-alt mr-1"></i><span id="currentDate">Loading...</span></p>
                                <p class="mb-1"><i class="far fa-clock mr-1"></i><span id="currentTime" class="font-weight-bold">Loading...</span></p>
                                <p class="mb-0"><i class="fas fa-user-circle mr-1"></i>Welcome back, <strong class="text-capitalize">{{user.username}}</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Small boxes (Stat box) -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3 id="totalRevenue">₦2.5M</h3>
                        <p>Total Revenue</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3 id="monthlyIncome">₦480K</h3>
                        <p>Monthly Income</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3 id="pendingPayments">15</h3>
                        <p>Pending Payments</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3 id="outstandingBalance">₦125K</h3>
                        <p>Outstanding Balance</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <!-- Revenue Chart -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-area mr-1"></i>
                            Revenue Trends (Last 6 Months)
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 300px;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Status Pie Chart -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie mr-1"></i>
                            Payment Status
                        </h3>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; height: 300px;">
                            <canvas id="paymentStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Menu Cards Based on Sidebar -->
        <div class="row">
            <div class="col-12">
                <h4 class="mb-3"><i class="fas fa-th-large mr-2"></i>System Modules</h4>
            </div>
        </div>
        <div class="row" id="menuCards">
            <!-- Payments & Balances -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card menu-card card-outline card-success h-100" onclick="location.href='{% url 'patient_payment_tracker' %}'">
                    <div class="card-body text-center">
                        <div class="menu-icon text-success">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <h5 class="card-title font-weight-bold">Payments & Balances</h5>
                        <p class="card-text text-muted">Track patient payments, receipts, and outstanding balances</p>
                        <div class="mt-3">
                            <span class="badge badge-success px-3 py-2">
                                <i class="fas fa-arrow-right mr-1"></i>Access Module
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Income & Expenditure -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card menu-card card-outline card-warning h-100" onclick="location.href='{% url 'institution_financials' %}'">
                    <div class="card-body text-center">
                        <div class="menu-icon text-warning">
                            <i class="fas fa-landmark"></i>
                        </div>
                        <h5 class="card-title font-weight-bold">Income & Expenditure</h5>
                        <p class="card-text text-muted">Manage institutional inflows, expenses, and financial transactions</p>
                        <div class="mt-3">
                            <span class="badge badge-warning px-3 py-2">
                                <i class="fas fa-arrow-right mr-1"></i>Access Module
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports & Summaries -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card menu-card card-outline card-primary h-100" onclick="location.href='{% url 'financial_reports' %}'">
                    <div class="card-body text-center">
                        <div class="menu-icon text-primary">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h5 class="card-title font-weight-bold">Reports & Summaries</h5>
                        <p class="card-text text-muted">Generate financial reports, analytics, and performance summaries</p>
                        <div class="mt-3">
                            <span class="badge badge-primary px-3 py-2">
                                <i class="fas fa-arrow-right mr-1"></i>Access Module
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Planning -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card menu-card card-outline card-info h-100" onclick="location.href='{% url 'budget_planning' %}'">
                    <div class="card-body text-center">
                        <div class="menu-icon text-info">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <h5 class="card-title font-weight-bold">Budget Planning</h5>
                        <p class="card-text text-muted">Plan budgets, set financial targets, and monitor spending limits</p>
                        <div class="mt-3">
                            <span class="badge badge-info px-3 py-2">
                                <i class="fas fa-arrow-right mr-1"></i>Access Module
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity & Quick Actions Row -->
        <div class="row">
            <!-- Recent Transactions -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-history mr-1"></i>
                            Recent Transactions
                        </h3>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Patient</th>
                                    <th>Service</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentTransactions">
                                <tr>
                                    <td>2025-05-29</td>
                                    <td>Mrs. Johnson</td>
                                    <td>IVF Consultation</td>
                                    <td class="text-success">₦25,000</td>
                                    <td><span class="badge badge-success">Paid</span></td>
                                </tr>
                                <tr>
                                    <td>2025-05-28</td>
                                    <td>Ms. Adams</td>
                                    <td>Fertility Testing</td>
                                    <td class="text-warning">₦15,000</td>
                                    <td><span class="badge badge-warning">Pending</span></td>
                                </tr>
                                <tr>
                                    <td>2025-05-28</td>
                                    <td>Dr. Brown</td>
                                    <td>Hormone Therapy</td>
                                    <td class="text-success">₦35,000</td>
                                    <td><span class="badge badge-success">Paid</span></td>
                                </tr>
                                <tr>
                                    <td>2025-05-27</td>
                                    <td>Mrs. Wilson</td>
                                    <td>Ultrasound Scan</td>
                                    <td class="text-danger">₦8,000</td>
                                    <td><span class="badge badge-danger">Overdue</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quick Actions & Budget -->
            <div class="col-md-4">
                <!-- Quick Actions -->
                <div class="card card-secondary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bolt mr-1"></i>
                            Quick Actions
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm mb-2" onclick="location.href='{% url 'patient_payment_tracker' %}'">
                                <i class="fas fa-plus mr-1"></i>Record Payment
                            </button>
                            <button class="btn btn-outline-success btn-sm mb-2" onclick="location.href='{% url 'patient_payment_tracker' %}'">
                                <i class="fas fa-file-alt mr-1"></i>Generate Invoice
                            </button>
                            <button class="btn btn-outline-warning btn-sm mb-2" onclick="location.href='{% url 'financial_reports' %}'">
                                <i class="fas fa-download mr-1"></i>Export Report
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="location.href='{% url 'budget_planning' %}'">
                                <i class="fas fa-calculator mr-1"></i>Budget Calculator
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Budget Overview -->
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-balance-scale mr-1"></i>
                            Monthly Budget
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="progress-group">
                            <span class="progress-text">Revenue Target</span>
                            <span class="float-right"><b>₦480K</b>/₦500K</span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-success" style="width: 96%"></div>
                            </div>
                        </div>
                        <div class="progress-group">
                            <span class="progress-text">Operating Expenses</span>
                            <span class="float-right"><b>₦180K</b>/₦200K</span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-warning" style="width: 90%"></div>
                            </div>
                        </div>
                        <div class="progress-group">
                            <span class="progress-text">Equipment Budget</span>
                            <span class="float-right"><b>₦45K</b>/₦100K</span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-info" style="width: 45%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="{% url 'budget_planning' %}" class="btn btn-sm btn-info">
                            <i class="fas fa-arrow-circle-right mr-1"></i>Plan Budget
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Action Cards -->
        <div class="row">
            <div class="col-md-6">
                <div class="card card-outline card-danger">
                    <div class="card-body text-center">
                        <i class="fas fa-sign-out-alt fa-3x text-danger mb-3"></i>
                        <h5>End Session</h5>
                        <p class="text-muted">Securely logout and end your current session</p>
                        <a href="{% url 'logout' %}" class="btn btn-danger">
                            <i class="fas fa-lock mr-1"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card card-outline card-info">
                    <div class="card-body text-center">
                        <i class="fas fa-cog fa-3x text-info mb-3"></i>
                        <h5>System Settings</h5>
                        <p class="text-muted">Configure system preferences and user settings</p>
                        <button class="btn btn-info">
                            <i class="fas fa-tools mr-1"></i>Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Ensure DOM is ready and all scripts are loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing dashboard...');
    
    // Function to update date and time
    function updateDateTime() {
        try {
            var now = new Date();
            
            // Update date
            var dateElement = document.getElementById('currentDate');
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('en-GB', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            // Update time
            var timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
            }
        } catch (error) {
            console.error('Error updating date/time:', error);
        }
    }
    
    // Update immediately
    updateDateTime();
    
    // Update every second
    setInterval(updateDateTime, 1000);

    // Initialize charts after a small delay to ensure everything is loaded
    setTimeout(function() {
        initializeCharts();
    }, 500);

    // Initialize hover effects
    initializeHoverEffects();
});

function initializeCharts() {
    console.log('Initializing charts...');
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded. Please ensure Chart.js is included in your static files.');
        return;
    }

    // Revenue Chart
    var revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
        try {
            var revenueChart = new Chart(revenueCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['December', 'January', 'February', 'March', 'April', 'May'],
                    datasets: [{
                        label: 'Revenue (₦)',
                        data: [350000, 420000, 380000, 450000, 480000, 520000],
                        borderColor: '#3c8dbc',
                        backgroundColor: 'rgba(60, 141, 188, 0.1)',
                        tension: 0.1,
                        fill: true,
                        pointBackgroundColor: '#3c8dbc',
                        pointBorderColor: '#3c8dbc',
                        pointRadius: 4
                    }, {
                        label: 'Expenses (₦)',
                        data: [180000, 200000, 185000, 195000, 210000, 205000],
                        borderColor: '#f56954',
                        backgroundColor: 'rgba(245, 105, 84, 0.1)',
                        tension: 0.1,
                        fill: true,
                        pointBackgroundColor: '#f56954',
                        pointBorderColor: '#f56954',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₦' + (value/1000) + 'K';
                                }
                            },
                            grid: {
                                borderColor: '#e9ecef',
                                color: '#f8f9fa'
                            }
                        },
                        x: {
                            grid: {
                                borderColor: '#e9ecef',
                                color: '#f8f9fa'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#fff',
                            borderWidth: 1,
                            cornerRadius: 6,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ₦' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            console.log('Revenue chart initialized successfully');
        } catch (error) {
            console.error('Error creating revenue chart:', error);
        }
    } else {
        console.error('Revenue chart canvas not found');
    }

    // Payment Status Pie Chart
    var paymentCtx = document.getElementById('paymentStatusChart');
    if (paymentCtx) {
        try {
            var paymentChart = new Chart(paymentCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Paid', 'Pending', 'Overdue'],
                    datasets: [{
                        data: [65, 25, 10],
                        backgroundColor: [
                            '#28a745',
                            '#ffc107',
                            '#dc3545'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverBorderWidth: 4,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#fff',
                            borderWidth: 1,
                            cornerRadius: 6,
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000
                    }
                }
            });
            console.log('Payment status chart initialized successfully');
        } catch (error) {
            console.error('Error creating payment status chart:', error);
        }
    } else {
        console.error('Payment status chart canvas not found');
    }
}

function initializeHoverEffects() {
    // Animate stat boxes on hover
    var smallBoxes = document.querySelectorAll('.small-box');
    smallBoxes.forEach(function(box) {
        box.addEventListener('mouseenter', function() {
            this.classList.add('elevation-3');
        });
        
        box.addEventListener('mouseleave', function() {
            this.classList.remove('elevation-3');
        });
    });

    // Animate menu cards on hover
    var menuCards = document.querySelectorAll('.menu-card');
    menuCards.forEach(function(card) {
        card.addEventListener('mouseenter', function() {
            this.classList.add('elevation-4');
        });
        
        card.addEventListener('mouseleave', function() {
            this.classList.remove('elevation-4');
        });
    });
    
    console.log('Hover effects initialized for', smallBoxes.length, 'small boxes and', menuCards.length, 'menu cards');
}

// Fallback for jQuery if it's available
if (typeof $ !== 'undefined') {
    $(document).ready(function() {
        console.log('jQuery available, adding additional enhancements...');
        
        // Additional jQuery-based enhancements
        $('.small-box').hover(
            function() {
                $(this).addClass('elevation-3');
            },
            function() {
                $(this).removeClass('elevation-3');
            }
        );

        $('.menu-card').hover(
            function() {
                $(this).addClass('elevation-4');
            },
            function() {
                $(this).removeClass('elevation-4');
            }
        );
    });
}
</script>
{% endblock %}