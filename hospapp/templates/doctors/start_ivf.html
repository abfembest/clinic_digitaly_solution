{% extends "doctors/base.html" %}

{% load static %}

{% block title %}Doctors | IVF Treatment Form{% endblock %}

{%block content%}

{%include "doctors/doctors.css"%}


<div class="ivf-form-container mt-5">
    <div class="card shadow">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-heartbeat"></i>
                IVF Treatment Form
            </h5>
            <i class="fas fa-baby form-icon"></i>
        </div>
        <div class="card-body">
            <!-- Custom Success/Error Message Box -->
            <div id="customAlertModal" class="custom-modal">
                <div class="custom-modal-content">
                    <div class="modal-icon" id="modalIcon"></div>
                    <h3 class="modal-title" id="modalTitle"></h3>
                    <p class="modal-message" id="modalMessage"></p>
                    <button class="modal-close-btn" id="modalCloseBtn">OK</button>
                </div>
            </div>

            <form id="ivfForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="patient_name" class="form-label">
                            <i class="fas fa-user"></i> Patient Name
                        </label>
                        <select id="patient_name" class="form-select select2" required>
                            <option value="">Select patient</option>
                            {% for patient in patients %}
                            <option value="{{ patient.id }}">{{ patient.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="ivf_package" class="form-label">
                            <i class="fas fa-box"></i> IVF Package
                        </label>
                        <select id="ivf_package" class="form-select select2" required>
                            <option value="">Choose a package</option>
                            {% for package in packages %}
                            <option value="{{ package.id }}">{{ package.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="treatment_location" class="form-label">
                            <i class="fas fa-map-marker-alt"></i> Treatment Location
                        </label>
                        <select id="treatment_location" class="form-select select2" required>
                            <option value="">Select location</option>
                            {% for location in locations %}
                            <option value="{{ location.id }}">{{ location.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="doctor_name" class="form-label">
                            <i class="fas fa-user-md"></i> Doctor's Name
                        </label>
                        <input type="text" class="form-select" id="doctor_name" value="{{ request.user.get_full_name }}"
                            readonly />
                    </div>
                </div>

                <div class="form-group">
                    <label for="doctor_comments" class="form-label">
                        <i class="fas fa-comments"></i> Doctor's Comments
                    </label>
                    <textarea id="doctor_comments" class="form-control" rows="3"
                        placeholder="Enter any additional comments or special instructions..."></textarea>
                </div>

                <button type="submit" class="btn-submit">
                    <i class="fas fa-paper-plane"></i> Submit Treatment Form
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Table for Pending IVF Cycles -->
<div class="ivf-table-container mt-5">
    <div class="card shadow">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list-alt"></i>
                Pending IVF Cycles
            </h5>
        </div>
        <div class="card-body">
            {% if ivf_records %}
            <div class="table-responsive">
                <table class="ivf-table">
                    <thead>
                        <tr>
                            <th>Patient</th>
                            <th>IVF Package</th>
                            <th>Location</th>
                            <th>Doctor</th>
                            <th>Comments</th>
                            <th>Status</th>
                            <th>Created On</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in ivf_records %}
                        <tr id="ivf-record-{{ record.id }}">
                            <td>{{ record.patient.full_name }}</td>
                            <td>{{ record.ivf_package.name }}</td>
                            <td>{{ record.treatment_location.name }}</td>
                            <td>{{ record.doctor_name }}</td>
                            <td>{{ record.doctor_comments|default:"N/A" }}</td>
                            <td>
                                <span class="status-badge status-{{ record.status|lower }}">
                                    {{ record.status|capfirst }}
                                </span>
                            </td>
                            <td>{{ record.created_on|date:"M d, Y H:i" }}</td>
                            <td>
                                {% if record.status == 'open' or record.status == 'pending' %}
                                <button class="action-btn btn-start" data-id="{{ record.id }}"
                                    data-action="in_progress">
                                    <i class="fas fa-play"></i> Start Cycle
                                </button>
                                <button class="action-btn btn-cancel" data-id="{{ record.id }}" data-action="cancelled">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                {% elif record.status == 'in_progress' %}
                                <button class="action-btn btn-complete" data-id="{{ record.id }}"
                                    data-action="completed">
                                    <i class="fas fa-check"></i> Complete Cycle
                                </button>
                                <button class="action-btn btn-cancel" data-id="{{ record.id }}" data-action="cancelled">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                {% else %}
                                <span class="text-muted">No actions</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted">No pending IVF cycles found.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        $('.select2').select2({
            width: '100%', // Ensures full-width appearance
            placeholder: 'Select an option',
        });

        // Function to show custom modal
        function showCustomModal(type, title, message) {
            const modal = $('#customAlertModal');
            const icon = $('#modalIcon');
            const modalTitle = $('#modalTitle');
            const modalMessage = $('#modalMessage');

            // Reset classes
            modal.removeClass('modal-success modal-error');
            icon.removeClass('fa-check-circle fa-times-circle');

            if (type === 'success') {
                modal.addClass('modal-success');
                icon.addClass('fas fa-check-circle');
            } else if (type === 'error') {
                modal.addClass('modal-error');
                icon.addClass('fas fa-times-circle');
            }

            modalTitle.text(title);
            modalMessage.text(message);
            modal.css('display', 'flex'); // Show the modal
        }

        // Close custom modal
        $('#modalCloseBtn').on('click', function () {
            $('#customAlertModal').css('display', 'none'); // Hide the modal
        });

        // Handle form submission
        $('#ivfForm').on('submit', function (e) {
            e.preventDefault();

            const payload = {
                patient_name: $('#patient_name').val(),
                ivf_package: $('#ivf_package').val(),
                treatment_location: $('#treatment_location').val(),
                doctor_name: $('#doctor_name').val(),
                doctor_comments: $('#doctor_comments').val(),
            };

            $.ajax({
                url: '{% url "start_ivf" %}', // Using named URL
                type: 'POST',
                data: JSON.stringify(payload),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function (response) {
                    if (response.success) {
                        showCustomModal('success', 'Success!', 'Form submitted successfully!');
                        $('#ivfForm')[0].reset();
                        $('.select2').val(null).trigger('change');
                        location.reload(); // Simple reload to refresh the table
                    } else {
                        showCustomModal('error', 'Error!', 'Error submitting form: ' + response.error);
                    }
                },
                error: function (xhr) {
                    showCustomModal('error', 'Error!', 'An error occurred: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Please try again.'));
                }
            });
        });

        // Handle action button clicks for IVF records
        $(document).on('click', '.action-btn', function () {
            const recordId = $(this).data('id');
            const action = $(this).data('action'); // e.g., 'in_progress', 'completed', 'cancelled'

            $.ajax({
                url: '{% url "update_ivf_status" %}', // Using named URL
                type: 'POST',
                data: JSON.stringify({
                    record_id: recordId,
                    new_status: action
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function (response) {
                    if (response.success) {
                        showCustomModal('success', 'Success!', response.message);
                        location.reload(); // Reload the page to reflect the status change
                    } else {
                        showCustomModal('error', 'Error!', 'Failed to update status: ' + response.error);
                    }
                },
                error: function (xhr) {
                    showCustomModal('error', 'Error!', 'An error occurred: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Please try again.'));
                }
            });
        });

        // CSRF token function for AJAX
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + '=') {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });

</script>

{%endblock%}