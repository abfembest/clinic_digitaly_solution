{% extends "doctors/base.html" %}
{% load static %}

{% block title %}HMS | Doctor Activity Report{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">
                    <i class="fas fa-user-md text-primary mr-2"></i>
                    My Doctor Activity Dashboard
                </h1>
                <p class="text-muted mb-0">Comprehensive overview of your medical activities from {{ start_date }} to {{ end_date }}</p>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'doctors' %}">Home</a></li>
                    <li class="breadcrumb-item active">Doctor Activity Report</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <form method="GET" class="form-inline">
                            <div class="form-group mr-3">
                                <label for="start_date" class="mr-2">From:</label>
                                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
                            </div>
                            <div class="form-group mr-3">
                                <label for="end_date" class="mr-2">To:</label>
                                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Filter
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-2 col-md-4 col-sm-6 col-12">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ summary_stats.total_consultations }}</h3>
                        <p>Total Consultations</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-stethoscope"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-12">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ summary_stats.total_prescriptions }}</h3>
                        <p>Prescriptions</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-prescription"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-12">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ summary_stats.total_admissions_assigned }}</h3>
                        <p>Admissions Assigned</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-hospital-user"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-12">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ summary_stats.total_discharges }}</h3>
                        <p>Discharges</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-12">
                <div class="small-box bg-primary">
                    <div class="inner">
                        <h3>{{ summary_stats.total_referrals }}</h3>
                        <p>Referrals</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-share"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 col-12">
                <div class="small-box bg-secondary">
                    <div class="inner">
                        <h3>{{ summary_stats.current_active_patients }}</h3>
                        <p>Active Patients</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-injured"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Patient Status Breakdown</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="patientStatusChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Activities (Last 7 Days)</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="recentActivitiesChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid py-4">
            <div class="advanced-table-container">
                <div class="advanced-table-header">
                    <h2><i class="bi bi-table"></i> Complete Activity Management Dashboard</h2>
                    <p class="text-muted mb-0">All your medical activities in one comprehensive view with advanced filtering</p>
                </div>

                <div class="advanced-table-controls">
                    <div class="advanced-search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search all activities...">
                    </div>
                    <div class="d-flex gap-2">
                        <select id="activityFilter" class="form-control mr-2" style="width: auto;">
                            <option value="">All Activities</option>
                            <option value="consultation">Consultations</option>
                            <option value="prescription">Prescriptions</option>
                            <option value="admission">Admissions</option>
                            <option value="referral">Referrals</option>
                            <option value="lab_test">Lab Tests</option>
                            <option value="care_plan">Care Plans</option>
                            <option value="comment">Comments</option>
                        </select>
                        <button class="advanced-btn" id="printTable">
                            <i class="bi bi-printer me-1"></i>Print
                        </button>
                        <button class="advanced-btn" id="exportPDF">
                            <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                        </button>
                    </div>
                </div>

                <div class="advanced-table-wrapper">
                    <table class="table advanced-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">Date <i class="bi bi-arrow-down-up ms-1"></i></th>
                                <th onclick="sortTable(1)">Patient <i class="bi bi-arrow-down-up ms-1"></i></th>
                                <th onclick="sortTable(2)">Activity Type <i class="bi bi-arrow-down-up ms-1"></i></th>
                                <th onclick="sortTable(3)">Details <i class="bi bi-arrow-down-up ms-1"></i></th>
                                <th onclick="sortTable(4)">Status <i class="bi bi-arrow-down-up ms-1"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                    <div id="noResults" class="no-results" style="display: none;">
                        <i class="bi bi-search fs-1 text-muted"></i>
                        <h4>No results found</h4>
                        <p>Try adjusting your search criteria</p>
                    </div>
                </div>

                <div class="advanced-pagination" id="pagination">
                    <button id="prevBtn">← Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button id="nextBtn">Next →</button>
                </div>
            </div>
        </div>

    </div>
</section>

{% endblock %}

{% block extra_js %}
<script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>

<style>
    .advanced-table-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 0.75rem;
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        margin: 0.75rem 0;
    }

    .advanced-table-header {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    }

    .advanced-table-header h2 {
        color: #2d3748;
        font-weight: 700;
        margin-bottom: 0.2rem;
        font-size: 1.3rem;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .advanced-table-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .advanced-search-box {
        position: relative;
        flex: 1;
        min-width: 150px;
        max-width: 300px;
    }

    .advanced-search-box input {
        border: 1px solid #e2e8f0;
        border-radius: 18px;
        padding: 6px 12px 6px 30px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(5px);
    }

    .advanced-search-box input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: white;
    }

    .advanced-search-box i {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        z-index: 2;
        font-size: 0.8rem;
    }

    .advanced-table-wrapper {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .advanced-table {
        margin-bottom: 0;
        border: none;
    }

    .advanced-table thead th {
        background: linear-gradient(135deg, #4a5568, #2d3748);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        padding: 0.6rem;
        border: none;
        position: relative;
        cursor: pointer;
        transition: background 0.3s ease;
        font-size: 0.75rem;
    }

    .advanced-table thead th:hover {
        background: linear-gradient(135deg, #2d3748, #1a202c);
    }

    .advanced-table thead th::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .advanced-table tbody tr {
        transition: all 0.3s ease;
        border: none;
    }

    .advanced-table tbody tr:nth-child(even) {
        background: rgba(248, 250, 252, 0.8);
    }

    .advanced-table tbody tr:hover {
        background: linear-gradient(90deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .advanced-table tbody td {
        padding: 0.6rem;
        border: none;
        vertical-align: middle;
        font-weight: 500;
        color: #2d3748;
        font-size: 0.85rem;
    }

    .advanced-status-badge {
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-active { background: linear-gradient(135deg, #48bb78, #38a169); color: white; }
    .status-inactive { background: linear-gradient(135deg, #f56565, #e53e3e); color: white; }
    .status-pending { background: linear-gradient(135deg, #ed8936, #dd6b20); color: white; }
    .status-completed { background: linear-gradient(135deg, #48bb78, #38a169); color: white; }
    .status-cancelled { background: linear-gradient(135deg, #f56565, #e53e3e); color: white; }

    .advanced-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        border-radius: 16px;
        padding: 6px 14px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        font-size: 0.8rem;
    }

    .advanced-btn:hover {
        background: linear-gradient(135deg, #5a67d8, #6b46c1);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .advanced-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
        padding: 0.6rem;
        background: rgba(255,255,255,0.8);
        backdrop-filter: blur(5px);
        border-radius: 8px;
    }

    .advanced-pagination button {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        color: white;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .advanced-pagination button:hover:not(:disabled) {
        background: linear-gradient(135deg, #5a67d8, #6b46c1);
        transform: translateY(-1px);
    }

    .advanced-pagination button:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
        transform: none;
    }

    .advanced-pagination span {
        color: #4a5568;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .no-results {
        text-align: center;
        padding: 1.5rem;
        color: #64748b;
        font-style: italic;
    }

    @media print {
        .advanced-table-container { background: white !important; box-shadow: none !important; padding: 0 !important; margin: 0 !important; }
        .advanced-table-header, .advanced-table-controls, .advanced-pagination { display: none !important; }
        .advanced-table-wrapper { background: white !important; box-shadow: none !important; border-radius: 0 !important; }
        .advanced-table thead th { background: #4a5568 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .advanced-table tbody tr:hover { background: transparent !important; transform: none !important; box-shadow: none !important; }
    }

    @media (max-width: 768px) {
        .advanced-table-container { padding: 0.75rem; margin: 0.75rem 0; }
        .advanced-table-header { padding: 0.75rem; }
        .advanced-table-controls { flex-direction: column; align-items: stretch; gap: 0.5rem; }
        .advanced-search-box { min-width: auto; width: 100%; }
        .advanced-table-wrapper { overflow-x: auto; }
        .advanced-table { min-width: 600px; }
        .advanced-pagination { flex-wrap: wrap; gap: 0.4rem; }
    }
</style>

<script>
    $(function () {
        // Charts code remains the same
        var patientStatusCanvas = $('#patientStatusChart').get(0).getContext('2d');
        var patientStatusData = {
            labels: [{% for entry in patient_status_stats %}'{{ entry.status|title }}',{% endfor %}],
            datasets: [{
                data: [{% for entry in patient_status_stats %}{{ entry.count }},{% endfor %}],
                backgroundColor: ['#007bff', '#dc3545', '#28a745', '#ffc107', '#6c757d', '#17a2b8'],
            }]
        }
        new Chart(patientStatusCanvas, { type: 'doughnut', data: patientStatusData, options: { maintainAspectRatio: false, responsive: true, plugins: { legend: { position: 'bottom' }}}});

        var recentActivitiesCanvas = $('#recentActivitiesChart').get(0).getContext('2d');
        var recentActivitiesData = {
            labels: ['Consultations', 'Prescriptions', 'Admissions', 'Referrals'],
            datasets: [{
                label: 'Last 7 Days',
                data: [{{ recent_activities.consultations }}, {{ recent_activities.prescriptions }}, {{ recent_activities.admissions }}, {{ recent_activities.referrals }}],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'],
                borderColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'],
                borderWidth: 1
            }]
        }
        new Chart(recentActivitiesCanvas, { type: 'bar', data: recentActivitiesData, options: { maintainAspectRatio: false, responsive: true, plugins: { legend: { display: false }}, scales: { y: { beginAtZero: true, ticks: { precision: 0 }}}}});

        // Consolidated activities data
        const allActivitiesData = [
            // Consultations
            {% for consultation in consultations %}
            { date: "{{ consultation.created_at|date:"d F Y" }}", patient: "{{ consultation.patient.full_name|escapejs }}", type: "consultation", details: "{{ consultation.reason_for_consultation|truncatechars:50|escapejs }}", status: "{{ consultation.status|default:'Completed'|escapejs }}", rawDate: new Date("{{ consultation.created_at|date:'c' }}") },
            {% endfor %}
            // Prescriptions
            {% for prescription in prescriptions %}
            { date: "{{ prescription.created_at|date:"d F Y" }}", patient: "{{ prescription.patient.full_name|escapejs }}", type: "prescription", details: "{{ prescription.medication|truncatechars:50|escapejs }}", status: "{{ prescription.status|default:'Active'|escapejs }}", rawDate: new Date("{{ prescription.created_at|date:'c' }}") },
            {% endfor %}
            // Admissions
            {% for admission in admissions_assigned %}
            { date: "{{ admission.admission_date|date:"d F Y" }}", patient: "{{ admission.patient.full_name|escapejs }}", type: "admission", details: "Admitted by {{ admission.admitted_by.get_full_name|escapejs }}", status: "{{ admission.status|escapejs }}", rawDate: new Date("{{ admission.admission_date|date:'c' }}") },
            {% endfor %}
            // Referrals
            {% for referral in referrals %}
            { date: "{{ referral.created_at|date:"d F Y" }}", patient: "{{ referral.patient.full_name|escapejs }}", type: "referral", details: "To {{ referral.department.name|escapejs }}", status: "{{ referral.status|escapejs }}", rawDate: new Date("{{ referral.created_at|date:'c' }}") },
            {% endfor %}
            // Lab Tests
            {% for test in lab_tests %}
            { date: "{{ test.requested_at|date:"d F Y" }}", patient: "{{ test.patient.full_name|escapejs }}", type: "lab_test", details: "{{ test.category.name|escapejs }}", status: "{{ test.status|escapejs }}", rawDate: new Date("{{ test.requested_at|date:'c' }}") },
            {% endfor %}
            // Care Plans
            {% for plan in care_plans %}
            { date: "{{ plan.created_at|date:"d F Y" }}", patient: "{{ plan.patient.full_name|escapejs }}", type: "care_plan", details: "{{ plan.title|truncatechars:50|escapejs }}", status: "{{ plan.status|escapejs }}", rawDate: new Date("{{ plan.created_at|date:'c' }}") },
            {% endfor %}
            // Comments
            {% for comment in doctor_comments %}
            { date: "{{ comment.date|date:"d F Y" }}", patient: "{{ comment.patient.full_name|default:'N/A'|escapejs }}", type: "comment", details: "{{ comment.comments|truncatechars:50|escapejs }}", status: "Active", rawDate: new Date("{{ comment.date|date:'c' }}") },
            {% endfor %}
        ];

        // Sort by date (newest first)
        allActivitiesData.sort((a, b) => b.rawDate - a.rawDate);

        let filteredData = [...allActivitiesData];
        let currentPage = 1;
        const rowsPerPage = 15;
        let sortDirection = {};

        function getActivityIcon(type) {
            const icons = {
                consultation: 'fas fa-stethoscope',
                prescription: 'fas fa-prescription',
                admission: 'fas fa-hospital-user',
                referral: 'fas fa-share',
                lab_test: 'fas fa-flask',
                care_plan: 'fas fa-clipboard-list',
                comment: 'fas fa-comment-medical'
            };
            return icons[type] || 'fas fa-file-medical';
        }

        function getActivityColor(type) {
            const colors = {
                consultation: 'info',
                prescription: 'success',
                admission: 'warning',
                referral: 'primary',
                lab_test: 'info',
                care_plan: 'success',
                comment: 'secondary'
            };
            return colors[type] || 'light';
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            const noResults = document.getElementById('noResults');

            if (filteredData.length === 0) {
                tableBody.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            tableBody.innerHTML = pageData.map(item => {
                let statusClass = 'status-active';
                const status = item.status.toLowerCase();
                if (status.includes('completed') || status.includes('active')) statusClass = 'status-completed';
                else if (status.includes('pending') || status.includes('waiting')) statusClass = 'status-pending';
                else if (status.includes('cancelled') || status.includes('inactive')) statusClass = 'status-cancelled';

                return `
                    <tr>
                        <td><strong>${item.date}</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 28px; height: 28px; font-size: 0.75rem;">
                                    <span class="text-white fw-bold">${item.patient.charAt(0)}</span>
                                </div>
                                <strong style="font-size: 0.85rem;">${item.patient}</strong>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-${getActivityColor(item.type)} me-1">
                                <i class="${getActivityIcon(item.type)} me-1"></i>${item.type.replace('_', ' ').toUpperCase()}
                            </span>
                        </td>
                        <td>${item.details}</td>
                        <td><span class="advanced-status-badge ${statusClass}">${item.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        }

        function searchAndFilter() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activityFilter = document.getElementById('activityFilter').value;
            
            filteredData = allActivitiesData.filter(item => {
                const matchesSearch = Object.values(item).some(value => 
                    value.toString().toLowerCase().includes(searchTerm)
                );
                const matchesFilter = !activityFilter || item.type === activityFilter;
                return matchesSearch && matchesFilter;
            });
            
            currentPage = 1;
            renderTable();
        }

        function sortTable(columnIndex) {
            const columns = ['rawDate', 'patient', 'type', 'details', 'status'];
            const column = columns[columnIndex];
            sortDirection[column] = sortDirection[column] === 'asc' ? 'desc' : 'asc';

            filteredData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                if (column === 'rawDate') {
                    return sortDirection[column] === 'asc' ? aVal - bVal : bVal - aVal;
                }
                return sortDirection[column] === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
            });

            renderTable();
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', searchAndFilter);
        document.getElementById('activityFilter').addEventListener('change', searchAndFilter);
        document.getElementById('prevBtn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderTable(); }});
        document.getElementById('nextBtn').addEventListener('click', () => { const totalPages = Math.ceil(filteredData.length / rowsPerPage); if (currentPage < totalPages) { currentPage++; renderTable(); }});
        document.getElementById('printTable').addEventListener('click', () => window.print());

        renderTable();
    });
</script>
{% endblock %}