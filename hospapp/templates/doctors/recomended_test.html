{% extends "doctors/base.html" %}
{% load static %}

{% block title %}HMS | Test administration{% endblock %}

{% block content %}
<!-- Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">IVF Test Administrations</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="">Laboratory</a></li>
                    <li class="breadcrumb-item active">Test Entry</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Success/Error Messages -->
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show"
             role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
        {% endif %}
    </div>
    <!-- Statistics Cards -->
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

            .stats-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: var(--card-color);
                border-radius: 20px 20px 0 0;
            }

            .stats-card:hover {
                transform: translateY(-8px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            }

            .stats-card.info {
                --card-color: linear-gradient(135deg, #667eea, #764ba2);
            }

            .stats-card.warning {
                --card-color: linear-gradient(135deg, #f093fb, #f5576c);
            }

            .stats-card.success {
                --card-color: linear-gradient(135deg, #4facfe, #00f2fe);
            }

            .stats-card.secondary {
                --card-color: linear-gradient(135deg, #43e97b, #38f9d7);
            }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--card-color);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            line-height: 1;
        }

        .stats-label {
            color: #6c757d;
            font-size: 0.95rem;
            font-weight: 500;
            margin: 0.5rem 0 0 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card-color);
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-body {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .container-custom {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .row {
            --bs-gutter-x: 1rem;
        }

        @media (max-width: 768px) {
            .stats-number {
                font-size: 2rem;
            }

            .stats-icon {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .stats-card {
                padding: 1.2rem;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }
    </style>
    
        <div class="container-custom">
            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-lg-3 col-md-6 col-12">
                    <div class="stats-card info">
                        <div class="stats-header">
                            <div class="stats-body">                            
                                <h3 class="stats-number">{{ stats.total_patients }}</h3>
                                <p class="stats-label">Total Patients</p>
                            </div>
                            <div class="stats-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 col-12">
                    <div class="stats-card warning pulse">
                        <div class="stats-header">
                            <div class="stats-body">
                                {%if stats.total_pending_tests%}
                                <h3 class="stats-number">{{ stats.total_pending_tests }}</h3>
                                {%else%}
                                <h3>0</h3>
                                {%endif%}

                                <p class="stats-label">Pending Tests</p>
                            </div>
                            <div class="stats-icon">
                                <i class="fas fa-file-medical"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 col-12">
                    <div class="stats-card success">
                        <div class="stats-header">
                            <div class="stats-body">
                                {%if stats.total_completed_today%}
                                <h3 class="stats-number">{{ stats.total_completed_today }}</h3>
                                {%else%}
                                <h3>0</h3>
                                {%endif%}
                                <p class="stats-label">Completed Today</p>
                            </div>
                            <div class="stats-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 col-12">
                    <div class="stats-card secondary">
                        <div class="stats-header">
                            <div class="stats-body">
                                {%if stats.total_completed_today%}
                                <h3 class="stats-number">{{ stats.total_in_progress}}</h3>
                                {%else%}
                                <h3>0</h3>
                                {%endif%}
                                <p class="stats-label">In Progress</p>
                            </div>
                            <div class="stats-icon">
                                <i class="fas fa-flask"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</section>



<!-- Patient Records Table -->
<section class="content">
    <div class="container-fluid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Patient records</h3>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
                <table id="example1" class="table table-bordered table-hover text-nowrap mb-0">
                    <thead class="thead-light">
                        <tr>
                            <th>Patient ID</th>
                            <th>Patient Info</th>
                            <th>Contact</th>
                            <th>Categories</th>
                            <th>Test Summary</th>
                            <th>Recommended By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in unique_patients_with_tests %}
                        <tr data-patient-name="{{ entry.patient.full_name|lower }}">
                            <td>
                                <span class="badge badge-secondary">{{ entry.patient.id }}</span>
                            </td>
                            <td>
                                <div>
                                    <strong>{{ entry.patient.full_name }}</strong><br>
                                    <small class="text-muted">
                                        {{ entry.patient.gender }} â€¢
                                        {{ entry.patient.date_of_birth|date:"M d, Y" }} â€¢
                                        {{ entry.patient.blood_group|default:"N/A" }}
                                    </small>
                                    {% if entry.patient.is_inpatient %}
                                    <br><span class="badge badge-info">Inpatient</span>
                                    {% if entry.patient.ward %}
                                    <small class="text-muted">{{ entry.patient.ward.name }}</small>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <small>
                                    <i class="fas fa-phone"></i> {{ entry.patient.phone|default:"N/A" }}<br>
                                    <i class="fas fa-map-marker-alt"></i> {{ entry.patient.address|truncatechars:30|default:"N/A" }}
                                </small>
                            </td>

                            <td>
                                {% for category in entry.categories %}
                                <div class="d-flex flex-column">
                                    <span class="badge badge-outline mb-1">{{ category }}</span>
                                    {% endfor %}
                                </div>
                            </td>
                            <td>
                                {% for test in entry.tests %}
                                <div class="d-flex flex-column">
                                    <span class="badge badge-warning mb-1">{{ test.test_name }}</span>
                                </div>
                                {% endfor %}
                            </td>
                            <td>
                                <small class="text-muted">{{ entry.requested_by }}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'test_results' entry.patient.id %}" class="btn btn-primary" title="View test details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-success create-test"
                                            data-patient-id="{{ entry.patient.id }}"
                                            data-patient-name="{{ entry.patient.full_name }}"
                                            title="Create New Test">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    
                                    <button class="btn btn-warning complete-test-direct"
                                            data-test-id="{{ test.id }}"
                                            data-test-name="{{ test.test_name }}"
                                            data-patient-name="{{ entry.patient.full_name }}"
                                            title="Complete Test">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                                    <br>
                                    No patients with lab tests found
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>


                </table>


            </div>

            <!-- /.card-body -->
        </div>
        <!-- /.card -->
    </div>
    <!-- /.container-fluid -->
</section>
<!-- /.content -->
{% endblock %}

<!-- Scripts -->
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // CSRF Token setup
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Patient Search Filter
        const searchInput = document.getElementById('patientSearch');
        const tableBody = document.getElementById('patientsTableBody');

        searchInput.addEventListener('input', function () {
            const filter = this.value.toLowerCase();
            Array.from(tableBody.querySelectorAll('tr')).forEach(row => {
                const patientName = row.getAttribute('data-patient-name') || '';
                row.style.display = patientName.includes(filter) ? '' : 'none';
            });
        });

        // Modal references
        const testModal = $('#patientTestsModal');
        const createModal = $('#createTestModal');
        const completeModal = $('#completeTestModal');

        let currentPatientId = null;

        // Function to fetch patient tests via AJAX
        function fetchPatientTests(patientId) {
            currentPatientId = patientId;

            // Show loading, hide content
            document.getElementById('loading').style.display = 'block';
            document.getElementById('patientInfoSection').style.display = 'none';
            document.getElementById('pendingTestsContainer').style.display = 'none';
            document.getElementById('inProgressTestsContainer').style.display = 'none';
            document.getElementById('completedTestsContainer').style.display = 'none';

            fetch(`/laboratory/patient_tests/${patientId}/`, {
                headers: {
                    'X-CSRFToken': csrftoken,
                }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    // Update patient info section
                    const patientInfo = document.getElementById('patientInfo');
                    patientInfo.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <strong>Name:</strong> ${data.patient.full_name}<br>
                        <strong>ID:</strong> ${data.patient.id}<br>
                        <strong>Gender:</strong> ${data.patient.gender}
                    </div>
                    <div class="col-md-4">
                        <strong>DOB:</strong> ${data.patient.date_of_birth}<br>
                        <strong>Blood Group:</strong> ${data.patient.blood_group}<br>
                        <strong>Phone:</strong> ${data.patient.phone || 'N/A'}
                    </div>
                    <div class="col-md-4">
                        <strong>Status:</strong> <span class="badge badge-${data.patient.status === 'critical' ? 'danger' : data.patient.status === 'stable' ? 'success' : 'warning'}">${data.patient.status}</span><br>
                        <strong>Address:</strong> ${data.patient.address || 'N/A'}<br>
                        ${data.patient.is_inpatient ? `<strong>Ward:</strong> ${data.patient.ward || 'N/A'}` : ''}
                    </div>
                </div>
            `;
                    document.getElementById('patientInfoSection').style.display = 'block';

                    // Update pending tests
                    const pendingTestsBody = document.getElementById('pendingTestsBody');
                    if (data.pending_tests && data.pending_tests.length > 0) {
                        pendingTestsBody.innerHTML = data.pending_tests.map(test => `
                    <tr>
                        <td>${test.test_name}</td>
                        <td>${test.category || 'N/A'}</td>
                        <td>${test.requested_by || 'N/A'}</td>
                        <td>${test.requested_at}</td>
                        <td><span class="badge badge-warning">Pending</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning complete-test-btn" data-test-id="${test.id}" data-test-name="${test.test_name}">
                                <i class="fas fa-check"></i> Complete
                            </button>
                            <button class="btn btn-sm btn-info view-test-btn" data-test-id="${test.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `).join('');
                        document.getElementById('pendingTestsContainer').style.display = 'block';
                    }

                    // Update in progress tests
                    const inProgressTestsBody = document.getElementById('inProgressTestsBody');
                    if (data.in_progress_tests && data.in_progress_tests.length > 0) {
                        inProgressTestsBody.innerHTML = data.in_progress_tests.map(test => `
                    <tr>
                        <td>${test.test_name}</td>
                        <td>${test.category || 'N/A'}</td>
                        <td>${test.started_by || 'N/A'}</td>
                        <td>${test.started_at}</td>
                        <td><span class="badge badge-info">In Progress</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning complete-test-btn" data-test-id="${test.id}" data-test-name="${test.test_name}">
                                <i class="fas fa-check"></i> Complete
                            </button>
                            <button class="btn btn-sm btn-info view-test-btn" data-test-id="${test.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `).join('');
                        document.getElementById('inProgressTestsContainer').style.display = 'block';
                    }

                    // Update completed tests
                    const completedTestsBody = document.getElementById('completedTestsBody');
                    if (data.completed_tests && data.completed_tests.length > 0) {
                        completedTestsBody.innerHTML = data.completed_tests.map(test => `
                    <tr>
                        <td>${test.test_name}</td>
                        <td>${test.category || 'N/A'}</td>
                        <td>${test.completed_by || 'N/A'}</td>
                        <td>${test.completed_at}</td>
                        <td>${test.result_value ? test.result_value.substring(0, 50) + '...' : 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-success view-test-btn" data-test-id="${test.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-primary print-test-btn" data-test-id="${test.id}">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </td>
                    </tr>
                `).join('');
                        document.getElementById('completedTestsContainer').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching patient tests:', error);
                    document.getElementById('loading').style.display = 'none';
                    alert('Error loading patient data. Please try again.');
                });
        }

        // View Tests Button Click Handler
        document.addEventListener('click', function (e) {
            if (e.target.closest('.view-tests')) {
                const btn = e.target.closest('.view-tests');
                const patientId = btn.getAttribute('data-patient-id');
                const patientName = btn.getAttribute('data-patient-name');

                document.getElementById('patientName').textContent = patientName;
                fetchPatientTests(patientId);
                testModal.modal('show');
            }
        });

        // Create Test Button Click Handler
        document.addEventListener('click', function (e) {
            if (e.target.closest('.create-test')) {
                const btn = e.target.closest('.create-test');
                const patientId = btn.getAttribute('data-patient-id');
                const patientName = btn.getAttribute('data-patient-name');

                document.getElementById('createTestPatientId').value = patientId;
                document.getElementById('createTestPatientName').value = patientName;
                createModal.modal('show');
            }
        });

        // Create Test from Modal Button
        document.getElementById('createTestBtn').addEventListener('click', function () {
            if (currentPatientId) {
                const patientName = document.getElementById('patientName').textContent;
                document.getElementById('createTestPatientId').value = currentPatientId;
                document.getElementById('createTestPatientName').value = patientName;
                testModal.modal('hide');
                createModal.modal('show');
            }
        });

        // Complete Test Button Click Handler
        document.addEventListener('click', function (e) {
            if (e.target.closest('.complete-test-btn') || e.target.closest('.complete-test-direct')) {
                const btn = e.target.closest('.complete-test-btn') || e.target.closest('.complete-test-direct');
                const testId = btn.getAttribute('data-test-id');
                const testName = btn.getAttribute('data-test-name');

                document.getElementById('completeTestId').value = testId;
                document.getElementById('completeTestName').value = testName;
                completeModal.modal('show');
            }
        });

        // Quick Complete Button Click Handler
        document.addEventListener('click', function (e) {
            if (e.target.closest('.quick-complete')) {
                const btn = e.target.closest('.quick-complete');
                const patientId = btn.getAttribute('data-patient-id');
                const patientName = btn.getAttribute('data-patient-name');

                if (confirm(`Complete all pending tests for ${patientName}?`)) {
                    fetch(`/laboratory/quick_complete_tests/${patientId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json',
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            } else {
                                alert('Error completing tests: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error completing tests. Please try again.');
                        });
                }
            }
        });

        // Create Test Form Submit Handler
        document.getElementById('createTestForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            fetch('/laboratory/create_test/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        createModal.modal('hide');
                        this.reset();

                        // Refresh the patient tests modal if open
                        if (currentPatientId) {
                            fetchPatientTests(currentPatientId);
                        } else {
                            location.reload();
                        }

                        // Show success message
                        showAlert('Test created successfully!', 'success');
                    } else {
                        alert('Error creating test: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error creating test. Please try again.');
                });
        });

        // Complete Test Form Submit Handler
        document.getElementById('completeTestForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            fetch('/laboratory/complete_test/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        completeModal.modal('hide');
                        this.reset();

                        // Refresh the patient tests modal if open
                        if (currentPatientId) {
                            fetchPatientTests(currentPatientId);
                        } else {
                            location.reload();
                        }

                        showAlert('Test completed successfully!', 'success');
                    } else {
                        alert('Error completing test: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error completing test. Please try again.');
                });
        });

        // View Test Details Handler
        document.addEventListener('click', function (e) {
            if (e.target.closest('.view-test-btn')) {
                const btn = e.target.closest('.view-test-btn');
                const testId = btn.getAttribute('data-test-id');

                fetch(`/laboratory/test_details/${testId}/`, {
                    headers: {
                        'X-CSRFToken': csrftoken,
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showTestDetailsModal(data.test);
                        } else {
                            alert('Error loading test details');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error loading test details');
                    });
            }
        });

        // Print Test Handler
        document.addEventListener('click', function (e) {
            if (e.target.closest('.print-test-btn')) {
                const btn = e.target.closest('.print-test-btn');
                const testId = btn.getAttribute('data-test-id');

                window.open(`/laboratory/print_test/${testId}/`, '_blank');
            }
        });

        // Utility function to show alerts
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;

            const container = document.querySelector('.container-fluid');
            const firstChild = container.firstChild;
            container.insertBefore(alertDiv, firstChild);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Function to show test details in a modal
        function showTestDetailsModal(test) {
            const modalContent = `
            <div class="modal fade" id="testDetailsModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-info">
                            <h5 class="modal-title text-white">
                                <i class="fas fa-flask"></i> Test Details
                            </h5>
                            <button type="button" class="close text-white" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Test Name:</strong> ${test.test_name}<br>
                                    <strong>Category:</strong> ${test.category || 'N/A'}<br>
                                    <strong>Patient:</strong> ${test.patient_name}<br>
                                    <strong>Status:</strong> <span class="badge badge-${test.status === 'completed' ? 'success' : test.status === 'in_progress' ? 'info' : 'warning'}">${test.status}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Requested:</strong> ${test.requested_at}<br>
                                    <strong>Requested By:</strong> ${test.requested_by || 'N/A'}<br>
                                    ${test.completed_at ? `<strong>Completed:</strong> ${test.completed_at}<br>` : ''}
                                    ${test.completed_by ? `<strong>Completed By:</strong> ${test.completed_by}<br>` : ''}
                                </div>
                            </div>
                            ${test.normal_range ? `<hr><strong>Normal Range:</strong> ${test.normal_range}` : ''}
                            ${test.result_value ? `<hr><strong>Result:</strong><br><div class="border p-2 bg-light">${test.result_value}</div>` : ''}
                            ${test.notes ? `<hr><strong>Notes:</strong><br><div class="border p-2 bg-light">${test.notes}</div>` : ''}
                            ${test.instructions ? `<hr><strong>Instructions:</strong><br><div class="border p-2 bg-light">${test.instructions}</div>` : ''}
                        </div>
                        <div class="modal-footer">
                            ${test.status === 'completed' ? `<button type="button" class="btn btn-primary" onclick="window.open('/laboratory/print_test/${test.id}/', '_blank')"><i class="fas fa-print"></i> Print</button>` : ''}
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Remove existing modal if any
            const existingModal = document.getElementById('testDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add new modal to body
            document.body.insertAdjacentHTML('beforeend', modalContent);
            $('#testDetailsModal').modal('show');

            // Remove modal from DOM when hidden
            $('#testDetailsModal').on('hidden.bs.modal', function () {
                this.remove();
            });
        }

        // Clear form fields when modals are hidden
        createModal.on('hidden.bs.modal', function () {
            document.getElementById('createTestForm').reset();
        });

        completeModal.on('hidden.bs.modal', function () {
            document.getElementById('completeTestForm').reset();
        });

        // Auto-refresh page every 5 minutes to keep data current
        setInterval(function () {
            if (!testModal.hasClass('show') && !createModal.hasClass('show') && !completeModal.hasClass('show')) {
                location.reload();
            }
        }, 300000); // 5 minutes

        // Initialize tooltips
        $('[data-toggle="tooltip"]').tooltip();

        // Initialize any additional Bootstrap components
        $('.alert').alert();
    });
</script>
{% endblock %}