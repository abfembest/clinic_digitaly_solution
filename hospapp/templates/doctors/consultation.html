{% extends "doctors/base.html" %}

{% load static %}

{% block title %}Doctors | Patient Consultation{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <h1 class="m-0 text-dark">Patient Consultation</h1>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="card card-primary card-outline">
            <div class="card-header p-2">
                <ul class="nav nav-pills" id="doctorTabs">
                    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#diagnosis">Diagnosis</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#prescription">Prescription</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#consultation">Consultation
                            Notes</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tests">Request Tests</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#plan">Care Plan</a></li>
                </ul>
            </div>

            <div class="card-body">
                <div class="tab-content">

                    <!-- Diagnosis Tab -->
                    <div class="tab-pane fade show active" id="diagnosis">
                        <form method="POST" action="{% url 'save_consultation' %}">
                            {% csrf_token %}

                            <!-- Patient Selector -->
                            <div class="form-group">
                                <label>Select Patient</label>
                                <select class="form-control" name="patient_id" id="patient-select" required>
                                    <option value="" disabled selected>-- Choose Patient --</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}">{{ patient.full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Patient History Display (populated via AJAX) -->
                            <div id="patient-history" class="border rounded p-3 bg-light mb-3" style="display: none;">
                                <strong>Patient Medical History</strong>
                                <div id="history-content" class="mt-2 text-muted small">
                                    <!-- AJAX-loaded content -->
                                </div>
                            </div>

                            <!-- Diagnosis Summary -->
                            <div class="form-group">
                                <label>Diagnosis Summary</label>
                                <textarea class="form-control" name="diagnosis_summary" rows="3" required
                                    placeholder="Enter diagnosis details..."></textarea>
                            </div>

                            <!-- Doctor Advice -->
                            <div class="form-group">
                                <label>Doctor's Advice</label>
                                <textarea class="form-control" name="advice" rows="3" required
                                    placeholder="Advice or recommendations..."></textarea>
                            </div>

                            <div class="form-group text-center">
                                <button type="submit" class="btn btn-primary">Save Diagnosis</button>
                            </div>
                        </form>
                    </div>


                    <!-- Prescription Tab -->
                    <div class="tab-pane fade" id="prescription">
                        <form method="POST" action="{% url 'add_prescription' %}">
                            {% csrf_token %}

                            <!-- Patient Selector -->
                            <div class="form-group">
                                <label>Select Patient</label>
                                <select name="patient_id" class="form-control" required>
                                    <option value="" disabled selected>-- Choose Patient --</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}">{{ patient.full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Patient History Display (populated via AJAX) -->
                            <div id="patient-history" class="border rounded p-3 bg-light mb-3" style="display: none;">
                                <strong>Patient Medical History</strong>
                                <div id="history-content" class="mt-2 text-muted small">
                                    <!-- AJAX-loaded content -->
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Medication Name</label>
                                <input type="text" name="medication" class="form-control" placeholder="e.g., Metformin"
                                    required>
                            </div>

                            <div class="form-group">
                                <label>Dosage & Instructions</label>
                                <textarea name="instructions" class="form-control" rows="2"
                                    placeholder="e.g., 500mg twice daily after meals" required></textarea>
                            </div>

                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="date" name="start_date" class="form-control" required>
                            </div>

                            <div class="form-group text-center">
                                <button type="submit" class="btn btn-success">Add Prescription</button>
                            </div>
                        </form>
                    </div>


                    <div class="tab-pane fade" id="consultation">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="patient_id" value="{{ patient.id }}">
                            <div class="form-group">
                                <label>Consultation Notes</label>
                                <textarea class="form-control" name="notes" rows="5"
                                    placeholder="Enter symptoms, observations, complaints..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-secondary">Save Notes</button>
                        </form>
                    </div>


                    <!-- Request Tests Tab -->
                    <div class="tab-pane fade" id="tests">
                        <form>
                            <div class="form-group">
                                <label>Select Tests to Request</label>
                                <select multiple class="form-control">
                                    <option>Fertility Hormone Panel</option>
                                    <option>Ultrasound Scan</option>
                                    <option>Blood Count</option>
                                    <option>Thyroid Function Test</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Additional Instructions</label>
                                <textarea class="form-control" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-warning">Request Tests</button>
                        </form>
                    </div>

                    <!-- Care Plan Tab -->
                    <div class="tab-pane fade" id="plan">
                        <form>
                            <div class="form-group">
                                <label>Clinical Findings</label>
                                <textarea class="form-control" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Plan of Care</label>
                                <textarea class="form-control" rows="3"
                                    placeholder="Next steps, referrals, follow-up..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-info">Save Care Plan</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const patientSelect = document.getElementById('patient-select');
        const historyContainer = document.getElementById('patient-history');
        const historyContent = document.getElementById('history-content');

        // Get base URL from Django template
        const baseUrl = "{% url 'patient_history_ajax' 0 %}".replace('/0/', '/');  // remove dummy 0

        patientSelect.addEventListener('change', function () {
            const patientId = this.value;

            if (patientId) {
                fetch(`${baseUrl}${patientId}/`)
                    .then(response => response.text())
                    .then(data => {
                        historyContent.innerHTML = data;
                        historyContainer.style.display = 'block';
                    })
                    .catch(error => {
                        historyContent.innerHTML = "<p class='text-danger'>Failed to load history.</p>";
                        historyContainer.style.display = 'block';
                    });
            } else {
                historyContainer.style.display = 'none';
            }
        });
    });
</script>

{% endblock %}