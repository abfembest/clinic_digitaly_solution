{% extends "doctors/base.html" %}

{% load static %}

{% block title %}Doctors | Patient Consultation{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <h1 class="m-0 text-dark">Patient Consultation</h1>
    </div>
</div>

<style>
    :root {
        --medical-primary: #2c5aa0;
        --medical-secondary: #4a90e2;
        --medical-success: #28a745;
        --medical-info: #17a2b8;
        --medical-light: #f8f9fa;
        --medical-accent: #e8f2ff;
    }

    .medical-consultation-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 0.75rem 0;
    }

        .medical-consultation-container .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }

            .medical-consultation-container .card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.12);
            }

        .medical-consultation-container .card-header {
            background: linear-gradient(135deg, var(--medical-primary), var(--medical-secondary));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1rem 1.5rem;
            border: none;
        }

            .medical-consultation-container .card-header h3 {
                margin: 0;
                font-size: 1.1rem;
                font-weight: 600;
                display: flex;
                align-items: center;
            }

                .medical-consultation-container .card-header h3:before {
                    content: '\f0f8';
                    font-family: 'Font Awesome 6 Free';
                    font-weight: 900;
                    margin-right: 0.5rem;
                    opacity: 0.8;
                }

        .medical-consultation-container .card-body {
            padding: 1.5rem;
        }

        .medical-consultation-container .form-group {
            margin-bottom: 0.8rem;
        }

            .medical-consultation-container .form-group label {
                font-weight: 600;
                color: var(--medical-primary);
                margin-bottom: 0.3rem;
                font-size: 0.8rem;
            }

        .medical-consultation-container .form-control {
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 0.5rem 0.6rem;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

            .medical-consultation-container .form-control:focus {
                border-color: var(--medical-secondary);
                box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
                transform: translateY(-1px);
            }

        .medical-consultation-container .nav-pills .nav-link {
            border-radius: 25px;
            margin-right: 0.5rem;
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: var(--medical-accent);
            color: var(--medical-primary);
            border: 2px solid transparent;
        }

            .medical-consultation-container .nav-pills .nav-link:hover {
                background: var(--medical-secondary);
                color: white;
                transform: translateY(-1px);
            }

            .medical-consultation-container .nav-pills .nav-link.active {
                background: linear-gradient(135deg, var(--medical-primary), var(--medical-secondary));
                color: white;
                box-shadow: 0 4px 15px rgba(44, 90, 160, 0.3);
            }

        .medical-consultation-container .btn {
            border-radius: 25px;
            padding: 0.7rem 2rem;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

            .medical-consultation-container .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            }

        .medical-consultation-container .btn-primary {
            background: linear-gradient(135deg, var(--medical-primary), var(--medical-secondary));
        }

        .medical-consultation-container .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .medical-consultation-container .btn-info {
            background: linear-gradient(135deg, #17a2b8, #20c997);
        }

        .medical-consultation-container .tab-content {
            padding-top: 1rem;
        }

        .medical-consultation-container .tab-pane {
            animation: fadeIn 0.5s ease-in;
        }

        .medical-consultation-container textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .medical-consultation-container #patient-history {
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.05), rgba(255,255,255,0.95));
        }

            .medical-consultation-container #patient-history .card-header {
                background: linear-gradient(135deg, var(--medical-info), #20c997);
            }

        .medical-consultation-container .patient-select-card {
            background: linear-gradient(135deg, rgba(44, 90, 160, 0.05), rgba(255,255,255,0.95));
        }

        .medical-consultation-container .form-control[list] {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }

        .medical-consultation-container .medical-icon {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
            opacity: 0.8;
        }

        .medical-consultation-container .compact-form .form-group {
            margin-bottom: 1rem;
        }

        .medical-consultation-container .compact-form .form-control {
            padding: 0.6rem 0.75rem;
        }

        .medical-consultation-container .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--medical-secondary), transparent);
            margin: 1.5rem 0;
        }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 768px) {
        .medical-consultation-container .card-body {
            padding: 0.75rem;
        }

        .medical-consultation-container .btn {
            padding: 0.4rem 1rem;
            font-size: 0.7rem;
        }

        .medical-consultation-container .nav-pills .nav-link {
            padding: 0.35rem 0.7rem;
            font-size: 0.7rem;
        }
    }
</style>
<div class="medical-consultation-container">
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                {# Start of the main row for two-column layout #}

                <div class="col-lg-4 col-md-5">
                    {# Column for Patient Selection and History #}
                    <div class="card card-primary card-outline mb-3">
                        <div class="card-header">
                            <h3 class="card-title">Select Patient for Consultation</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="main-patient-select">Patient Name</label>
                                <select class="form-control select2" id="main-patient-select" required>
                                    <option value="">Select a patient</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}" data-full-name="{{ patient.full_name }}">{{ patient.full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="patient-history" class="card card-info card-outline mb-3" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title">Patient Medical History (<span id="history-patient-name"></span>)</h3>
                        </div>
                        <div class="card-body" id="history-content">
                        </div>
                    </div>
                </div> {# End of col-lg-4 #}

                <div class="col-lg-8 col-md-7">
                    {# Column for Tabs #}
                    <div class="card card-primary card-outline">
                        <div class="card-header p-2">
                            <ul class="nav nav-pills" id="doctorTabs">
                                <li class="nav-item">
                                    <a class="nav-link active" data-toggle="tab" href="#diagnosis">
                                        Consultation &
                                        Diagnosis
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-toggle="tab" href="#prescription">Prescription</a>
                                </li>
                                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#plan">Care Plan</a></li>
                            </ul>
                        </div>

                        <div class="card-body">
                            <div class="tab-content">

                                <div class="tab-pane fade show active" id="diagnosis">
                                    <form method="POST" action="{% url 'save_consultation' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="patient_id" id="diagnosis-patient-id" required>

                                        <div class="form-group">
                                            <label>Symptoms / Complaints</label>
                                            <textarea class="form-control" name="symptoms" rows="3" required
                                                      placeholder="Enter patient symptoms and complaints..."></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label>Diagnosis Summary</label>
                                            <textarea class="form-control" name="diagnosis_summary" rows="3" required
                                                      placeholder="Enter diagnosis details..."></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label>Doctor's Advice & Notes</label>
                                            <textarea class="form-control" name="advice" rows="3" required
                                                      placeholder="Advice, recommendations, or additional notes..."></textarea>
                                        </div>

                                        <div class="form-group text-center">
                                            <button type="submit" class="btn btn-primary">Save Consultation</button>
                                        </div>
                                    </form>
                                </div>


                                <div class="tab-pane fade" id="prescription">
                                    <form method="POST" action="{% url 'add_prescription' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="patient_id" id="prescription-patient-id" required>

                                        <div class="form-group">
                                            <label>Medication Name</label>
                                            <input type="text" name="medication" class="form-control" placeholder="e.g., Metformin"
                                                   required>
                                        </div>

                                        <div class="form-group">
                                            <label>Dosage & Instructions</label>
                                            <textarea name="instructions" class="form-control" rows="2"
                                                      placeholder="e.g., 500mg twice daily after meals" required></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label>Start Date</label>
                                            <input type="date" name="start_date" class="form-control" required>
                                        </div>

                                        <div class="form-group text-center">
                                            <button type="submit" class="btn btn-success">Add Prescription</button>
                                        </div>
                                    </form>
                                </div>

                                <div class="tab-pane fade" id="plan">
                                    <form method="POST" action="{% url 'save_care_plan' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="patient_id" id="plan-patient-id" required>

                                        <div class="form-group">
                                            <label>Clinical Findings</label>
                                            <textarea class="form-control" name="clinical_findings" rows="3" required></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label>Plan of Care</label>
                                            <textarea class="form-control" name="plan_of_care" rows="3"
                                                      placeholder="Next steps, referrals, follow-up..." required></textarea>
                                        </div>

                                        <button type="submit" class="btn btn-info">Save Care Plan</button>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>
                </div> {# End of col-lg-8 #}

            </div> {# End of row #}
        </div>
    </section>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const mainPatientSelect = document.getElementById('main-patient-select');
        const historyContainer = document.getElementById('patient-history');
        const historyContent = document.getElementById('history-content');
        const historyPatientNameSpan = document.getElementById('history-patient-name');

        // Hidden patient ID inputs for each form
        const diagnosisPatientIdInput = document.getElementById('diagnosis-patient-id');
        const prescriptionPatientIdInput = document.getElementById('prescription-patient-id');
        const planPatientIdInput = document.getElementById('plan-patient-id');

        // Get base URL from Django template for AJAX
        const baseUrl = "{% url 'patient_history_ajax' 0 %}".replace('/0/', '/'); // remove dummy 0

        // Initialize Select2 with custom matcher and explicit width
        $('#main-patient-select').select2({
            placeholder: "Search by patient name or ID...",
            allowClear: false, // Set to false to remove the "cancel" or clear button
            width: '100%', // Explicitly set width to 100%
            matcher: function(params, data) {
                // If there are no search terms, return all of the data
                if ($.trim(params.term) === '') {
                    return data;
                }

                // Do not display the item if there is no 'text' property
                if (typeof data.text === 'undefined') {
                    return null;
                }

                // Convert search term and data to lowercase for case-insensitive comparison
                const termLower = params.term.toLowerCase();
                const textLower = data.text.toLowerCase();
                const idLower = String(data.id).toLowerCase(); // Ensure ID is treated as a string for comparison

                // Check if the text (full name) or the ID includes the search term
                if (textLower.includes(termLower) || idLower.includes(termLower)) {
                    return data;
                }

                // Return `null` if the term should not be displayed
                return null;
            }
        });

        $(mainPatientSelect).on('change', function() {
            const selectedOption = $(this).find('option:selected');
            let patientId = selectedOption.val();
            // We get the full name from the 'data-full-name' attribute set in the option tag
            let patientName = selectedOption.data('full-name');

            if (patientId) {
                // Set the patient_id in all hidden inputs
                diagnosisPatientIdInput.value = patientId;
                prescriptionPatientIdInput.value = patientId;
                planPatientIdInput.value = patientId;

                // Update the patient name in the history display header
                historyPatientNameSpan.textContent = patientName;

                fetch(`${baseUrl}${patientId}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json(); // Corrected: Expect JSON response
                    })
                    .then(data => {
                        renderPatientHistory(data); // Call function to render history
                        historyContainer.style.display = 'block';
                    })
                    .catch(error => {
                        historyContent.innerHTML = "<p class='text-danger'>Failed to load history.</p>";
                        historyContainer.style.display = 'block';
                        console.error('Error fetching patient history:', error);
                    });
            } else {
                // Clear hidden inputs and hide history if no valid patient is selected
                diagnosisPatientIdInput.value = '';
                prescriptionPatientIdInput.value = '';
                planPatientIdInput.value = '';
                historyPatientNameSpan.textContent = ''; // Clear patient name
                historyContainer.style.display = 'none';
                historyContent.innerHTML = ''; // Clear content
            }
        });


        function renderPatientHistory(data) {
            let html = '';

            if (!data || !data.patient) {
                html = '<p class="text-info">No patient data available.</p>';
                historyContent.innerHTML = html;
                return;
            }

            // Patient Demographics
            html += `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Full Name:</strong> ${data.patient.full_name || 'N/A'}</p>
                        <p><strong>Date of Birth:</strong> ${data.patient.date_of_birth || 'N/A'}</p>
                        <p><strong>Gender:</strong> ${data.patient.gender || 'N/A'}</p>
                        <p><strong>Outstanding Balance:</strong> <strong style="color: red;">${data.outstanding_payments || '0.00'}</strong></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Phone:</strong> ${data.patient.phone || 'N/A'}</p>
                        <p><strong>Blood Group:</strong> ${data.patient.blood_group || 'N/A'}</p>
                        <p><strong>Status:</strong> ${data.patient.status || 'N/A'}</p>
                    </div>
                </div>
                <hr>
            `;

            // Recent Consultations
            html += '<div class="row">';
            html += '<div class="col-md-12">'; // Changed to col-md-12 for full width within this section
            html += '<h5>Recent Consultations</h5>';
            if (data.consultations && data.consultations.length > 0) {
                html += '<ul class="list-group list-group-flush">';
                data.consultations.forEach(consultation => {
                    html += `
                        <li class="list-group-item">
                            <strong>Date:</strong> ${consultation.created_at_formatted || 'N/A'}<br>
                            <strong>Symptoms:</strong> ${consultation.symptoms || 'N/A'}<br>
                            <strong>Diagnosis:</strong> ${consultation.diagnosis_summary || 'N/A'}<br>
                            <strong>Advice:</strong> ${consultation.advice || 'N/A'}
                        </li>
                    `;
                });
                html += '</ul>';
            } else {
                html += '<p class="text-muted">No recent consultations.</p>';
            }
            html += '</div>'; // End col-md-12
            html += '</div>'; // End row
            html += '<hr>';

            // Recent Prescriptions
            html += '<div class="row">';
            html += '<div class="col-md-12">'; // Changed to col-md-12
            html += '<h5>Recent Prescriptions</h5>';
            if (data.prescriptions && data.prescriptions.length > 0) {
                html += '<ul class="list-group list-group-flush">';
                data.prescriptions.forEach(prescription => {
                    html += `
                        <li class="list-group-item">
                            <strong>Date:</strong> ${prescription.created_at_formatted || 'N/A'}<br>
                            <strong>Medication:</strong> ${prescription.medication || 'N/A'}<br>
                            <strong>Instructions:</strong> ${prescription.instructions || 'N/A'}<br>
                            <strong>Start Date:</strong> ${prescription.start_date_formatted || 'N/A'}
                        </li>
                    `;
                });
                html += '</ul>';
            } else {
                html += '<p class="text-muted">No recent prescriptions.</p>';
            }
            html += '</div>'; // End col-md-12
            html += '</div>'; // End row
            html += '<hr>';

            // Recent Lab Tests (Tabulated)
            html += '<h5>Recent Lab Tests</h5>';
            if (data.lab_tests && data.lab_tests.length > 0) {
                html += `
                    <div class="table-responsive mb-3">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>Test Name</th>
                                    <th>Result</th>
                                    <th>Normal Range</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                data.lab_tests.forEach(test => {
                    html += `
                                <tr>
                                    <td>${test.requested_at_formatted || 'N/A'}</td>
                                    <td>${test.category_name || 'N/A'}</td>
                                    <td>${test.test_name || 'N/A'}</td>
                                    <td>${test.result_value || 'N/A'}</td>
                                    <td>${test.normal_range || 'N/A'}</td>
                                </tr>
                    `;
                });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html += '<p class="text-muted">No recent lab tests.</p>';
            }
            html += '<hr>';

            // Recent Vitals & Nursing Notes (arranged side-by-side)
            html += '<div class="row">';
            html += '<div class="col-md-6">'; // Column for Vitals
            html += '<h5>Recent Vitals</h5>';
            if (data.vitals && data.vitals.length > 0) {
                html += '<ul class="list-group list-group-flush">';
                data.vitals.forEach(vital => {
                    html += `
                        <li class="list-group-item">
                            <strong>Recorded At:</strong> ${vital.recorded_at_formatted || 'N/A'}<br>
                            <strong>BP:</strong> ${vital.blood_pressure || 'N/A'},
                            <strong>Temp:</strong> ${vital.temperature || 'N/A'}°C,
                            <strong>Pulse:</strong> ${vital.pulse || 'N/A'},
                            <strong>RR:</strong> ${vital.respiratory_rate || 'N/A'}<br>
                            <strong>Weight:</strong> ${vital.weight || 'N/A'} kg,
                            <strong>Height:</strong> ${vital.height || 'N/A'} cm,
                            <strong>BMI:</strong> ${vital.bmi || 'N/A'}<br>
                            <strong>Notes:</strong> ${vital.notes || 'N/A'}
                        </li>
                    `;
                });
                html += '</ul>';
            } else {
                html += '<p class="text-muted">No recent vitals.</p>';
            }
            html += '</div>'; // End col-md-6

            html += '<div class="col-md-6">'; // Column for Nursing Notes
            html += '<h5>Recent Nursing Notes</h5>';
            if (data.nursing_notes && data.nursing_notes.length > 0) {
                html += '<ul class="list-group list-group-flush">';
                data.nursing_notes.forEach(note => {
                    html += `
                        <li class="list-group-item">
                            <strong>Date/Time:</strong> ${note.note_datetime_formatted || 'N/A'}<br>
                            <strong>Type:</strong> ${note.note_type_display || 'N/A'}<br>
                            <strong>Notes:</strong> ${note.notes || 'N/A'}<br>
                            <strong>Status:</strong> ${note.patient_status || 'N/A'}
                        </li>
                    `;
                });
                html += '</ul>';
            } else {
                html += '<p class="text-muted">No recent nursing notes.</p>';
            }
            html += '</div>'; // End col-md-6
            html += '</div>'; // End row


            historyContent.innerHTML = html;
        }
    });
</script>

{% endblock %}