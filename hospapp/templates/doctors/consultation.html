{% extends "doctors/base.html" %}

{% load static %}

{% block title %}Doctors | Patient Consultation{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <h1 class="m-0 text-dark">Patient Consultation</h1>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="card card-primary card-outline">
            <div class="card-header p-2">
                <ul class="nav nav-pills" id="doctorTabs">
                    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#diagnosis">Consultation &
                            Diagnosis</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#prescription">Prescription</a>
                    </li>
                    <!--li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tests">Request Tests</a></li>-->
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#plan">Care Plan</a></li>
                </ul>
            </div>

            <div class="card-body">
                <div class="tab-content">

                    <!-- Diagnosis Tab (Combined with Consultation) -->
                    <div class="tab-pane fade show active" id="diagnosis">
                        <form method="POST" action="{% url 'save_consultation' %}">
                            {% csrf_token %}

                            <!-- Patient Selector -->
                            <div class="form-group">
                                <label>Select Patient</label>
                                <select class="form-control" name="patient_id" id="patient-select" required>
                                    <option value="" disabled selected>-- Choose Patient --</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}">{{ patient.full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Patient History Display (populated via AJAX) -->
                            <div id="patient-history" class="border rounded p-3 bg-light mb-3" style="display: none;">
                                <strong>Patient Medical History</strong>
                                <div id="history-content" class="mt-2 text-muted small">
                                    <!-- AJAX-loaded content -->
                                </div>
                            </div>

                            <!-- Symptoms -->
                            <div class="form-group">
                                <label>Symptoms / Complaints</label>
                                <textarea class="form-control" name="symptoms" rows="3" required
                                    placeholder="Enter patient symptoms and complaints..."></textarea>
                            </div>

                            <!-- Diagnosis Summary -->
                            <div class="form-group">
                                <label>Diagnosis Summary</label>
                                <textarea class="form-control" name="diagnosis_summary" rows="3" required
                                    placeholder="Enter diagnosis details..."></textarea>
                            </div>

                            <!-- Doctor Advice -->
                            <div class="form-group">
                                <label>Doctor's Advice & Notes</label>
                                <textarea class="form-control" name="advice" rows="3" required
                                    placeholder="Advice, recommendations, or additional notes..."></textarea>
                            </div>

                            <div class="form-group text-center">
                                <button type="submit" class="btn btn-primary">Save Consultation</button>
                            </div>
                        </form>
                    </div>


                    <!-- Prescription Tab -->
                    <div class="tab-pane fade" id="prescription">
                        <form method="POST" action="{% url 'add_prescription' %}">
                            {% csrf_token %}

                            <!-- Patient Selector -->
                            <div class="form-group">
                                <label>Select Patient</label>
                                <select name="patient_id" class="form-control" required>
                                    <option value="" disabled selected>-- Choose Patient --</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}">{{ patient.full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Patient History Display (populated via AJAX) -->
                            <div id="prescription-patient-history" class="border rounded p-3 bg-light mb-3"
                                style="display: none;">
                                <strong>Patient Medical History</strong>
                                <div id="prescription-history-content" class="mt-2 text-muted small">
                                    <!-- AJAX-loaded content -->
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Medication Name</label>
                                <input type="text" name="medication" class="form-control" placeholder="e.g., Metformin"
                                    required>
                            </div>

                            <div class="form-group">
                                <label>Dosage & Instructions</label>
                                <textarea name="instructions" class="form-control" rows="2"
                                    placeholder="e.g., 500mg twice daily after meals" required></textarea>
                            </div>

                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="date" name="start_date" class="form-control" required>
                            </div>

                            <div class="form-group text-center">
                                <button type="submit" class="btn btn-success">Add Prescription</button>
                            </div>
                        </form>
                    </div>

                    <!-- Request Tests Tab -->
                    <div class="tab-pane fade" id="tests">
                        <form method="POST" action="{% url 'request_tests' %}">
                            {% csrf_token %}
                            <!-- Patient Selector -->
                            <div class="form-group">
                                <label>Select Patient</label>
                                <select class="form-control" name="patient_id" id="test-patient-select" required>
                                    <option value="" disabled selected>-- Choose Patient --</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}">{{ patient.full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Select Tests to Request</label>
                                <select class="form-control" name="test">
                                    <option value="" selected disabled>-- Select Test --</option>
                                    <option>Fertility Hormone Panel</option>
                                    <option>Ultrasound Scan</option>
                                    <option>Blood Count</option>
                                    <option>Thyroid Function Test</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Additional Instructions</label>
                                <textarea class="form-control" rows="2" name="instructions"></textarea>
                            </div>
                            <button type="submit" class="btn btn-warning">Request Tests</button>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="plan">
                        <form method="POST" action="{% url 'save_care_plan' %}">
                            {% csrf_token %}
                            <div class="form-group">
                                <label>Select Patient</label>
                                <select class="form-control" name="patient_id" id="plan-patient-select" required>
                                    <option value="" disabled selected>-- Choose Patient --</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}">{{ patient.full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Clinical Findings</label>
                                <textarea class="form-control" name="clinical_findings" rows="3" required></textarea>
                            </div>

                            <div class="form-group">
                                <label>Plan of Care</label>
                                <textarea class="form-control" name="plan_of_care" rows="3"
                                    placeholder="Next steps, referrals, follow-up..." required></textarea>
                            </div>

                            <button type="submit" class="btn btn-info">Save Care Plan</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Function to set up patient history loading
        function setupPatientHistoryLoading(selectId, historyContainerId, historyContentId) {
            const patientSelect = document.getElementById(selectId);
            const historyContainer = document.getElementById(historyContainerId);
            const historyContent = document.getElementById(historyContentId);

            if (!patientSelect) return;

            // Get base URL from Django template
            const baseUrl = "{% url 'patient_history_ajax' 0 %}".replace('/0/', '/');  // remove dummy 0

            patientSelect.addEventListener('change', function () {
                const patientId = this.value;

                if (patientId) {
                    fetch(`${baseUrl}${patientId}/`)
                        .then(response => response.text())
                        .then(data => {
                            historyContent.innerHTML = data;
                            historyContainer.style.display = 'block';
                        })
                        .catch(error => {
                            historyContent.innerHTML = "<p class='text-danger'>Failed to load history.</p>";
                            historyContainer.style.display = 'block';
                        });
                } else {
                    historyContainer.style.display = 'none';
                }
            });
        }

        // Set up history loading for main diagnosis tab
        setupPatientHistoryLoading('patient-select', 'patient-history', 'history-content');

        // Apply the same patient history loading to other tabs that need it
        // You may need to create the corresponding HTML elements in those tabs
    });
</script>

{% endblock %}