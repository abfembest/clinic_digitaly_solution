{% extends "laboratory/base.html" %}

{% block title %}HMS | Test Logs{% endblock %}

{% load static %}

{% block content %}
<section class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1><i class="fas fa-history mr-2"></i>Laboratory Test Logs</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a href="{% url 'laboratory' %}">Home</a></li>
          <li class="breadcrumb-item active">Lab Logs</li>
        </ol>
      </div>
    </div>
  </div>
</section>

<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        {% if lab_logs %}
        <div class="card">
          <div class="card-header bg-primary">
            <h3 class="card-title"><i class="fas fa-vials mr-2"></i>Lab Test Records</h3>
            <div class="card-tools">
              <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus text-white"></i>
              </button>
              <div class="btn-group">
                <button type="button" class="btn btn-tool dropdown-toggle text-white" data-toggle="dropdown">
                  <i class="fas fa-download"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right" role="menu">
                  <a href="#" class="dropdown-item">
                    <i class="fas fa-file-excel mr-2"></i>Export to Excel
                  </a>
                  <a href="#" class="dropdown-item">
                    <i class="fas fa-file-pdf mr-2"></i>Export to PDF
                  </a>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-4">
                <div class="form-group">
                  <label>Date Range:</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text">
                        <i class="far fa-calendar-alt"></i>
                      </span>
                    </div>
                    <input type="text" class="form-control float-right" id="date-range-filter" placeholder="Select date range">
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label>Test Type:</label>
                  <select class="form-control" id="test-type-filter">
                    <option value="">All Types</option>
                    {% for test_type in unique_test_types %}
                      <option value="{{ test_type }}">{{ test_type }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label>Status:</label>
                  <select class="form-control" id="status-filter">
                    <option value="">All Status</option>
                    <option value="Completed">Completed</option>
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="table-responsive">
              <table id="labLogsTable" class="table table-hover table-striped">
                <thead class="thead-light">
                  <tr>
                    <th>Patient ID</th>
                    <th>Test Request ID</th>
                    <th>Patient</th>
                    <th>Date</th>
                    <th>Lab Staff</th>
                    <th>Tests</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for log_group in lab_logs %}
                  <tr>
                    <td><span class="badge badge-secondary">{{ log_group.patient_id }}</span></td>
                    <td><span class="badge badge-primary">{{ log_group.test_request_id }}</span></td>
                    <td>{{ log_group.patient_name }}</td>
                    <td>{{ log_group.date|date:"M d, Y" }}</td>
                    <td>{{ log_group.lab_staff }}</td>
                    <td>
                      {% for test in log_group.tests %}
                        <div>
                          <strong>{{ test.test_type }}</strong>: 
                          <span class="badge badge-pill 
                            {% if test.status == 'Completed' %}badge-success
                            {% elif test.status == 'Pending' %}badge-warning
                            {% elif test.status == 'In Progress' %}badge-info
                            {% elif test.status == 'Cancelled' %}badge-danger
                            {% else %}badge-secondary{% endif %}">
                            {{ test.status }}
                          </span>
                        </div>
                      {% endfor %}
                    </td>
                    <td class="text-center">
                      <div class="btn-group">
                        <button type="button" class="btn btn-info btn-sm view-details-btn" 
                          data-toggle="modal" 
                          data-target="#logDetailsModal" 
                          data-test-request-id="{{ log_group.test_request_id }}">
                          <i class="fas fa-eye"></i> View
                        </button>
                        <button type="button" class="btn btn-primary btn-sm">
                          <i class="fas fa-print"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% else %}
        <div class="alert alert-info">
          <h5><i class="icon fas fa-info-circle"></i> No Records Found</h5>
          There are no lab test logs available. New tests will appear here once they are recorded.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<div class="modal fade" id="logDetailsModal" tabindex="-1" role="dialog" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="logDetailsModalLabel">
          <i class="fas fa-flask mr-2"></i>Lab Test Details
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="modal-loading" class="text-center my-5">
          <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="sr-only">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Loading test details...</p>
        </div>
        <div id="modal-content" style="display: none;">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times-circle mr-1"></i>Close
        </button>
        <button type="button" class="btn btn-primary">
          <i class="fas fa-print mr-1"></i>Print Report
        </button>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<script>
  $(document).ready(function() {
    // Initialize DataTable
    var table = $('#labLogsTable').DataTable({
      "responsive": true,
      "lengthChange": false,
      "autoWidth": false,
      "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"],
      "columnDefs": [
        { "orderable": false, "targets": 6 } // Disable ordering on the "Actions" column
      ]
    });

    table.buttons().container().appendTo('#labLogsTable_wrapper .col-md-6:eq(0)');

    // Initialize date range picker
    var dateRangeFilter = $('#date-range-filter').daterangepicker({
      autoUpdateInput: false,
      locale: {
        cancelLabel: 'Clear'
      }
    });

    dateRangeFilter.on('apply.daterangepicker', function(ev, picker) {
      $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
      table.draw();
    });

    dateRangeFilter.on('cancel.daterangepicker', function(ev, picker) {
      $(this).val('');
      table.draw();
    });

    // Custom filtering functions
    $.fn.dataTable.ext.search.push(
      function(settings, data, dataIndex) {
        // Date range filter (assuming date is in the fourth column, index 3)
        var dateRange = $('#date-range-filter').val();
        if (dateRange) {
          var dateString = data[3]; 
          var date = moment(dateString, 'MMM DD, YYYY'); 
          var start = moment(dateRange.split(' - ')[0], 'MM/DD/YYYY');
          var end = moment(dateRange.split(' - ')[1], 'MM/DD/YYYY');
          if (date.isBefore(start) || date.isAfter(end)) {
            return false;
          }
        }
        
        // Test type filter
        var testType = $('#test-type-filter').val();
        if (testType) {
            var cellContent = data[5];
            if (cellContent.indexOf(testType) === -1) {
                return false;
            }
        }

        // Status filter
        var status = $('#status-filter').val();
        if (status) {
            var cellContent = data[5];
            if (cellContent.indexOf(status) === -1) {
                return false;
            }
        }
        
        return true;
      }
    );

    // Apply filters on change
    $('#test-type-filter, #status-filter').on('change', function() {
      table.draw();
    });

    // Modal detail loading
    $('#logDetailsModal').on('show.bs.modal', function(event) {
      var button = $(event.relatedTarget);
      var testRequestId = button.data('test-request-id');
      var modal = $(this);
      
      modal.find('#modal-loading').show();
      modal.find('#modal-content').hide();
      
      $.ajax({
        url: "{% url 'lab_log_detail_ajax' %}", // URL to fetch a group of tests
        data: { 'test_request_id': testRequestId },
        dataType: 'json',
        success: function(data) {
          modal.find('#modal-loading').hide();
          
          var contentHtml = `<div class="card card-primary card-outline">
            <div class="card-header">
              <h3 class="card-title">Test Request Details for Patient: <strong>${data.patient_name}</strong></h3>
              <div class="card-tools">
                <span class="badge badge-info">${data.total_tests} Test(s)</span>
              </div>
            </div>
            <div class="card-body">
              <div class="mb-4">
                <h4><i class="fas fa-info-circle mr-2"></i>General Information</h4>
                <ul class="list-group list-group-unbordered mb-3">
                  <li class="list-group-item">
                    <b>Patient Name:</b> <span class="float-right">${data.patient_name}</span>
                  </li>
                  <li class="list-group-item">
                    <b>Date Requested:</b> <span class="float-right">${moment(data.date_requested).format('MMMM Do, YYYY')}</span>
                  </li>
                  <li class="list-group-item">
                    <b>Requesting Doctor:</b> <span class="float-right">${data.requesting_doctor || 'N/A'}</span>
                  </li>
                  <li class="list-group-item">
                    <b>Total Tests:</b> <span class="float-right">${data.total_tests}</span>
                  </li>
                  <li class="list-group-item">
                    <b>Category:</b> <span class="float-right">${data.tests[0].category || 'N/A'}</span>
                  </li>
                  <li class="list-group-item">
                    <b>Performed By:</b> <span class="float-right">${data.tests[0].recorded_by || 'N/A'}</span>
                  </li>
                </ul>
              </div>
              
              <h4><i class="fas fa-flask mr-2"></i>Individual Test Results</h4>
              <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>Test Name</th>
                      <th>Status</th>
                      <th>Key Results</th>
                      <th>Normal Range</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody>`;
                  
          data.tests.forEach(function(test) {
            var statusBadge = '';
            if (test.status === 'Completed') {
              statusBadge = `<span class="badge badge-success">${test.status}</span>`;
            } else if (test.status === 'Pending') {
              statusBadge = `<span class="badge badge-warning">${test.status}</span>`;
            } else if (test.status === 'In Progress') {
              statusBadge = `<span class="badge badge-info">${test.status}</span>`;
            } else if (test.status === 'Cancelled') {
              statusBadge = `<span class="badge badge-danger">${test.status}</span>`;
            }

            contentHtml += `
                    <tr>
                      <td>${test.test_name}</td>
                      <td>${statusBadge}</td>
                      <td>${test.key_results}</td>
                      <td>${test.normal_range}</td>
                      <td>${test.notes || 'N/A'}</td>
                    </tr>`;
          });

          contentHtml += `
                  </tbody>
                </table>
              </div>
            </div>
          </div>`;

          modal.find('#modal-content').html(contentHtml).fadeIn();
        },
        error: function(xhr, status, error) {
          modal.find('#modal-loading').hide();
          modal.find('#modal-content').html(`
            <div class="alert alert-danger">
              <h5><i class="icon fas fa-ban"></i> Error Loading Data</h5>
              <p>Could not load test details. Please try again or contact support.</p>
              <p class="mb-0"><small>Error: ${error}</small></p>
            </div>
          `).show();
        }
      });
    });
    
    // Clear modal content when hidden
    $('#logDetailsModal').on('hidden.bs.modal', function() {
      $(this).find('#modal-content').empty();
    });
  });
</script>
{% endblock %}