{% extends "laboratory/base.html" %}
{% load static %}

{% block title %}HMS | Lab Dashboard{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #2c5aa0;
        --secondary-color: #f8f9fc;
        --accent-color: #17a2b8;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .dashboard-container {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 50%, rgba(241, 245, 249, 0.92) 100%);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin: 20px;
        padding: 30px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header {
        text-align: center;
        margin-bottom: 40px;
        color: var(--primary-color);
    }

        .header h1 {
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #6c757d;
            font-size: 1.1rem;
        }

    .menu-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        border: none;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

            .menu-card:hover::before {
                transform: scaleX(1);
            }

    .menu-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 18px;
        color: white;
        position: relative;
    }

        .menu-icon.pending {
            background: linear-gradient(135deg, #ffc107, #ff9800);
        }

        .menu-icon.patients {
            background: linear-gradient(135deg, #2c5aa0, #1e3a8a);
        }

        .menu-icon.completed {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

    .menu-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
    }

    .menu-subtitle {
        color: #6c757d;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .stats-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: var(--primary-color);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .row {
        --bs-gutter-x: 1.5rem;
    }

    @media (max-width: 768px) {
        .dashboard-container {
            margin: 10px;
            padding: 20px;
        }

        .menu-card {
            padding: 20px;
        }

        .menu-icon {
            width: 35px;
            height: 35px;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .menu-title {
            font-size: 1.1rem;
        }
    }

    .quick-actions {
        background: linear-gradient(135deg, #f8f9fc, #e9ecef);
        border-radius: 15px;
        padding: 20px;
        margin-top: 30px;
        text-align: center;
    }

    .action-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        margin: 5px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

        .action-btn:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
            color: white;
        }
</style>


<div class="container-fluid">
    <div class="dashboard-container">
        <div class="header">
            <h1><i class="bi bi-heart-pulse me-2"></i>IVF Laboratory Dashboard</h1>
            <p>Welcome, {{ user_full_name }}! Comprehensive fertility testing and management system</p>
        </div>

        <div class="row">
            <div class="col-lg-4 col-md-6 col-sm-12">
                <div class="menu-card" onclick="handleMenuClick('dashboard', '{% url 'laboratory' %}')">
                    {% comment %} <div class="stats-badge">{{ total_patients_count|default:0 }}</div> {% endcomment %}
                    <div class="menu-icon patients">
                        <i class="bi bi-speedometer"></i>
                    </div>
                    <div class="menu-title">Dashboard</div>
                    <div class="menu-subtitle">Overview of laboratory operations and patient statistics</div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6 col-sm-12">
                <div class="menu-card" onclick="handleMenuClick('new_test_entry', '{% url 'lab_test_entry' %}')">
                    <div class="stats-badge">{{ pending_count|default:0 }}</div>
                    <div class="menu-icon pending">
                        <i class="bi bi-flask"></i>
                    </div>
                    <div class="menu-title">Pending tests</div>
                    <div class="menu-subtitle">Initiate a new IVF test request and patient details</div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6 col-sm-12">
                <div class="menu-card" onclick="handleMenuClick('test_logs', '{% url 'lab_internal_logs' %}')">
                    <div class="stats-badge">{{ completed_count|default:0 }}</div>
                    <div class="menu-icon completed">
                        <i class="bi bi-journal"></i>
                    </div>
                    <div class="menu-title">Test Logs</div>
                    <div class="menu-subtitle">Access detailed records and history of all IVF tests</div>
                </div>
            </div>
        </div>

        <div class="quick-actions">
            <h5 class="mb-3">Quick Actions</h5>
            <a href="{% url 'lab_test_entry' %}" class="btn action-btn"><i class="bi bi-plus-circle me-2"></i>New Test Entry</a>
            <a href="{% url 'lab_internal_logs' %}?status=pending" class="btn action-btn"><i class="bi bi-calendar-plus me-2"></i>View Pending Tests</a>
            <a href="{% url 'lab_ivf_progress' %}" class="btn action-btn"><i class="bi bi-printer me-2"></i>View IVF Cycles</a>
            <a href="#" class="btn action-btn" data-bs-toggle="modal" data-bs-target="#expenseModal"><i class="bi bi-currency-dollar me-2"></i>Submit Expense</a>
            <a href="{% url 'logout' %}" class="btn action-btn"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        <div class="row">
            <section class="col-lg-5 connectedSortable order-lg-1 order-1">
                                
                {% if awaiting_tests %}
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Awaiting Tests</h3>
                        <div class="card-tools">
                            <span class="badge badge-danger">{{ pending_count|default:0 }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        {% regroup awaiting_tests by patient.full_name as patient_list %}
                        <ul class="list-group list-group-flush">
                            {% for patient in patient_list %}
                                <li class="list-group-item list-group-item-info">
                                    <strong>{{ patient.grouper }}</strong>
                                </li>
                                {% for test in patient.list %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">{{ test.test_name }} ({{ test.category.name }})</small>
                                    </div>
                                    <span class="badge bg-warning rounded-pill">{{ test.requested_at|date:"M d, H:i" }}</span>
                                </li>
                                {% endfor %}
                            {% endfor %}
                            {% if not awaiting_tests %}
                            <li class="list-group-item text-center text-muted">No tests currently awaiting processing.</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                {% endif %}
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Activity</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="timeline timeline-inverse">
                            <div class="time-label">
                                <span class="bg-danger">Today</span>
                            </div>
                            {% if recent_activities %}
                                {% for activity in recent_activities %}
                                <div>
                                    <i class="{{ activity.icon }} {{ activity.bg_color }}"></i>
                                    <div class="timeline-item">
                                        <span class="time"><i class="far fa-clock"></i> {{ activity.timestamp|timesince }} ago</span>
                                        <h3 class="timeline-header"><a href="#">{{ activity.header }}</a></h3>
                                        <div class="timeline-body">
                                            {{ activity.body }}
                                        </div>
                                        <div class="timeline-footer">
                                            <button type="button" class="btn btn-primary btn-sm view-details-btn"
                                                    data-toggle="modal" data-target="#testDetailsModal"
                                                    data-test-name="{{ activity.header }}"
                                                    data-patient-name="{{ activity.body|slice:"8:-27" }}" {# Extracts "Patient [Name]" #}
                                                    data-status="{{ activity.header|slice:"-9:"|cut:" " }}" {# Extracts status from header #}
                                                    data-requested-at="{{ activity.timestamp|date:"M d, Y H:i" }}"
                                                    data-notes="{{ activity.body }}" {# Using body as a placeholder for notes #}
                                                    data-doctor-name="N/A" {# No doctor_name in activity, default to N/A #}
                                                    data-result-value="N/A" {# No result_value in activity, default to N/A #}
                                            >View Details</button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center">No recent activity.</div>
                            {% endif %}
                            <div>
                                <i class="far fa-clock bg-gray"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="col-lg-7 connectedSortable order-lg-2 order-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie mr-1"></i>
                            Weekly Lab Activity
                        </h3>
                        <div class="card-tools">
                            <ul class="nav nav-pills ml-auto">
                                <li class="nav-item">
                                    <a class="nav-link active" href="#revenue-chart" data-toggle="tab">Area</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#sales-chart" data-toggle="tab">Donut</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="tab-content p-0">
                            <div class="chart tab-pane active" id="revenue-chart" style="position: relative; height: 300px;">
                                <canvas id="revenue-chart-canvas" height="300" style="height: 300px;"></canvas>
                            </div>
                            <div class="chart tab-pane" id="sales-chart" style="position: relative; height: 300px;">
                                <canvas id="sales-chart-canvas" height="300" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Today's Test Status</h3>
                        <div class="card-tools">
                            <div class="input-group input-group-sm" style="width: 150px;">
                                <input type="text" name="table_search" class="form-control float-right" placeholder="Search">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-default">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0" style="height: 300px;">
                        <table class="table table-head-fixed text-nowrap">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Patient</th>
                                    <th>Test Type</th>
                                    <th>Status</th>
                                    <th>Requested At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if today_tests_details %}
                                    {% for test in today_tests_details %}
                                    <tr>
                                        <td>{{ test.test_request_id|stringformat:"s"|slice:":8" }}...</td>
                                        <td>{{ test.patient.full_name }}</td>
                                        <td>{{ test.test_name }} ({{ test.category.name }})</td>
                                        <td>
                                            {% if test.status == 'completed' %}
                                                <span class="badge badge-success">{{ test.get_status_display }}</span>
                                            {% elif test.status == 'pending' %}
                                                <span class="badge badge-warning">{{ test.get_status_display }}</span>
                                            {% elif test.status == 'in_progress' %}
                                                <span class="badge badge-info">{{ test.get_status_display }}</span>
                                            {% else %}
                                                <span class="badge badge-secondary">{{ test.get_status_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ test.requested_at|date:"M d, Y H:i" }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="#" class="btn btn-info"><i class="fas fa-eye"></i></a>
                                                {% if test.status == 'pending' %}
                                                    <a href="#" class="btn btn-warning"><i class="fas fa-play"></i></a>
                                                {% elif test.status == 'completed' %}
                                                    <a href="#" class="btn btn-success"><i class="fas fa-download"></i></a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">No tests requested today.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>

        <div class="row mt-4">
            <section class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-money-bill-wave me-1"></i>Expense Requests</h3>
                        <div class="card-tools">
                             <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-5">
                                <div class="card card-outline card-primary">
                                    <div class="card-header">
                                        <h5 class="card-title">Submit a New Expense</h5>
                                    </div>
                                    <div class="card-body">
                                        <form method="post" action="{% url 'laboratory' %}">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="description" class="form-label">Description</label>
                                                <input type="text" class="form-control" id="description" name="description" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="amount" class="form-label">Amount</label>
                                                <input type="number" class="form-control" id="amount" name="amount" min="0.01" step="0.01" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="expense_date" class="form-label">Expense Date</label>
                                                <input type="date" class="form-control" id="expense_date" name="expense_date" value="{{ 'now'|date:'Y-m-d' }}" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="category" class="form-label">Category</label>
                                                <select class="form-control" id="category" name="category" required>
                                                    <option value="" disabled selected>Select a category</option>
                                                    {% for category in expense_categories %}
                                                        <option value="{{ category.name }}">{{ category.name }}</option>
                                                    {% endfor %}
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="notes" class="form-label">Notes</label>
                                                <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100">Submit Request</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <div class="card card-outline card-info">
                                    <div class="card-header">
                                        <h5 class="card-title">My Submitted Expenses</h5>
                                    </div>
                                    <div class="card-body table-responsive p-0" style="height: 400px;">
                                        <table class="table table-head-fixed text-nowrap">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Description</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th>Notes</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if user_expenses %}
                                                    {% for expense in user_expenses %}
                                                        <tr>
                                                            <td>{{ expense.expense_date|date:"M d, Y" }}</td>
                                                            <td>{{ expense.description }}</td>
                                                            <td>â‚¦{{ expense.amount }}</td>
                                                            <td>
                                                                {% if expense.status == 'approved' %}
                                                                    <span class="badge bg-success">{{ expense.get_status_display }}</span>
                                                                {% elif expense.status == 'paid' %}
                                                                    <span class="badge bg-primary">{{ expense.get_status_display }}</span>
                                                                {% elif expense.status == 'rejected' %}
                                                                    <span class="badge bg-danger">{{ expense.get_status_display }}</span>
                                                                {% else %}
                                                                    <span class="badge bg-warning">{{ expense.get_status_display }}</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{ expense.notes|default:"-" }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="5" class="text-center text-muted">No expense requests submitted yet.</td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</section>

<div class="modal fade" id="testDetailsModal" tabindex="-1" role="dialog" aria-labelledby="testDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testDetailsModalLabel">Lab Test Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-3">Test Name:</dt>
                    <dd class="col-sm-9" id="modal-test-name"></dd>

                    <dt class="col-sm-3">Patient Name:</dt>
                    <dd class="col-sm-9" id="modal-patient-name"></dd>

                    <dt class="col-sm-3">Status:</dt>
                    <dd class="col-sm-9" id="modal-status"></dd>

                    <dt class="col-sm-3">Requested At:</dt>
                    <dd class="col-sm-9" id="modal-requested-at"></dd>

                    <dt class="col-sm-3">Doctor Comments:</dt>
                    <dd class="col-sm-9" id="modal-doctor-comments"></dd>

                    <dt class="col-sm-3">Result Value:</dt>
                    <dd class="col-sm-9" id="modal-result-value"></dd>

                    <dt class="col-sm-3">Notes:</dt>
                    <dd class="col-sm-9" id="modal-notes"></dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'laboratory' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="expenseModalLabel">Submit a New Expense Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modal-description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="modal-description" name="description" required>
                    </div>
                    <div class="mb-3">
                        <label for="modal-amount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="modal-amount" name="amount" min="0.01" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="modal-expense_date" class="form-label">Expense Date</label>
                        <input type="date" class="form-control" id="modal-expense_date" name="expense_date" value="{{ 'now'|date:'Y-m-d' }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="modal-category" class="form-label">Category</label>
                        <select class="form-control" id="modal-category" name="category" required>
                            <option value="" disabled selected>Select a category</option>
                            {% for category in expense_categories %}
                                <option value="{{ category.name }}">{{ category.name }}</option>
                            {% endfor %}
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modal-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="modal-notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    function handleMenuClick(section, url) {
        event.currentTarget.style.transform = 'scale(0.95)';
        setTimeout(() => {
            event.currentTarget.style.transform = 'translateY(-5px)';
        }, 150);

        console.log(`Navigating to: ${section} at ${url}`);
        window.location.href = url;
    }

    document.querySelectorAll('.menu-card').forEach(card => {
        card.addEventListener('mouseenter', function () {
            this.style.transform = 'translateY(-5px)';
        });

        card.addEventListener('mouseleave', function () {
            this.style.transform = 'translateY(0)';
        });
    });

    function updateStats() {
        const badges = document.querySelectorAll('.stats-badge');
        badges.forEach(badge => {
            badge.style.animation = 'pulse 0.5s ease-in-out';
            setTimeout(() => badge.style.animation = '', 500);
        });
    }

    setInterval(updateStats, 30000);
</script>


<script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
<script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>

<script>
$(function () {
  'use strict'

  var ticksStyle = {
    fontColor: '#495057',
    fontStyle: 'bold'
  }

  var mode = 'index'
  var intersect = true

  var $salesChart = $('#sales-chart-canvas')
  var salesChart = new Chart($salesChart, {
    type: 'doughnut',
    data: {
      labels: [
        'Completed Tests',
        'Pending Tests',
        'In Progress'
      ],
      datasets: [
        {
          data: [{{ completed_count|default:0 }}, {{ pending_count|default:0 }}, {{ in_progress_count|default:0 }}],
          backgroundColor: ['#00a65a', '#f39c12', '#00c0ef'],
        }
      ]
    },
    options: {
      maintainAspectRatio: false,
      tooltips: {
        mode: mode,
        intersect: intersect
      },
      legend: {
        display: true
      }
    }
  })

  var $visitorsChart = $('#revenue-chart-canvas')
  var visitorsChart = new Chart($visitorsChart, {
    data: {
      labels: JSON.parse('{{ weekly_labels|safe }}'),
      datasets: [{
        type: 'line',
        data: JSON.parse('{{ weekly_tests_data_completed|safe }}'),
        backgroundColor: 'transparent',
        borderColor: '#007bff',
        pointBorderColor: '#007bff',
        pointBackgroundColor: '#007bff',
        fill: false,
        label: 'Completed Tests'
      }, {
        type: 'line',
        data: JSON.parse('{{ weekly_tests_data_total|safe }}'),
        backgroundColor: 'transparent',
        borderColor: '#ced4da',
        pointBorderColor: '#ced4da',
        pointBackgroundColor: '#ced4da',
        fill: false,
        label: 'Total Tests'
      }]
    },
    options: {
      maintainAspectRatio: false,
      tooltips: {
        mode: mode,
        intersect: intersect
      },
      hover: {
        mode: mode,
        intersect: intersect
      },
      legend: {
        display: true
      },
      scales: {
        yAxes: [{
          gridLines: {
            display: true,
            lineWidth: '4px',
            color: 'rgba(0, 0, 0, .2)',
            zeroLineColor: 'transparent'
          },
          ticks: $.extend({
            beginAtZero: true,
            suggestedMax: Math.max(...JSON.parse('{{ weekly_tests_data_total|safe }}')) + 5
          }, ticksStyle)
        }],
        xAxes: [{
          display: true,
          gridLines: {
            display: false
          },
          ticks: ticksStyle
        }]
      }
    }
  })

    // JavaScript for modal population
    $('#testDetailsModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); // Button that triggered the modal
        var testName = button.data('test-name');
        var patientName = button.data('patient-name');
        var status = button.data('status');
        var requestedAt = button.data('requested-at');
        var doctorComments = button.data('doctor-name'); // Reusing doctor-name for doctor comments placeholder
        var resultValue = button.data('result-value');
        var notes = button.data('notes');

        var modal = $(this);
        modal.find('#modal-test-name').text(testName);
        modal.find('#modal-patient-name').text(patientName);
        modal.find('#modal-status').text(status);
        modal.find('#modal-requested-at').text(requestedAt);
        modal.find('#modal-doctor-comments').text(doctorComments);
        modal.find('#modal-result-value').text(resultValue);
        modal.find('#modal-notes').text(notes);
    });
})

function refreshTestStatus() {
  $(document).Toasts('create', {
    class: 'bg-info',
    title: 'Refreshed',
    subtitle: 'System',
    body: 'Test status updated successfully.',
    autohide: true,
    delay: 3000
  })
}
</script>

{% endblock %}