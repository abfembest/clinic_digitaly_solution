{% extends "laboratory/base.html" %}
{% load static %}

{% block title %}HMS | Lab Test{% endblock %}

{% block content %}

<div class="content-header">
    <div class="container-fluid">
        <h1 class="m-0 text-dark">Lab Test Entry</h1>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        <!-- Patient Type Toggle -->
        <div class="card card-outline card-info mb-3">
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Select Patient Type</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="searchMode" id="referredOnly" value="referred" checked>
                            <label class="form-check-label" for="referredOnly">Referred Patients</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="searchMode" id="allPatients" value="all">
                            <label class="form-check-label" for="allPatients">All Patients</label>
                        </div>
                    </div>
                </div>

                <!-- Patient Search -->
                <div class="form-group position-relative">
                    <label for="patient_search">Search Patient</label>
                    <input type="text" class="form-control" id="patient_search"
                        placeholder="Start typing patient name..." autocomplete="off">
                    <div id="patientSuggestions" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                </div>
                <input type="hidden" name="patient_id" id="form_patient">
                <div id="selectedPatient" class="text-muted mt-2" style="display: none;"></div>
            </div>
        </div>

        <!-- Lab Test Form -->
        <form method="post" action="{% url 'submit_lab_test' %}">
            {% csrf_token %}
            <input type="hidden" name="patient_id" id="form_patient">

            <div class="card card-outline card-info">
                <div class="card-header d-flex justify-content-start align-items-center">
                    <h3 class="card-title">Lab Tests</h3>
                    <button type="button" class="btn btn-sm btn-success mx-5" id="addTestBtn">+ Add Test</button>
                </div>
                <div class="card-body" id="testsContainer">
                    <!-- Dynamic test sections will be appended here -->
                </div>

                <div class="card-footer">
                    <button class="btn btn-primary">Submit All Available Tests</button>
                </div>
            </div>
        </form>
    </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let testCount = 0;
    let searchMode = 'referred'; // default mode

    const addTestBtn = document.getElementById("addTestBtn");
    const testsContainer = document.getElementById("testsContainer");
    const searchInput = document.getElementById('patient_search');
    const suggestions = document.getElementById('patientSuggestions');
    const patientIdField = document.getElementById('form_patient');
    const display = document.getElementById('selectedPatient');
    const modeRadios = document.querySelectorAll('input[name="searchMode"]');

    // Switch between patient modes
    modeRadios.forEach(radio => {
        radio.addEventListener('change', function () {
            searchMode = this.value;
            searchInput.value = '';
            suggestions.innerHTML = '';
            display.style.display = 'none';
            patientIdField.value = '';
        });
    });

    // Add New Test Block
    addTestBtn.addEventListener("click", function () {
        const testIndex = testCount++;

        const testBlock = document.createElement("div");
        testBlock.className = "border p-3 mb-3 rounded test-section bg-light";
        testBlock.innerHTML = `
            <div class="form-group">
                <label>Test Type</label>
                <input type="text" class="form-control" name="tests[${testIndex}][type]" placeholder="e.g. Semen Analysis">
            </div>
            <div class="test-fields-container" id="fields-${testIndex}"></div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addField(${testIndex})">+ Add Field</button>
        `;
        testsContainer.appendChild(testBlock);
    });

    // Add Field to Specific Test
    window.addField = function (testIndex) {
        const fieldContainer = document.getElementById(`fields-${testIndex}`);
        const fieldCount = fieldContainer.children.length;

        const fieldHTML = `
            <div class="form-row align-items-end mb-2">
                <div class="col">
                    <label>Field Name</label>
                    <input type="text" class="form-control" name="tests[${testIndex}][fields][${fieldCount}][name]" placeholder="e.g. Sperm Count">
                </div>
                <div class="col">
                    <label>Value</label>
                    <input type="text" class="form-control" name="tests[${testIndex}][fields][${fieldCount}][value]" placeholder="e.g. 45">
                </div>
            </div>
        `;
        fieldContainer.insertAdjacentHTML("beforeend", fieldHTML);
    };

    // Patient Search with mode toggle
    searchInput.addEventListener('keyup', function () {
        const query = this.value;
        if (query.length < 1) {
            suggestions.innerHTML = '';
            return;
        }

        fetch(`/patient-search/?q=${encodeURIComponent(query)}&lab_mode=${searchMode === 'referred' ? 1 : 0}`)
            .then(res => res.json())
            .then(data => {
                suggestions.innerHTML = '';
                data.results.forEach(patient => {
                    const item = document.createElement('a');
                    item.classList.add('list-group-item', 'list-group-item-action');
                    item.textContent = `${patient.full_name} (ID: ${patient.id})`;
                    item.href = "#";
                    item.onclick = function (e) {
                        e.preventDefault();
                        searchInput.value = patient.full_name;
                        suggestions.innerHTML = '';
                        display.textContent = `Selected Patient (${searchMode === 'referred' ? 'Referred' : 'All'}): ${patient.full_name}`;
                        display.style.display = 'block';
                        patientIdField.value = patient.id;
                    };
                    suggestions.appendChild(item);
                });
            });
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target)) {
            suggestions.innerHTML = '';
        }
    });
});
</script>

{% endblock %}


{% comment %} {% extends "laboratory/base.html" %}
{% load static %}

{% block title %}HMS | Lab Test{% endblock %}

{% block content %}

<div class="content-header">
    <div class="container-fluid">
        <h1 class="m-0 text-dark">Lab Test Entry</h1>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        <!-- Patient Search -->
        <div class="card card-outline card-info mb-3">
            <div class="card-body">
                <div class="form-group position-relative">
                    <label for="patient_search">Search Patient</label>
                    <input type="text" class="form-control" id="patient_search"
                        placeholder="Start typing patient name..." autocomplete="off">
                    <div id="patientSuggestions" class="list-group position-absolute w-100" style="z-index: 1000;">
                    </div>
                </div>
                <input type="hidden" name="patient_id" id="patient_id">
                <div id="selectedPatient" class="text-muted mt-2" style="display: none;"></div>
            </div>
        </div>

        <!-- Lab Test Form -->
        <form method="post" action="{% url 'submit_lab_test' %}">
            {% csrf_token %}
            <input type="hidden" name="patient_id" id="form_patient">

            <div class="card card-outline card-info">
                <div class="card-header">
                    <h3 class="card-title">Lab Tests</h3>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#semen">Semen
                                Analysis</a></li>
                        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#blood">Blood Screening</a>
                        </li>
                        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#hormone">Hormonal Assay</a>
                        </li>
                        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#pregnancy">Pregnancy Test</a>
                        </li>
                        <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#infection">Infection
                                Screening</a></li>
                    </ul>

                    <div class="tab-content">
                        <!-- Semen -->
                        <div class="tab-pane fade show active" id="semen">
                            <div class="form-group">
                                <label>Sperm Count (million/ml)</label>
                                <input type="number" class="form-control" name="sperm_count">
                            </div>
                            <div class="form-group">
                                <label>Motility (%)</label>
                                <input type="number" class="form-control" name="motility">
                            </div>
                        </div>

                        <!-- Blood -->
                        <div class="tab-pane fade" id="blood">
                            <div class="form-group">
                                <label>Blood Type</label>
                                <select class="form-control" name="blood_type">
                                    <option value="">-- Choose --</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Screening Notes</label>
                                <textarea class="form-control" name="blood_notes"></textarea>
                            </div>
                        </div>

                        <!-- Hormone -->
                        <div class="tab-pane fade" id="hormone">
                            <div class="form-group">
                                <label>Hormone Type</label>
                                <input type="text" class="form-control" name="hormone_type">
                            </div>
                            <div class="form-group">
                                <label>Level (ng/mL)</label>
                                <input type="number" class="form-control" name="hormone_level">
                            </div>
                        </div>

                        <!-- Pregnancy -->
                        <div class="tab-pane fade" id="pregnancy">
                            <div class="form-group">
                                <label>Test Result</label>
                                <select class="form-control" name="pregnancy_result">
                                    <option value="">-- Choose --</option>
                                    <option value="positive">Positive</option>
                                    <option value="negative">Negative</option>
                                </select>
                            </div>
                        </div>

                        <!-- Infection -->
                        <div class="tab-pane fade" id="infection">
                            <div class="form-group">
                                <label>Infection Type</label>
                                <input type="text" class="form-control" name="infection_type">
                            </div>
                            <div class="form-group">
                                <label>Screening Result</label>
                                <select class="form-control" name="infection_result">
                                    <option value="">-- Choose --</option>
                                    <option value="positive">Positive</option>
                                    <option value="negative">Negative</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary mt-3">Submit All Available Tests</button>
                </div>
            </div>
        </form>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById('patient_search');
        const suggestions = document.getElementById('patientSuggestions');
        const patientIdField = document.getElementById('form_patient');
        const display = document.getElementById('selectedPatient');

        searchInput.addEventListener('keyup', function () {
            const query = this.value;
            if (query.length < 2) {
                suggestions.innerHTML = '';
                return;
            }

            fetch(`/patient-search/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    suggestions.innerHTML = '';
                    data.results.forEach(patient => {
                        const item = document.createElement('a');
                        item.classList.add('list-group-item', 'list-group-item-action');
                        item.textContent = `${patient.full_name} (ID: ${patient.id})`;
                        item.href = "#";
                        item.onclick = function (e) {
                            e.preventDefault();
                            searchInput.value = patient.full_name;
                            suggestions.innerHTML = '';
                            display.textContent = `Selected Patient: ${patient.full_name}`;
                            display.style.display = 'block';
                            patientIdField.value = patient.id;
                        };
                        suggestions.appendChild(item);
                    });
                });
        });

        document.addEventListener('click', function (e) {
            if (!searchInput.contains(e.target)) {
                suggestions.innerHTML = '';
            }
        });
    });
</script>

{% endblock %} {% endcomment %}