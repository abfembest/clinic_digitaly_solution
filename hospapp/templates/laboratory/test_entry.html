{% extends "laboratory/base.html" %}
{% load static %}

{% block title %}HMS | Lab Test Entry{% endblock %}

{% block content %}
<!-- Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">Lab Test Entry</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'laboratory' %}">Laboratory</a></li>
                    <li class="breadcrumb-item active">Test Entry</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Success/Error Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}
        
        <!-- Statistics Cards -->
        <div class="row mb-3">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ stats.total_patients }}</h3>
                        <p>Total Patients</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        {%if stats.total_pending_tests%}
                        <h3>{{ stats.total_pending_tests }}</h3>
                        {%else%}
                        <h3>0</h3>
                        <p>Pending Tests</p>
                        {%endif%}
                    </div>
                    <div class="icon">
                        <i class="fas fa-file-medical"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        {%if stats.total_completed_today%}
                        <h3>{{ stats.total_completed_today }}</h3>
                        {%else%}
                        <h3>0</h3>
                        <p>Completed Today</p>                        
                        {%endif%}
                    </div>
                    <div class="icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-secondary">
                    <div class="inner">
                        {%if stats.total_completed_today%}
                        <h3>{{ stats.total_in_progress}}</h3>
                        {%else%}
                        <h3>0</h3>
                        <p>In Progress</p>
                        {%endif%}                      
                    </div>
                    <div class="icon">
                        <i class="fas fa-flask"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Overview Cards -->
        {% if category_overview %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="card card-outline card-info">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-layer-group"></i> Test Categories Overview
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for cat_data in category_overview %}
                            <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-primary"><i class="fas fa-vial"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">{{ cat_data.category.name }}</span>
                                        <span class="info-box-number">{{ cat_data.total_tests }} tests</span>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" style="width: {% widthratio cat_data.pending_tests cat_data.total_tests 100 %}%"></div>
                                        </div>
                                        <span class="progress-description">
                                            {{ cat_data.pending_tests }} pending, {{ cat_data.completed_tests }} completed
                                        </span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- All Patients Table -->
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users"></i> All Patients - Lab Test Management
                </h3>
                <div class="card-tools">
                    <div class="input-group input-group-sm" style="width: 300px;">
                        <input type="text" id="patientSearch" class="form-control" placeholder="Search by patient name...">
                        <div class="input-group-append">
                            <button type="button" class="btn btn-default">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped table-sm">
                        <thead class="thead-light">
                            <tr>
                                <th>Patient ID</th>
                                <th>Patient Info</th>
                                <th>Contact</th>
                                <th>Test Summary</th>
                                <th>Categories</th>
                                <th>Recommended By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTableBody">
                            {% for patient_data in patients_data %}
                            <tr data-patient-name="{{ patient_data.patient.full_name|lower }}">
                                <td>
                                    <span class="badge badge-secondary">{{ patient_data.patient.id }}</span>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ patient_data.patient.full_name }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {{ patient_data.patient.gender }} • 
                                            {{ patient_data.patient.date_of_birth|date:"M d, Y" }} •
                                            {{ patient_data.patient.blood_group|default:"N/A" }}
                                        </small>
                                        {% if patient_data.patient.is_inpatient %}
                                            <br><span class="badge badge-info">Inpatient</span>
                                            {% if patient_data.patient.ward %}
                                                <small class="text-muted">{{ patient_data.patient.ward.name }}</small>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <small>
                                        <i class="fas fa-phone"></i> {{ patient_data.patient.phone|default:"N/A" }}
                                        <br>
                                        <i class="fas fa-map-marker-alt"></i> {{ patient_data.patient.address|truncatechars:30|default:"N/A" }}
                                    </small>
                                </td>
                                <!--<td>
                                    <span class="badge badge-{% if patient_data.patient.status == 'critical' %}danger{% elif patient_data.patient.status == 'stable' %}success{% else %}warning{% endif %}">
                                        
                                    </span>
                                </td>-->
                                <td>
                                    <div class="d-flex flex-column">
                                        {% if patient_data.pending_count > 0 %}
                                            <span class="badge badge-warning mb-1">{{ patient_data.pending_count }} Pending</span>
                                        {% endif %}
                                        {% if patient_data.in_progress_count > 0 %}
                                            <span class="badge badge-info mb-1">{{ patient_data.in_progress_count }} In Progress</span>
                                        {% endif %}
                                        {% if patient_data.completed_count > 0 %}
                                            <span class="badge badge-success mb-1">{{ patient_data.completed_count }} Completed</span>
                                        {% endif %}
                                        {% if patient_data.total_tests == 0 %}
                                            <span class="text-muted">No tests</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if patient_data.categories %}
                                        {% for category in patient_data.categories %}
                                            <span class="badge badge-outline mb-1">{{ category.name }}</span>
                                            {% if not forloop.last %}<br>{% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <small class="text-muted">No categories</small>
                                    {% endif %}
                                </td>
                                
                                <td>
                                    <small class="text-muted">{{ patient_data.referred_by|default:"Walk-in" }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group" title="Open test deatails"">
                                        <a href="{% url 'test_details' patient_data.patient.id %}" class="btn btn-primary">
                                          <i class="fas fa-eye"></i>
                                        </a>
                                        <!--<button class="btn btn-primary view-tests"
                                                data-patient-id="{{ patient_data.patient.id }}"
                                                data-patient-name="{{ patient_data.patient.full_name }}"
                                                title="View All Tests">
                                            <i class="fas fa-eye"></i>
                                        </button>-->
                                        <button class="btn btn-success create-test"
                                                data-patient-id="{{ patient_data.patient.id }}"
                                                data-patient-name="{{ patient_data.patient.full_name }}"
                                                title="Create New Test">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        {% if patient_data.pending_count > 0 %}
                                        <button class="btn btn-warning quick-complete"
                                                data-patient-id="{{ patient_data.patient.id }}"
                                                data-patient-name="{{ patient_data.patient.full_name }}"
                                                title="Complete Pending Tests">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                                        <br>
                                        No patients with lab tests found
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Quick Test Entry Section for Pending Tests -->
        {% if pending_tests_by_category %}
        <div class="card card-outline card-warning mt-4">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-clock"></i> Quick Test Entry - Pending Tests by Category
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for category_name, cat_data in pending_tests_by_category.items %}
                    <div class="col-lg-6 col-md-12 mb-3">
                        <div class="card card-outline card-warning">
                            <div class="card-header">
                                <h5 class="card-title">
                                    {{ cat_data.category.name }} 
                                    <span class="badge badge-warning">{{ cat_data.count }} tests</span>
                                </h5>
                            </div>
                            <div class="card-body p-2">
                                {% for test in cat_data.tests %}
                                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                    <div>
                                        <strong>{{ test.patient.full_name }}</strong><br>
                                        <small class="text-muted">{{ test.test_name }}</small>
                                    </div>
                                    <button class="btn btn-sm btn-warning complete-test-direct" 
                                            data-test-id="{{ test.id }}"
                                            data-test-name="{{ test.test_name }}"
                                            data-patient-name="{{ test.patient.full_name }}">
                                        <i class="fas fa-check"></i> Complete
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Patient Tests Modal -->
        <div class="modal fade" id="patientTestsModal" tabindex="-1" role="dialog" aria-labelledby="patientTestsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-primary">
                        <h5 class="modal-title text-white" id="patientTestsModalLabel">
                            <i class="fas fa-flask"></i> Lab Tests for <span id="patientName"></span>
                        </h5>
                        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Loading spinner -->
                        <div id="loading" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>Loading patient data...</p>
                        </div>
                        
                        <!-- Patient Info -->
                        <div class="row mb-3" id="patientInfoSection" style="display: none;">
                            <div class="col-md-12">
                                <div class="card card-outline card-info">
                                    <div class="card-header">
                                        <h3 class="card-title">Patient Information</h3>
                                    </div>
                                    <div class="card-body" id="patientInfo">
                                        <!-- Patient details will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pending Tests -->
                        <div id="pendingTestsContainer" style="display: none;">
                            <h6 class="text-warning mb-3">
                                <i class="fas fa-hourglass-half"></i> Pending Tests
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm table-striped">
                                    <thead class="thead-warning">
                                        <tr>
                                            <th>Test Name</th>
                                            <th>Category</th>
                                            <th>Requested By</th>
                                            <th>Date Requested</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pendingTestsBody">
                                        <!-- Test rows dynamically loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- In Progress Tests -->
                        <div id="inProgressTestsContainer" style="display: none;">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-flask"></i> In Progress Tests
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm table-striped">
                                    <thead class="thead-info">
                                        <tr>
                                            <th>Test Name</th>
                                            <th>Category</th>
                                            <th>Started By</th>
                                            <th>Date Started</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inProgressTestsBody">
                                        <!-- In progress test rows dynamically loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Completed Tests -->
                        <div id="completedTestsContainer" class="mt-4" style="display: none;">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-check-circle"></i> Completed Tests
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm table-striped">
                                    <thead class="thead-success">
                                        <tr>
                                            <th>Test Name</th>
                                            <th>Category</th>
                                            <th>Completed By</th>
                                            <th>Date Completed</th>
                                            <th>Result Summary</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="completedTestsBody">
                                        <!-- Completed test rows dynamically loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" id="createTestBtn">
                            <i class="fas fa-plus"></i> Create New Test
                        </button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Test Modal -->
        <div class="modal fade" id="createTestModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-success">
                        <h5 class="modal-title text-white">
                            <i class="fas fa-plus"></i> Create New Lab Test
                        </h5>
                        <button type="button" class="close text-white" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <form id="createTestForm">
                        <div class="modal-body">
                            <input type="hidden" id="createTestPatientId" name="patient_id">
                            
                            <div class="form-group">
                                <label>Patient</label>
                                <input type="text" class="form-control" id="createTestPatientName" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="testName">Test Name *</label>
                                <input type="text" class="form-control" id="testName" name="test_name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="testCategory">Category</label>
                                <select class="form-control" id="testCategory" name="category_id">
                                    <option value="">Select Category</option>
                                    {% for category in test_categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="normalRange">Normal Range</label>
                                <input type="text" class="form-control" id="normalRange" name="normal_range" placeholder="e.g., 70-100 mg/dL">
                            </div>
                            
                            <div class="form-group">
                                <label for="testInstructions">Instructions</label>
                                <textarea class="form-control" id="testInstructions" name="instructions" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Create Test
                            </button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Complete Test Modal -->
        <div class="modal fade" id="completeTestModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title">
                            <i class="fas fa-check"></i> Complete Lab Test
                        </h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <form id="completeTestForm" method="post">
                        {% csrf_token %}
                        <div class="modal-body">
                            <input type="hidden" id="completeTestId" name="test_id">
                            
                            <div class="form-group">
                                <label>Test Name</label>
                                <input type="text" class="form-control" id="completeTestName" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="testResult">Test Result *</label>
                                <textarea class="form-control" id="testResult" name="result_value" rows="4" required placeholder="Enter test results..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="testNotes">Additional Notes</label>
                                <textarea class="form-control" id="testNotes" name="notes" rows="2" placeholder="Optional notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-check"></i> Complete Test
                            </button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</section>
{% endblock %}

<!-- Scripts -->
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CSRF Token setup
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Patient Search Filter
    const searchInput = document.getElementById('patientSearch');
    const tableBody = document.getElementById('patientsTableBody');

    searchInput.addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        Array.from(tableBody.querySelectorAll('tr')).forEach(row => {
            const patientName = row.getAttribute('data-patient-name') || '';
            row.style.display = patientName.includes(filter) ? '' : 'none';
        });
    });

    // Modal references
    const testModal = $('#patientTestsModal');
    const createModal = $('#createTestModal');
    const completeModal = $('#completeTestModal');
    
    let currentPatientId = null;

    // Function to fetch patient tests via AJAX
    function fetchPatientTests(patientId) {
        currentPatientId = patientId;
        
        // Show loading, hide content
        document.getElementById('loading').style.display = 'block';
        document.getElementById('patientInfoSection').style.display = 'none';
        document.getElementById('pendingTestsContainer').style.display = 'none';
        document.getElementById('inProgressTestsContainer').style.display = 'none';
        document.getElementById('completedTestsContainer').style.display = 'none';

        fetch(`/laboratory/patient_tests/${patientId}/`, {
            headers: {
                'X-CSRFToken': csrftoken,
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            // Update patient info section
            const patientInfo = document.getElementById('patientInfo');
            patientInfo.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <strong>Name:</strong> ${data.patient.full_name}<br>
                        <strong>ID:</strong> ${data.patient.id}<br>
                        <strong>Gender:</strong> ${data.patient.gender}
                    </div>
                    <div class="col-md-4">
                        <strong>DOB:</strong> ${data.patient.date_of_birth}<br>
                        <strong>Blood Group:</strong> ${data.patient.blood_group}<br>
                        <strong>Phone:</strong> ${data.patient.phone || 'N/A'}
                    </div>
                    <div class="col-md-4">
                        <strong>Status:</strong> <span class="badge badge-${data.patient.status === 'critical' ? 'danger' : data.patient.status === 'stable' ? 'success' : 'warning'}">${data.patient.status}</span><br>
                        <strong>Address:</strong> ${data.patient.address || 'N/A'}<br>
                        ${data.patient.is_inpatient ? `<strong>Ward:</strong> ${data.patient.ward || 'N/A'}` : ''}
                    </div>
                </div>
            `;
            document.getElementById('patientInfoSection').style.display = 'block';

            // Update pending tests
            const pendingTestsBody = document.getElementById('pendingTestsBody');
            if (data.pending_tests && data.pending_tests.length > 0) {
                pendingTestsBody.innerHTML = data.pending_tests.map(test => `
                    <tr>
                        <td>${test.test_name}</td>
                        <td>${test.category || 'N/A'}</td>
                        <td>${test.requested_by || 'N/A'}</td>
                        <td>${test.requested_at}</td>
                        <td><span class="badge badge-warning">Pending</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning complete-test-btn" data-test-id="${test.id}" data-test-name="${test.test_name}">
                                <i class="fas fa-check"></i> Complete
                            </button>
                            <button class="btn btn-sm btn-info view-test-btn" data-test-id="${test.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('pendingTestsContainer').style.display = 'block';
            }

            // Update in progress tests
            const inProgressTestsBody = document.getElementById('inProgressTestsBody');
            if (data.in_progress_tests && data.in_progress_tests.length > 0) {
                inProgressTestsBody.innerHTML = data.in_progress_tests.map(test => `
                    <tr>
                        <td>${test.test_name}</td>
                        <td>${test.category || 'N/A'}</td>
                        <td>${test.started_by || 'N/A'}</td>
                        <td>${test.started_at}</td>
                        <td><span class="badge badge-info">In Progress</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning complete-test-btn" data-test-id="${test.id}" data-test-name="${test.test_name}">
                                <i class="fas fa-check"></i> Complete
                            </button>
                            <button class="btn btn-sm btn-info view-test-btn" data-test-id="${test.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('inProgressTestsContainer').style.display = 'block';
            }

            // Update completed tests
            const completedTestsBody = document.getElementById('completedTestsBody');
            if (data.completed_tests && data.completed_tests.length > 0) {
                completedTestsBody.innerHTML = data.completed_tests.map(test => `
                    <tr>
                        <td>${test.test_name}</td>
                        <td>${test.category || 'N/A'}</td>
                        <td>${test.completed_by || 'N/A'}</td>
                        <td>${test.completed_at}</td>
                        <td>${test.result_value ? test.result_value.substring(0, 50) + '...' : 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-success view-test-btn" data-test-id="${test.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-primary print-test-btn" data-test-id="${test.id}">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('completedTestsContainer').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error fetching patient tests:', error);
            document.getElementById('loading').style.display = 'none';
            alert('Error loading patient data. Please try again.');
        });
    }

    // View Tests Button Click Handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.view-tests')) {
            const btn = e.target.closest('.view-tests');
            const patientId = btn.getAttribute('data-patient-id');
            const patientName = btn.getAttribute('data-patient-name');
            
            document.getElementById('patientName').textContent = patientName;
            fetchPatientTests(patientId);
            testModal.modal('show');
        }
    });

    // Create Test Button Click Handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.create-test')) {
            const btn = e.target.closest('.create-test');
            const patientId = btn.getAttribute('data-patient-id');
            const patientName = btn.getAttribute('data-patient-name');
            
            document.getElementById('createTestPatientId').value = patientId;
            document.getElementById('createTestPatientName').value = patientName;
            createModal.modal('show');
        }
    });

    // Create Test from Modal Button
    document.getElementById('createTestBtn').addEventListener('click', function() {
        if (currentPatientId) {
            const patientName = document.getElementById('patientName').textContent;
            document.getElementById('createTestPatientId').value = currentPatientId;
            document.getElementById('createTestPatientName').value = patientName;
            testModal.modal('hide');
            createModal.modal('show');
        }
    });

    // Complete Test Button Click Handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.complete-test-btn') || e.target.closest('.complete-test-direct')) {
            const btn = e.target.closest('.complete-test-btn') || e.target.closest('.complete-test-direct');
            const testId = btn.getAttribute('data-test-id');
            const testName = btn.getAttribute('data-test-name');
            
            document.getElementById('completeTestId').value = testId;
            document.getElementById('completeTestName').value = testName;
            completeModal.modal('show');
        }
    });

    // Quick Complete Button Click Handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.quick-complete')) {
            const btn = e.target.closest('.quick-complete');
            const patientId = btn.getAttribute('data-patient-id');
            const patientName = btn.getAttribute('data-patient-name');
            
            if (confirm(`Complete all pending tests for ${patientName}?`)) {
                fetch(`/laboratory/quick_complete_tests/${patientId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error completing tests: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error completing tests. Please try again.');
                });
            }
        }
    });

    // Create Test Form Submit Handler
    document.getElementById('createTestForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        fetch('/laboratory/create_test/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createModal.modal('hide');
                this.reset();
                
                // Refresh the patient tests modal if open
                if (currentPatientId) {
                    fetchPatientTests(currentPatientId);
                } else {
                    location.reload();
                }
                
                // Show success message
                showAlert('Test created successfully!', 'success');
            } else {
                alert('Error creating test: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating test. Please try again.');
        });
    });

    // Complete Test Form Submit Handler
    document.getElementById('completeTestForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        fetch('/laboratory/complete_test/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                completeModal.modal('hide');
                this.reset();
                
                // Refresh the patient tests modal if open
                if (currentPatientId) {
                    fetchPatientTests(currentPatientId);
                } else {
                    location.reload();
                }
                
                showAlert('Test completed successfully!', 'success');
            } else {
                alert('Error completing test: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error completing test. Please try again.');
        });
    });

    // View Test Details Handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.view-test-btn')) {
            const btn = e.target.closest('.view-test-btn');
            const testId = btn.getAttribute('data-test-id');
            
            fetch(`/laboratory/test_details/${testId}/`, {
                headers: {
                    'X-CSRFToken': csrftoken,
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showTestDetailsModal(data.test);
                } else {
                    alert('Error loading test details');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading test details');
            });
        }
    });

    // Print Test Handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.print-test-btn')) {
            const btn = e.target.closest('.print-test-btn');
            const testId = btn.getAttribute('data-test-id');
            
            window.open(`/laboratory/print_test/${testId}/`, '_blank');
        }
    });

    // Utility function to show alerts
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        `;
        
        const container = document.querySelector('.container-fluid');
        const firstChild = container.firstChild;
        container.insertBefore(alertDiv, firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Function to show test details in a modal
    function showTestDetailsModal(test) {
        const modalContent = `
            <div class="modal fade" id="testDetailsModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-info">
                            <h5 class="modal-title text-white">
                                <i class="fas fa-flask"></i> Test Details
                            </h5>
                            <button type="button" class="close text-white" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Test Name:</strong> ${test.test_name}<br>
                                    <strong>Category:</strong> ${test.category || 'N/A'}<br>
                                    <strong>Patient:</strong> ${test.patient_name}<br>
                                    <strong>Status:</strong> <span class="badge badge-${test.status === 'completed' ? 'success' : test.status === 'in_progress' ? 'info' : 'warning'}">${test.status}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Requested:</strong> ${test.requested_at}<br>
                                    <strong>Requested By:</strong> ${test.requested_by || 'N/A'}<br>
                                    ${test.completed_at ? `<strong>Completed:</strong> ${test.completed_at}<br>` : ''}
                                    ${test.completed_by ? `<strong>Completed By:</strong> ${test.completed_by}<br>` : ''}
                                </div>
                            </div>
                            ${test.normal_range ? `<hr><strong>Normal Range:</strong> ${test.normal_range}` : ''}
                            ${test.result_value ? `<hr><strong>Result:</strong><br><div class="border p-2 bg-light">${test.result_value}</div>` : ''}
                            ${test.notes ? `<hr><strong>Notes:</strong><br><div class="border p-2 bg-light">${test.notes}</div>` : ''}
                            ${test.instructions ? `<hr><strong>Instructions:</strong><br><div class="border p-2 bg-light">${test.instructions}</div>` : ''}
                        </div>
                        <div class="modal-footer">
                            ${test.status === 'completed' ? `<button type="button" class="btn btn-primary" onclick="window.open('/laboratory/print_test/${test.id}/', '_blank')"><i class="fas fa-print"></i> Print</button>` : ''}
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('testDetailsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add new modal to body
        document.body.insertAdjacentHTML('beforeend', modalContent);
        $('#testDetailsModal').modal('show');
        
        // Remove modal from DOM when hidden
        $('#testDetailsModal').on('hidden.bs.modal', function() {
            this.remove();
        });
    }

    // Clear form fields when modals are hidden
    createModal.on('hidden.bs.modal', function() {
        document.getElementById('createTestForm').reset();
    });
    
    completeModal.on('hidden.bs.modal', function() {
        document.getElementById('completeTestForm').reset();
    });

    // Auto-refresh page every 5 minutes to keep data current
    setInterval(function() {
        if (!testModal.hasClass('show') && !createModal.hasClass('show') && !completeModal.hasClass('show')) {
            location.reload();
        }
    }, 300000); // 5 minutes

    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Initialize any additional Bootstrap components
    $('.alert').alert();
});
</script>
{% endblock %}