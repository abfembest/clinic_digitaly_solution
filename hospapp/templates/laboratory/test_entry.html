{% extends "laboratory/base.html" %}
{% load static %}

{% block title %}HMS | Lab Test Entry{% endblock %}

{% block content %}
<!-- Header -->
<section class="content-header">
    <div class="container-fluid">
        <h1 class="m-0 text-dark">Lab Test Entry</h1>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Success/Error Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}
        
        <!-- Debug Info (will be removed in production) -->
        {% if debug_info %}
        <div class="card card-outline card-warning mb-3">
            <div class="card-header">
                <h3 class="card-title">Debug Information</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <p><strong>Lab Departments:</strong> {{ debug_info.lab_departments|default:"None" }}</p>
                <p><strong>Referral Count:</strong> {{ debug_info.referral_count }}</p>
                <p><strong>Pending Test Selections:</strong> {{ debug_info.test_selections }}</p>
                <p><strong>Patients with Tests:</strong> {{ debug_info.patients_with_tests }}</p>
            </div>
        </div>
        {% endif %}
        
        <!-- Referred Patients Table -->
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title">Patients Referred to Lab</h3>
                <div class="card-tools">
                    <div class="input-group input-group-sm" style="width: 250px;">
                        <input type="text" id="patientSearch" class="form-control" placeholder="Search patient...">
                        <div class="input-group-append">
                            <button type="button" class="btn btn-default">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Patient Name</th>
                                <th>Referred By</th>
                                <th>Date Referred</th>
                                <th>Pending Tests</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTableBody">
                            {% for referral in referrals %}
                            <tr>
                                <td>{{ referral.patient.id }}</td>
                                <td>{{ referral.patient.full_name }}</td>
                                <td>{{ referral.referred_by|default:"Unknown" }}</td>
                                <td>{{ referral.created_at|date:"M d, Y" }}</td>
                                <td>
                                    <span class="badge badge-info">{{ referral.pending_tests }} tests</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary view-tests" data-patient-id="{{ referral.patient.id }}">
                                        <i class="fas fa-flask"></i> View Tests
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No patients referred to lab</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Patient Tests Modal -->
        <div class="modal fade" id="patientTestsModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Lab Tests for <span id="patientName"></span></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="debugInfo" class="alert alert-info mb-3" style="display: none;"></div>
                        
                        <div id="pendingTestsContainer">
                            <h6 class="text-primary">Pending Tests</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm">
                                    <thead>
                                        <tr>
                                            <th>Test</th>
                                            <th>Category</th>
                                            <th>Requested By</th>
                                            <th>Date</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pendingTestsTableBody">
                                        <!-- Pending tests will be loaded here -->
                                        <tr>
                                            <td colspan="5" class="text-center">Loading tests...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Entry Modal -->
        <div class="modal fade" id="testEntryModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <form id="testEntryForm" method="post" action="{% url 'submit_lab_test' %}">
                        {% csrf_token %}
                        <input type="hidden" name="patient_id" id="testPatientId">
                        <input type="hidden" name="test_selection_id" id="testSelectionId">
                        
                        <div class="modal-header">
                            <h5 class="modal-title">Enter Results: <span id="testName"></span></h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Result Value</label>
                                        <input type="text" class="form-control" name="result_value" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Normal Range</label>
                                        <input type="text" class="form-control" name="normal_range" placeholder="e.g. 12-20 mg/dL">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Additional Notes</label>
                                <textarea class="form-control" name="notes" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Results</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Patient search functionality
    const patientSearch = document.getElementById('patientSearch');
    patientSearch.addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#patientsTableBody tr');
        
        rows.forEach(row => {
            const patientName = row.cells[1]?.textContent.toLowerCase() || '';
            if (patientName.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // View tests button click handler
    const viewTestsButtons = document.querySelectorAll('.view-tests');
    viewTestsButtons.forEach(button => {
        button.addEventListener('click', function() {
            const patientId = this.dataset.patientId;
            const patientName = this.closest('tr').cells[1].textContent;
            
            // Set patient name in modal
            document.getElementById('patientName').textContent = patientName;
            
            // Load pending tests for this patient
            loadPendingTests(patientId);
            
            // Show the modal
            $('#patientTestsModal').modal('show');
        });
    });
    
    // Load pending tests for a patient
    function loadPendingTests(patientId) {
        const pendingTestsTableBody = document.getElementById('pendingTestsTableBody');
        pendingTestsTableBody.innerHTML = '<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading tests...</td></tr>';
        
        fetch(`/get-pending-tests/?patient_id=${patientId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Show debug info
                const debugInfo = document.getElementById('debugInfo');
                if (data.debug) {
                    debugInfo.style.display = 'block';
                    debugInfo.innerHTML = `
                        <strong>Debug:</strong> Patient ID: ${data.debug.patient_id}, 
                        Test Count: ${data.debug.test_count || 0}
                        ${data.debug.test_fields ? '<br>Fields: ' + data.debug.test_fields.join(', ') : ''}
                        ${data.error ? '<br>Error: ' + data.error : ''}
                    `;
                } else {
                    debugInfo.style.display = 'none';
                }
                
                if (!data.tests || data.tests.length === 0) {
                    pendingTestsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No pending tests found</td></tr>';
                    return;
                }
                
                pendingTestsTableBody.innerHTML = '';
                data.tests.forEach(test => {
                    const row = document.createElement('tr');
                    
                    // Format date
                    let formattedDate = 'N/A';
                    if (test.submitted_on) {
                        try {
                            const testDate = new Date(test.submitted_on);
                            formattedDate = testDate.toLocaleDateString();
                        } catch (e) {
                            formattedDate = test.submitted_on;
                        }
                    }
                    
                    row.innerHTML = `
                        <td>${test.test_name || 'Unknown Test'}</td>
                        <td>${test.category || 'Uncategorized'}</td>
                        <td>${test.doctor_name || 'Unknown'}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="btn btn-sm btn-success enter-results" 
                                data-patient-id="${patientId}"
                                data-test-id="${test.id}"
                                data-test-name="${test.test_name || 'Unknown Test'}"
                                data-test-category="${test.category || 'Uncategorized'}">
                                <i class="fas fa-edit"></i> Enter Results
                            </button>
                        </td>
                    `;
                    
                    pendingTestsTableBody.appendChild(row);
                });
                
                // Add click handlers for enter results buttons
                setupEnterResultsButtons();
            })
            .catch(error => {
                console.error('Error loading pending tests:', error);
                pendingTestsTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            Error loading tests: ${error.message || 'Unknown error'}
                        </td>
                    </tr>
                `;
                
                // Show error in debug info
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.style.display = 'block';
                debugInfo.innerHTML = `
                    <strong>Error:</strong> ${error.message || 'Unknown error'}<br>
                    <strong>Patient ID:</strong> ${patientId}
                `;
            });
    }
    
    // Setup enter results buttons
    function setupEnterResultsButtons() {
        const enterResultsButtons = document.querySelectorAll('.enter-results');
        enterResultsButtons.forEach(button => {
            button.addEventListener('click', function() {
                const patientId = this.dataset.patientId;
                const testId = this.dataset.testId;
                const testName = this.dataset.testName;
                const testCategory = this.dataset.testCategory;
                
                // Set values in the test entry form
                document.getElementById('testPatientId').value = patientId;
                document.getElementById('testSelectionId').value = testId;
                document.getElementById('testName').textContent = `${testCategory} - ${testName}`;
                
                // Hide the tests modal and show the entry modal
                $('#patientTestsModal').modal('hide');
                $('#testEntryModal').modal('show');
            });
        });
    }
    
    // Form submission with AJAX
    const testEntryForm = document.getElementById('testEntryForm');
    testEntryForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Show loading state
        const submitBtn = testEntryForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Close the modal
            $('#testEntryModal').modal('hide');
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${data.status} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${data.message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            `;
            
            // Insert the alert at the top of the content
            const contentSection = document.querySelector('.content');
            contentSection.insertBefore(alertDiv, contentSection.firstChild);
            
            // Refresh the patient's tests if the modal is still open
            const patientId = formData.get('patient_id');
            if ($('#patientTestsModal').hasClass('show')) {
                loadPendingTests(patientId);
            }
            
            // Reset form
            testEntryForm.reset();
            
            // Auto-dismiss the alert after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the test results: ' + (error.message || 'Unknown error'));
        })
        .finally(() => {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        });
    });
});
</script>
{% endblock %}
