{% extends "hr/base.html" %}

{% block title %}HMS | Staff Profiles{% endblock %}

{% block content %}

<!-- Content Header (Page header) -->
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0 text-dark">Staff Profiles</h1>
      </div>
    </div>
  </div>
</div>
<!-- /.content-header -->

<section class="content">
  <div class="container-fluid">
    <div class="card card-outline card-primary">
      <div class="card-header">
        <h3 class="card-title">Staff Records</h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-sm">
            <thead class="thead-light">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Name</th>
                <th scope="col">Role</th>
                <th scope="col">Department</th>
                <th scope="col">Phone</th>
                <th scope="col">Email</th>
                <th scope="col">Gender</th>
                <th scope="col">Date Joined</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for staff in staff_list %}
              <tr data-staff-id="{{ staff.id }}">
                <th scope="row">{{ forloop.counter }}</th>
                <td class="staff-name">{{ staff.user.first_name }} {{ staff.user.last_name }}</td>
                <td class="staff-role">{{ staff.get_role_display }}</td>
                <td class="staff-department">{% if staff.department %}{{ staff.department.name }}{% else %}&mdash;{% endif %}</td>
                <td class="staff-phone">{{ staff.phone_number|default:"&mdash;" }}</td>
                <td class="staff-email">{{ staff.user.email|default:"&mdash;" }}</td>
                <td class="staff-gender">{{ staff.get_gender_display }}</td>
                <td class="staff-date-joined">{{ staff.date_joined|date:"M d, Y" }}</td>
                <td>
                  <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#editStaffModal{{ staff.id }}" aria-label="Edit {{ staff.user.first_name }} {{ staff.user.last_name }}">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button type="button" class="btn btn-sm btn-warning" data-toggle="modal" data-target="#changePasswordModal{{ staff.id }}" aria-label="Change Password for {{ staff.user.first_name }} {{ staff.user.last_name }}">
                    <i class="fas fa-key"></i> Password
                  </button>
                </td>
              </tr>

              <!-- Edit Staff Modal -->
              <div class="modal fade" id="editStaffModal{{ staff.id }}" tabindex="-1" aria-labelledby="editStaffModalLabel{{ staff.id }}" aria-hidden="true">
                <div class="modal-dialog">
                  <form method="post" action="{% url 'edit_staff_profile' staff.id %}" class="edit-staff-form">
                    {% csrf_token %}
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="editStaffModalLabel{{ staff.id }}">Edit Staff: {{ staff.user.first_name }} {{ staff.user.last_name }}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <div class="mb-3">
                          <label for="role{{ staff.id }}" class="form-label">Role</label>
                          <select name="role" class="form-control" id="role{{ staff.id }}" required>
                            <option value="">Select Role</option>
                            <option value="receptionist" {% if staff.role == 'receptionist' %}selected{% endif %}>Receptionist</option>
                            <option value="nurse" {% if staff.role == 'nurse' %}selected{% endif %}>Nurse</option>
                            <option value="doctor" {% if staff.role == 'doctor' %}selected{% endif %}>Doctor</option>
                            <option value="lab" {% if staff.role == 'lab' %}selected{% endif %}>Lab Technician</option>
                            <option value="admin" {% if staff.role == 'admin' %}selected{% endif %}>Administrator</option>
                            <option value="pharmacy" {% if staff.role == 'pharmacy' %}selected{% endif %}>Pharmacy</option>
                            <option value="hr" {% if staff.role == 'hr' %}selected{% endif %}>HR</option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label for="department{{ staff.id }}" class="form-label">Department</label>
                          <select name="department" id="department{{ staff.id }}" class="form-control" required>
                            <option value="">Select Department</option>
                            {% for dept in departments %}
                              <option value="{{ dept.id }}" {% if staff.department and dept.id == staff.department.id %}selected{% endif %}>{{ dept.name }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="mb-3">
                          <label for="phone{{ staff.id }}" class="form-label">Phone Number</label>
                          <input type="text" name="phone_number" class="form-control" id="phone{{ staff.id }}" value="{{ staff.phone_number }}" maxlength="15" />
                        </div>
                        <div class="mb-3">
                          <label for="address{{ staff.id }}" class="form-label">Address</label>
                          <textarea name="address" class="form-control" id="address{{ staff.id }}" rows="3">{{ staff.address }}</textarea>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Change Password Modal -->
              <div class="modal fade" id="changePasswordModal{{ staff.id }}" tabindex="-1" aria-labelledby="changePasswordModalLabel{{ staff.id }}" aria-hidden="true">
                <div class="modal-dialog">
                  <form method="post" action="{% url 'change_staff_password' staff.id %}" class="change-password-form">
                    {% csrf_token %}
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="changePasswordModalLabel{{ staff.id }}">Change Password: {{ staff.user.first_name }} {{ staff.user.last_name }}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <div class="mb-3">
                          <label for="new_password{{ staff.id }}" class="form-label">New Password</label>
                          <input type="password" name="new_password" class="form-control" id="new_password{{ staff.id }}" required autocomplete="new-password" minlength="8" />
                          <div class="form-text">Password must be at least 8 characters long.</div>
                        </div>
                        <div class="mb-3">
                          <label for="confirm_password{{ staff.id }}" class="form-label">Confirm Password</label>
                          <input type="password" name="confirm_password" class="form-control" id="confirm_password{{ staff.id }}" required autocomplete="new-password" />
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Change Password</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              {% empty %}
              <tr>
                <td colspan="9" class="text-center text-muted">No staff found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Handle all edit staff forms via AJAX
  document.querySelectorAll('.edit-staff-form').forEach(form => {
    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const url = this.action;
      const formData = new FormData(this);
      const staffId = this.closest('.modal').id.replace('editStaffModal', '');

      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const row = document.querySelector(`tr[data-staff-id="${staffId}"]`);
          row.querySelector('.staff-role').textContent = data.role;
          row.querySelector('.staff-department').textContent = data.department;
          row.querySelector('.staff-phone').textContent = data.phone;
          row.querySelector('.staff-name').textContent = data.name;

          // Close modal
          $(`#editStaffModal${staffId}`).modal('hide');
        } else {
          alert('Update failed: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the staff.');
      });
    });
  });

  // Handle password change via AJAX
  document.querySelectorAll('.change-password-form').forEach(form => {
    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const url = this.action;
      const formData = new FormData(this);
      const staffId = this.closest('.modal').id.replace('changePasswordModal', '');

      const pwd = formData.get('new_password');
      const confirmPwd = formData.get('confirm_password');

      if (pwd !== confirmPwd) {
        alert("Passwords do not match.");
        return;
      }

      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          $(`#changePasswordModal${staffId}`).modal('hide');
          alert('Password changed successfully.');
        } else {
          alert('Password change failed: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while changing password.');
      });
    });
  });
});
</script>

{% endblock %}