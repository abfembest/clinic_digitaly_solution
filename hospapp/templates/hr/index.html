{% extends "hr/base.html" %}

{% block title %}HMS | HR Dashboard{% endblock %}

{% block content %}
<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">
                    <i class="fas fa-users-cog mr-2"></i>HR Dashboard
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'hr' %}">Home</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        
        <!-- Alert Section for Important HR Notifications -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                    <h5><i class="icon fas fa-info"></i> HR Notice</h5>
                    {{ pending_tasks_count }} pending approvals require your attention. 
                    {{ expiring_certs_count }} certifications expire within 30 days.
                </div>
            </div>
        </div>

        <!-- Key Metrics Row -->
        <div class="row">
            <!-- Total Staff -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-primary">
                    <div class="inner">
                        <h3>{{ total_staff }}</h3>
                        <p>Total Staff Members</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <a href="{% url 'staff_profiles' %}" class="small-box-footer">
                        View Details <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

            <!-- Present Today -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ present_today }}</h3>
                        <p>Present Today</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <a href="{% url 'staff_attendance_shift' %}" class="small-box-footer">
                        View Attendance <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

            <!-- On Leave -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ on_leave_today }}</h3>
                        <p>On Leave Today</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <a href="{% url 'staff_attendance_shift' %}" class="small-box-footer">
                        View Details <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

            <!-- New Hires (This Month) -->
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ new_hires_month }}</h3>
                        <p>New Hires (Month)</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <a href="{% url 'staff_transitions' %}" class="small-box-footer">
                        View Transitions <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Secondary Metrics Row -->
        <div class="row">
            <!-- Departments -->
            <div class="col-lg-3 col-6">
                <div class="info-box">
                    <span class="info-box-icon bg-gradient-primary">
                        <i class="fas fa-sitemap"></i>
                    </span>
                    <div class="info-box-content">
                        <span class="info-box-text">Active Departments</span>
                        <span class="info-box-number">{{ total_departments }}</span>
                    </div>
                </div>
            </div>

            <!-- Absent Today -->
            <div class="col-lg-3 col-6">
                <div class="info-box">
                    <span class="info-box-icon bg-gradient-danger">
                        <i class="fas fa-user-times"></i>
                    </span>
                    <div class="info-box-content">
                        <span class="info-box-text">Absent Today</span>
                        <span class="info-box-number">{{ absent_today }}</span>
                    </div>
                </div>
            </div>

            <!-- Recent Offboarding -->
            <div class="col-lg-3 col-6">
                <div class="info-box">
                    <span class="info-box-icon bg-gradient-warning">
                        <i class="fas fa-user-minus"></i>
                    </span>
                    <div class="info-box-content">
                        <span class="info-box-text">Offboarded (Month)</span>
                        <span class="info-box-number">{{ offboarded_month }}</span>
                    </div>
                </div>
            </div>

            <!-- Shift Assignments Today -->
            <div class="col-lg-3 col-6">
                <div class="info-box">
                    <span class="info-box-icon bg-gradient-success">
                        <i class="fas fa-clock"></i>
                    </span>
                    <div class="info-box-content">
                        <span class="info-box-text">Shift Assignments Today</span>
                        <span class="info-box-number">{{ shift_assignments_today }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Content -->
        <div class="row">
            <!-- Left Column - Charts and Analytics -->
            <div class="col-md-8">
                
                <!-- Department Distribution Chart -->
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie mr-1"></i>
                            Staff Distribution by Department
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="chart-responsive">
                                    <canvas id="departmentChart" height="150"></canvas>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <ul class="chart-legend clearfix">
                                    {% for dept in department_stats %}
                                    <li>
                                        <i class="far fa-circle" style="color: {{ dept.color }}"></i> {{ dept.name }}
                                        <span class="badge badge-light float-right">{{ dept.count }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Trends -->
                <div class="card card-success">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-line mr-1"></i>
                            Weekly Attendance Trends
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart">
                            <canvas id="attendanceChart" height="180" style="height: 180px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent HR Activities -->
                <div class="card">
                    <div class="card-header border-transparent">
                        <h3 class="card-title">
                            <i class="fas fa-history mr-1"></i>
                            Recent HR Activities
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table m-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Activity</th>
                                        <th>Staff Member</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transition in recent_transitions %}
                                    <tr>
                                        <td>{{ transition.date|date:"M d, Y" }}</td>
                                        <td>
                                            <i class="fas fa-{% if transition.transition_type == 'onboarding' %}user-plus text-success{% else %}user-minus text-danger{% endif %} mr-1"></i>
                                            {{ transition.get_transition_type_display }}
                                        </td>
                                        <td>{{ transition.full_name }}</td>
                                        <td>
                                            <span class="badge badge-{% if transition.transition_type == 'onboarding' %}success{% else %}warning{% endif %}">
                                                {{ transition.transition_type|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No recent activities</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer clearfix">
                        <a href="{% url 'staff_transitions' %}" class="btn btn-sm btn-info float-left">View All Transitions</a>
                    </div>
                </div>
            </div>

            <!-- Right Column - Quick Actions and Info -->
            <div class="col-md-4">
                
                <!-- Quick Actions -->
                <div class="card card-light">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bolt mr-1"></i>
                            Quick Actions
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <a href="{% url 'staff_profiles' %}" class="btn btn-app bg-primary btn-sm w-100">
                                    <i class="fas fa-user-tie"></i>
                                    Staff Profiles
                                </a>
                            </div>
                            <div class="col-6 mb-3">
                                <a href="{% url 'staff_attendance_shift' %}" class="btn btn-app bg-success btn-sm w-100">
                                    <i class="fas fa-clock"></i>
                                    Attendance
                                </a>
                            </div>
                            <div class="col-6 mb-3">
                                <a href="{% url 'staff_transitions' %}" class="btn btn-app bg-info btn-sm w-100">
                                    <i class="fas fa-exchange-alt"></i>
                                    Transitions
                                </a>
                            </div>
                            <div class="col-6 mb-3">
                                <a href="{% url 'staff_certifications' %}" class="btn btn-app bg-warning btn-sm w-100">
                                    <i class="fas fa-certificate"></i>
                                    Certifications
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Attendance Summary -->
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-calendar-day mr-1"></i>
                            Today's Attendance Summary
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="progress-group">
                            Present
                            <span class="float-right"><b>{{ present_today }}</b>/{{ total_staff }}</span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-success" style="width: {{ attendance_percentage }}%"></div>
                            </div>
                        </div>
                        <div class="progress-group">
                            On Leave
                            <span class="float-right"><b>{{ on_leave_today }}</b>/{{ total_staff }}</span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-warning" style="width: {{ leave_percentage }}%"></div>
                            </div>
                        </div>
                        <div class="progress-group">
                            Absent
                            <span class="float-right"><b>{{ absent_today }}</b>/{{ total_staff }}</span>
                            <div class="progress progress-sm">
                                <div class="progress-bar bg-danger" style="width: {{ absent_percentage }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shift Distribution -->
                <div class="card card-secondary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-business-time mr-1"></i>
                            Today's Shift Distribution
                        </h3>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            {% for shift in shift_distribution %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-{% if shift.name == 'Morning' %}sun text-warning{% elif shift.name == 'Afternoon' %}cloud-sun text-info{% else %}moon text-dark{% endif %} mr-2"></i>
                                    {{ shift.name }} Shift
                                </div>
                                <span class="badge badge-primary badge-pill">{{ shift.count }}</span>
                            </li>
                            {% empty %}
                            <li class="list-group-item text-center text-muted">No shift assignments for today</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- Role Distribution -->
                <div class="card card-dark">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-user-tag mr-1"></i>
                            Staff by Role
                        </h3>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            {% for role in role_distribution %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-{% if role.role == 'doctor' %}user-md text-primary{% elif role.role == 'nurse' %}user-nurse text-success{% elif role.role == 'admin' %}user-shield text-warning{% else %}user text-info{% endif %} mr-2"></i>
                                    {{ role.role_display }}
                                </div>
                                <span class="badge badge-secondary badge-pill">{{ role.count }}</span>
                            </li>
                            {% empty %}
                            <li class="list-group-item text-center text-muted">No staff data available</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emergency Alerts Section -->
        {% if emergency_alerts %}
        <div class="row mt-3">
            <div class="col-12">
                <div class="card card-danger">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Emergency Alerts
                        </h3>
                    </div>
                    <div class="card-body">
                        {% for alert in emergency_alerts %}
                        <div class="alert alert-danger alert-dismissible">
                            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                            <h5><i class="icon fas fa-ban"></i> Alert!</h5>
                            {{ alert.message }}
                            <small class="d-block mt-1">
                                <i class="fas fa-clock mr-1"></i>{{ alert.timestamp|timesince }} ago
                                {% if alert.triggered_by %}
                                | Triggered by: {{ alert.triggered_by.get_full_name }}
                                {% endif %}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Chart Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Department Distribution Chart
    var departmentCtx = document.getElementById('departmentChart').getContext('2d');
    var departmentChart = new Chart(departmentCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for dept in department_stats %}'{{ dept.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for dept in department_stats %}{{ dept.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: [{% for dept in department_stats %}'{{ dept.color }}'{% if not forloop.last %},{% endif %}{% endfor %}]
            }]
        },
        options: {
            maintainAspectRatio: false,
            responsive: true,
            legend: {
                display: false
            }
        }
    });

    // Attendance Trends Chart
    var attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
    var attendanceChart = new Chart(attendanceCtx, {
        type: 'line',
        data: {
            labels: {{ attendance_labels|safe }},
            datasets: [
                {
                    label: 'Present',
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    data: {{ attendance_present_data|safe }},
                    fill: true
                },
                {
                    label: 'Absent',
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    data: {{ attendance_absent_data|safe }},
                    fill: true
                },
                {
                    label: 'On Leave',
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    data: {{ attendance_leave_data|safe }},
                    fill: true
                }
            ]
        },
        options: {
            maintainAspectRatio: false,
            responsive: true,
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        }
    });
});
</script>

{% endblock %}