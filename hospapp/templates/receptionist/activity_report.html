{% extends "receptionist/base.html" %}

{% block title %}HMS | Activity Dashboard{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">
                    <i class="fas fa-chart-line text-primary mr-2"></i>
                    Activity Dashboard
                </h1>
                <p class="text-muted mb-0">Track your daily performance and productivity</p>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'receptionist' %}">Home</a></li>
                    <li class="breadcrumb-item active">Activity Report</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        
        <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ total_patients_registered }}</h3>
                        <p>Patients Registered</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="small-box-footer">
                        Total registrations</i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ total_admissions_made }}</h3>
                        <p>Admissions Processed</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-hospital-user"></i>
                    </div>
                    <div class="small-box-footer">
                        Admissions handled</i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ total_appointments_scheduled }}</h3>
                        <p>Appointments Booked</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="small-box-footer">
                        Scheduled appointments</i>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ total_referrals_made }}</h3>
                        <p>Referrals Made</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-share-alt"></i>
                    </div>
                    <div class="small-box-footer">
                        Patient referrals</i>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-info-circle mr-2"></i>
                            Performance Summary
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 text-center">
                                <div class="progress-group">
                                    <span class="float-right"><b>{{ total_patients_registered }}</b>/&infin;</span>
                                    <span class="progress-text">Patient Registrations</span>
                                    <div class="progress progress-sm">
                                        <div class="progress-bar bg-info" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="progress-group">
                                    <span class="float-right"><b>{{ total_admissions_made }}</b>/&infin;</span>
                                    <span class="progress-text">Admissions Handled</span>
                                    <div class="progress progress-sm">
                                        <div class="progress-bar bg-success" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="progress-group">
                                    <span class="float-right"><b>{{ total_appointments_scheduled }}</b>/&infin;</span>
                                    <span class="progress-text">Appointments Booked</span>
                                    <div class="progress progress-sm">
                                        <div class="progress-bar bg-warning" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="progress-group">
                                    <span class="float-right"><b>{{ total_referrals_made }}</b>/&infin;</span>
                                    <span class="progress-text">Referrals Made</span>
                                    <div class="progress progress-sm">
                                        <div class="progress-bar bg-danger" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12"> {# Changed to col-12 to take full width for the comprehensive table #}
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-users mr-2"></i>
                            All Patient Data
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-info">{{ patients_registered|length }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="bg-light">
                                    <tr>
                                        <th><i class="fas fa-image mr-1"></i>Picture</th>
                                        <th><i class="fas fa-user mr-1"></i>Patient Name</th>
                                        <th><i class="fas fa-id-card mr-1"></i>Patient ID</th>
                                        <th><i class="fas fa-calendar-alt mr-1"></i>Date of Birth</th>
                                        <th><i class="fas fa-venus-mars mr-1"></i>Gender</th>
                                        <th><i class="fas fa-phone mr-1"></i>Contact</th>
                                        <th><i class="fas fa-envelope mr-1"></i>Email</th>
                                        <th><i class="fas fa-map-marker-alt mr-1"></i>Address</th>
                                        <th><i class="fas fa-clock mr-1"></i>Registered Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for patient in patients_registered %} {# Removed slice filter #}
                                    <tr>
                                        <td>
                                            {% if patient.photo %}
                                                <img src="{{ patient.photo.url }}" alt="Profile Picture" class="img-circle img-size-32 mr-2" style="width: 32px; height: 32px; object-fit: cover;">
                                            {% else %}
                                                <img src="/static/path/to/default_profile_pic.png" alt="Default Picture" class="img-circle img-size-32 mr-2" style="width: 32px; height: 32px; object-fit: cover;"> {# Provide a path to a default image #}
                                            {% endif %}
                                        </td>
                                        <td><strong>{{ patient.full_name }}</strong></td>
                                        <td>{{ patient.patient_id }}</td> {# Assuming a patient_id field exists #}
                                        <td>{{ patient.date_of_birth|date:"M d, Y" }}</td> {# Assuming date_of_birth field exists #}
                                        <td>{{ patient.gender }}</td>
                                        <td>
                                            <span class="badge badge-secondary">
                                                <i class="fas fa-phone-alt mr-1"></i>{{ patient.phone }}
                                            </span>
                                        </td>
                                        <td>{{ patient.email|default:"N/A" }}</td>
                                        <td>{{ patient.address|default:"N/A" }}</td> {# Assuming an address field exists #}
                                        <td>
                                            <small class="text-success">
                                                <i class="fas fa-calendar mr-1"></i>
                                                {{ patient.date_registered|date:"M d, Y" }}
                                                <br>{{ patient.date_registered|date:"H:i" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="9" class="text-center text-muted py-4">
                                            <i class="fas fa-users fa-2x mb-2"></i>
                                            <br>No patient registrations yet
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="card card-success">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-hospital mr-2"></i>
                            Recent Admissions
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-success">{{ admissions_made|length }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="bg-light">
                                    <tr>
                                        <th><i class="fas fa-user-injured mr-1"></i>Patient</th>
                                        <th><i class="fas fa-user-md mr-1"></i>Doctor</th>
                                        <th><i class="fas fa-info-circle mr-1"></i>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for admission in admissions_made|slice:":5" %}
                                    <tr>
                                        <td>
                                            <strong>{{ admission.patient.full_name }}</strong>
                                            <br><small class="text-muted">{{ admission.admission_date|date:"M d, Y" }}</small>
                                        </td>
                                        <td>
                                            <span class="text-primary">
                                                <i class="fas fa-stethoscope mr-1"></i>
                                                {{ admission.doctor_assigned|default:"Not assigned" }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if admission.status == 'Admitted' %}
                                            <span class="badge badge-success">
                                                <i class="fas fa-check mr-1"></i>{{ admission.status }}
                                            </span>
                                            {% else %}
                                            <span class="badge badge-warning">
                                                <i class="fas fa-clock mr-1"></i>{{ admission.status }}
                                            </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">
                                            <i class="fas fa-hospital fa-2x mb-2"></i>
                                            <br>No admissions processed yet
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if admissions_made|length > 5 %}
                        <div class="card-footer text-center">
                            <small class="text-muted">Showing 5 of {{ admissions_made|length }} admissions</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            Scheduled Appointments
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-warning">{{ appointments_scheduled|length }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="bg-light">
                                    <tr>
                                        <th><i class="fas fa-user mr-1"></i>Patient</th>
                                        <th><i class="fas fa-building mr-1"></i>Department</th>
                                        <th><i class="fas fa-clock mr-1"></i>Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for appointment in appointments_scheduled|slice:":5" %}
                                    <tr>
                                        <td>
                                            <strong>{{ appointment.patient.full_name }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge badge-primary">
                                                {{ appointment.department.name }}
                                            </span>
                                        </td>
                                        <td>
                                            <small class="text-warning">
                                                <i class="fas fa-calendar mr-1"></i>
                                                {{ appointment.scheduled_time|date:"M d" }}
                                                <br><i class="fas fa-clock mr-1"></i>
                                                {{ appointment.scheduled_time|date:"H:i" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">
                                            <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                            <br>No appointments scheduled yet
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if appointments_scheduled|length > 5 %}
                        <div class="card-footer text-center">
                            <small class="text-muted">Showing 5 of {{ appointments_scheduled|length }} appointments</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="card card-danger">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-share-alt mr-2"></i>
                            Patient Referrals
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-danger">{{ referrals_made|length }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="bg-light">
                                    <tr>
                                        <th><i class="fas fa-user mr-1"></i>Patient</th>
                                        <th><i class="fas fa-building mr-1"></i>Department</th>
                                        <th><i class="fas fa-sticky-note mr-1"></i>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for referral in referrals_made|slice:":5" %}
                                    <tr>
                                        <td>
                                            <strong>{{ referral.patient.full_name }}</strong>
                                            <br><small class="text-muted">{{ referral.created_at|date:"M d, Y" }}</small>
                                        </td>
                                        <td>
                                            <span class="badge badge-info">
                                                {{ referral.department.name }}
                                            </span>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {% if referral.notes %}
                                                <i class="fas fa-comment mr-1"></i>
                                                {{ referral.notes|truncatechars:30 }}
                                                {% else %}
                                                <i class="fas fa-minus mr-1"></i>No notes
                                                {% endif %}
                                            </small>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">
                                            <i class="fas fa-share-alt fa-2x mb-2"></i>
                                            <br>No referrals made yet
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if referrals_made|length > 5 %}
                        <div class="card-footer text-center">
                            <small class="text-muted">Showing 5 of {{ referrals_made|length }} referrals</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-secondary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bolt mr-2"></i>
                            Quick Actions
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-sm-6 col-12 mb-2">
                                <a href="{% url 'register_patient' %}" class="btn btn-info btn-block">
                                    <i class="fas fa-user-plus mr-2"></i>
                                    Register New Patient
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 col-12 mb-2">
                                <a href="{% url 'register_patient' %}#admit" class="btn btn-success btn-block">
                                    <i class="fas fa-hospital-user mr-2"></i>
                                    Process Admission
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 col-12 mb-2">
                                <a href="{% url 'register_patient' %}#appointment" class="btn btn-warning btn-block">
                                    <i class="fas fa-calendar-plus mr-2"></i>
                                    Schedule Appointment
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 col-12 mb-2">
                                <a href="{% url 'register_patient' %}#refer" class="btn btn-danger btn-block">
                                    <i class="fas fa-share-alt mr-2"></i>
                                    Make Referral
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>
{% endblock %}