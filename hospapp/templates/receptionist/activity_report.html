{% extends "receptionist/base.html" %}

{% block title %}HMS | Activity Reports{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">
                    <i class="fas fa-chart-bar text-primary mr-2"></i>
                    Activity Reports
                </h1>
                <p class="text-muted mb-0">Generate custom reports for your activities</p>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'receptionist' %}">Home</a></li>
                    <li class="breadcrumb-item active">Activity Reports</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-4">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-filter mr-2"></i>
                            Report Filters
                        </h3>
                    </div>
                    <form id="reportForm" method="POST">
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="form-group">
                                <label for="patient_select">
                                    <i class="fas fa-users mr-1"></i>
                                    Select Patient
                                </label>
                                <select class="form-control select2" id="patient_select" name="patients" data-placeholder="Select a patient or 'All Patients'">
                                    <option value="all">All Patients</option>
                                    {% for patient in all_patients %}
                                    <option value="{{ patient.id }}">{{ patient.full_name }} - {{ patient.patient_id }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="report_type">
                                    <i class="fas fa-clipboard-list mr-1"></i>
                                    Report Type
                                </label>
                                <select class="form-control select2" id="report_type" name="report_type" required data-placeholder="Choose report type...">
                                    <option value="">Choose report type...</option>
                                    <option value="registrations">Patient Registrations</option>
                                    <option value="admissions">Patient Admissions</option>
                                    <option value="appointments">Scheduled Appointments</option>
                                    <option value="referrals">Patient Referrals</option>
                                    <option value="billing_payments">Patient Billing & Payments</option> {# Added option #}
                                    <option value="all_activity">All Activity Types</option> {# Renamed 'all' for clarity #}
                                </select>
                            </div>

                            <div class="form-group">
                                <label>
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    Date Range
                                </label>
                                <div class="row">
                                    <div class="col">
                                        <input type="date" class="form-control" id="start_date" name="start_date" placeholder="Start Date">
                                    </div>
                                    <div class="col">
                                        <input type="date" class="form-control" id="end_date" name="end_date" placeholder="End Date">
                                    </div>
                                </div>
                                <small class="form-text text-muted">Leave empty for all-time data</small>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="fas fa-chart-line mr-2"></i>
                                Generate Report
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-md-8">
                <div id="reportResults" class="card" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-table mr-2"></i>
                            Report Results
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="maximize">
                                <i class="fas fa-expand"></i>
                            </button>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-success" id="exportExcel">
                                    <i class="fas fa-file-excel mr-1"></i>
                                    Excel
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" id="exportPdf">
                                    <i class="fas fa-file-pdf mr-1"></i>
                                    PDF
                                </button>
                                <button type="button" class="btn btn-sm btn-info" id="printReport">
                                    <i class="fas fa-print mr-1"></i>
                                    Print
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="reportTable" class="table table-sm table-striped table-hover">
                                <thead class="bg-light">
                                    </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div id="reportSummary" class="text-muted">
                            </div>
                    </div>
                </div>

                <div id="welcomeMessage" class="card card-outline card-secondary">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">Welcome to Activity Reports</h4>
                        <p class="text-muted">
                            Use the filters on the left to generate detailed reports about your receptionist activities.
                            <br>Select patients, report types, and date ranges to get started.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
$(document).ready(function() {
    // Initialize Select2 for Patient Selection (single select)
    $('#patient_select').select2({
        theme: 'bootstrap4',
        width: '100%',
        minimumResultsForSearch: 10 // Show search box if more than 10 results
    });

    // Initialize Select2 for Report Type Selection (single select)
    $('#report_type').select2({
        theme: 'bootstrap4',
        width: '100%',
        minimumResultsForSearch: Infinity // Hides the search box for this single-select dropdown
    });


    // Handle form submission
    $('#reportForm').on('submit', function(e) {
        e.preventDefault();

        // Show loading state
        var $btn = $(this).find('button[type="submit"]');
        var originalText = $btn.html();
        $btn.html('<i class="fas fa-spinner fa-spin mr-2"></i>Generating...').prop('disabled', true);

        // Hide welcome message and show report results
        $('#welcomeMessage').hide();
        $('#reportResults').show();

        // Simulate report generation (replace with actual AJAX call)
        setTimeout(function() {
            generateReportTable();
            $btn.html(originalText).prop('disabled', false);
        }, 1500);
    });

    // Export functions (remain as alerts for demonstration)
    $('#exportExcel').on('click', function() {
        alert('Excel export functionality would be implemented here');
    });

    $('#exportPdf').on('click', function() {
        alert('PDF export functionality would be implemented here');
    });

    $('#printReport').on('click', function() {
        window.print();
    });

    function generateReportTable() {
        var reportType = $('#report_type').val();
        var tableHeaders = '';
        var tableBody = '';
        var summary = '';

        // Generate different table structures based on report type
        switch(reportType) {
            case 'registrations':
                tableHeaders = `
                    <tr>
                        <th><i class="fas fa-user mr-1"></i>Patient Name</th>
                        <th><i class="fas fa-id-card mr-1"></i>Patient ID</th>
                        <th><i class="fas fa-calendar mr-1"></i>Registration Date</th>
                        <th><i class="fas fa-phone mr-1"></i>Contact</th>
                        <th><i class="fas fa-venus-mars mr-1"></i>Gender</th>
                    </tr>
                `;
                summary = 'Showing patient registration data based on selected filters';
                break;
            case 'admissions':
                tableHeaders = `
                    <tr>
                        <th><i class="fas fa-user-injured mr-1"></i>Patient</th>
                        <th><i class="fas fa-calendar mr-1"></i>Admission Date</th>
                        <th><i class="fas fa-user-md mr-1"></i>Doctor</th>
                        <th><i class="fas fa-info-circle mr-1"></i>Status</th>
                        <th><i class="fas fa-building mr-1"></i>Department</th>
                    </tr>
                `;
                summary = 'Showing admission records based on selected filters';
                break;
            case 'appointments':
                tableHeaders = `
                    <tr>
                        <th><i class="fas fa-user mr-1"></i>Patient</th>
                        <th><i class="fas fa-calendar-check mr-1"></i>Appointment Date</th>
                        <th><i class="fas fa-clock mr-1"></i>Time</th>
                        <th><i class="fas fa-building mr-1"></i>Department</th>
                        <th><i class="fas fa-info-circle mr-1"></i>Status</th>
                    </tr>
                `;
                summary = 'Showing scheduled appointments based on selected filters';
                break;
            case 'referrals':
                tableHeaders = `
                    <tr>
                        <th><i class="fas fa-user mr-1"></i>Patient</th>
                        <th><i class="fas fa-calendar mr-1"></i>Referral Date</th>
                        <th><i class="fas fa-building mr-1"></i>Department</th>
                        <th><i class="fas fa-sticky-note mr-1"></i>Notes</th>
                        <th><i class="fas fa-info-circle mr-1"></i>Status</th>
                    </tr>
                `;
                summary = 'Showing patient referrals based on selected filters';
                break;
            case 'billing_payments': // New case for Billing & Payments
                tableHeaders = `
                    <tr>
                        <th><i class="fas fa-user mr-1"></i>Patient</th>
                        <th><i class="fas fa-file-invoice-dollar mr-1"></i>Bill Number</th>
                        <th><i class="fas fa-calendar mr-1"></i>Date</th>
                        <th><i class="fas fa-hand-holding-usd mr-1"></i>Amount</th>
                        <th><i class="fas fa-money-check-alt mr-1"></i>Status</th>
                    </tr>
                `;
                summary = 'Showing patient billing and payment data based on selected filters';
                break;
            case 'all_activity': // Updated case
            default:
                tableHeaders = `
                    <tr>
                        <th><i class="fas fa-list mr-1"></i>Activity Type</th>
                        <th><i class="fas fa-user mr-1"></i>Patient</th>
                        <th><i class="fas fa-calendar mr-1"></i>Date</th>
                        <th><i class="fas fa-info-circle mr-1"></i>Details</th>
                    </tr>
                `;
                summary = 'Showing a comprehensive activity report for all types based on selected filters.';
        }

        // Sample data row (replace with actual data from backend)
        tableBody = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <br>Report data would be populated here based on your filters
                    <br><small>This is a template - integrate with your backend data</small>
                </td>
            </tr>
        `;

        $('#reportTable thead').html(tableHeaders);
        $('#reportTable tbody').html(tableBody);
        $('#reportSummary').html('<i class="fas fa-info-circle mr-1"></i>' + summary);
    }
});
</script>
{% endblock %}