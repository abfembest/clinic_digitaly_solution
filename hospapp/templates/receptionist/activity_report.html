{% extends "receptionist/base.html" %}
{% load static %}

{% block title %}HMS | Activity Report{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Activity Report</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'receptionist' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="#">Receptionist</a></li>
                    <li class="breadcrumb-item active">Reports</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="generate-reports-page">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-4">
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-bar me-1"></i>
                            Generate Activity Reports
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="reportForm" novalidate>
                            <div class="mb-3">
                                <label for="reportType" class="form-label">Report Type</label>
                                <select class="form-control select2bs4" id="reportType" name="report_type">
                                    <option value="">Select Report Type</option>
                                    <option value="all_combined_reports">All Combined Reports</option>
                                    <option value="individual_combined">Individual Patient Report</option>
                                    <option value="appointments">Appointments</option>
                                    <option value="admissions">Admissions</option>
                                    <option value="referrals">Department Referrals</option>
                                    <option value="bills">Patient Bills</option>
                                    <option value="payments">Patient Payments</option>
                                    <option value="all_patients">Patients Registered</option>
                                    <option value="staff_attendance">Staff Attendance</option>
                                    <option value="staff_onboarding_offboarding">Staff Onboarding/Offboarding</option>
                                </select>
                            </div>

                            <div class="mb-3" id="patientSelectCard" style="display: none;">
                                <label for="patientId" class="form-label">Select Patient</label>
                                <select class="form-control select2bs4" id="patientId" name="patient_id">
                                    <option value="">Select a Patient</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}">{{ patient.full_name }} ({{ patient.patient_id }})</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="alldate" name="alldate" checked>
                                <label class="form-check-label" for="alldate">All Dates</label>
                            </div>

                            <div class="row" id="dateRangeCard" style="display: none;">
                                <div class="col-md-6 mb-3">
                                    <label for="startDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="startDate" name="start_date">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="endDate" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="endDate" name="end_date">
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="generateReportBtn">Generate Report</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div id="singleReportContainer" class="card card-info" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title" id="reportTableTitle">Generated Report</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="btn btn-tool" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-striped" id="reportDataTable">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer text-center" id="reportTableFooter" style="display: none;">
                        <span class="text-muted" id="recordCount">Total Records: 0</span>
                    </div>
                </div>
                <div id="combinedReportsDisplayArea" class="row">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i> Activity Report Generated Successfully
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-file-download fa-4x text-success"></i>
                </div>
                <h5>Your report is ready to view.</h5>
                <p>You can also export it as an Excel file.</p>
                <div class="mt-4">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i> Report Generation Failed
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-times-circle fa-4x text-danger"></i>
                </div>
                <p id="errorMessage"></p>
                <div class="mt-4">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const reportTypeSelect = document.getElementById('reportType');
        const patientSelectCard = document.getElementById('patientSelectCard');
        const alldateCheckbox = document.getElementById('alldate');
        const dateRangeCard = document.getElementById('dateRangeCard');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        // Ensure the patient selection card is hidden on page load
        patientSelectCard.style.display = 'none';

        // Initialize Select2 after the page loads
        $('.select2bs4').select2({
            theme: 'bootstrap4'
        });

        reportTypeSelect.addEventListener('change', function() {
            const value = this.value;
            if (value === 'individual_combined') {
                patientSelectCard.style.display = 'block';
            } else {
                patientSelectCard.style.display = 'none';
            }
        });

        alldateCheckbox.addEventListener('change', function () {
            if (this.checked) {
                dateRangeCard.style.display = 'none';
                startDateInput.disabled = true;
                endDateInput.disabled = true;
            } else {
                dateRangeCard.style.display = 'flex';
                startDateInput.disabled = false;
                endDateInput.disabled = false;
            }
        });

        document.getElementById('reportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateReport();
        });
    });

    function generateReport() {
        const reportType = document.getElementById('reportType').value;
        const patientId = document.getElementById('patientId').value;
        const alldateFilter = document.getElementById('alldate').checked;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const reportForm = document.getElementById('reportForm');
        
        const data = {
            report_type: reportType,
            patient_id: patientId,
            alldate: alldateFilter,
            start_date: startDate,
            end_date: endDate,
        };

        const singleReportContainer = document.getElementById('singleReportContainer');
        const combinedReportsDisplayArea = document.getElementById('combinedReportsDisplayArea');
        singleReportContainer.style.display = 'none';
        combinedReportsDisplayArea.innerHTML = '';

        fetch('{% url "generate_activity_report" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(data),
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => Promise.reject(errorData));
            }
            return response.json();
        })
        .then(data => {
            if (data.combined_reports) {
                displayCombinedReports(data.combined_reports);
            } else {
                displaySingleReport(data);
            }
            new bootstrap.Modal(document.getElementById('successModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = error.error || 'An unexpected error occurred. Please try again.';
            new bootstrap.Modal(document.getElementById('errorModal')).show();
        });
    }

    function displaySingleReport(reportData) {
        const singleReportContainer = document.getElementById('singleReportContainer');
        const reportTableTitle = document.getElementById('reportTableTitle');
        const reportDataTable = document.getElementById('reportDataTable');
        const reportTableFooter = document.getElementById('reportTableFooter');
        const recordCountSpan = document.getElementById('recordCount');

        const headers = reportData.headers;
        const data = reportData.data;

        reportTableTitle.textContent = reportData.title;
        recordCountSpan.textContent = `Total Records: ${reportData.count}`;
        reportTableFooter.style.display = 'block';

        let headerHtml = '<tr>';
        headers.forEach(header => {
            headerHtml += `<th>${header}</th>`;
        });
        headerHtml += '</tr>';
        reportDataTable.querySelector('thead').innerHTML = headerHtml;

        let bodyHtml = '';
        if (data.length > 0) {
            data.forEach(row => {
                bodyHtml += '<tr>';
                headers.forEach(header => {
                    const key = formatHeaderToKey(header);
                    bodyHtml += `<td>${row[key] || 'N/A'}</td>`;
                });
                bodyHtml += '</tr>';
            });
        } else {
            bodyHtml = '<tr><td colspan="' + headers.length + '" class="text-center">No records found for the selected criteria.</td></tr>';
        }
        reportDataTable.querySelector('tbody').innerHTML = bodyHtml;

        singleReportContainer.style.display = 'block';
    }

    function displayCombinedReports(combinedReports) {
        const combinedReportsDisplayArea = document.getElementById('combinedReportsDisplayArea');
        combinedReportsDisplayArea.innerHTML = '';

        const reportOrder = [
            'all_patients', 'appointments', 'admissions', 'referrals', 'bills', 'payments',
            'staff_attendance', 'staff_onboarding_offboarding'
        ];
        
        reportOrder.forEach(reportKey => {
            const reportData = combinedReports[reportKey];
            if (reportData) {
                const cardHtml = `
                    <div class="col-12 mb-4">
                        <div class="card card-outline card-info">
                            <div class="card-header">
                                <h3 class="card-title">${reportData.title}</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button type="button" class="btn btn-tool" onclick="exportCombinedToExcel('${reportData.title}', this)">
                                        <i class="fas fa-file-excel"></i> Export
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover table-striped">
                                        <thead>
                                            <tr>
                                                ${reportData.headers.map(h => `<th>${h}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${reportData.data.length > 0 ? reportData.data.map(row => `
                                                <tr>
                                                    ${reportData.headers.map(h => `<td>${row[formatHeaderToKey(h)] || 'N/A'}</td>`).join('')}
                                                </tr>
                                            `).join('') : `<tr><td colspan="${reportData.headers.length}" class="text-center">No records found.</td></tr>`}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer text-center">
                                <span class="text-muted">Total Records: ${reportData.count}</span>
                            </div>
                        </div>
                    </div>
                `;
                combinedReportsDisplayArea.innerHTML += cardHtml;
            }
        });
    }

    function formatHeaderToKey(header) {
        return header.toLowerCase().replace(/[^a-z0-9]/g, '_');
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function exportToExcel() {
        const table = document.getElementById('reportDataTable');
        const title = document.getElementById('reportTableTitle').textContent;
        const wb = XLSX.utils.table_to_book(table);
        const cleanFilename = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        XLSX.writeFile(wb, `${cleanFilename}_activity_report.xlsx`);
    }

    function exportCombinedToExcel(filename, button) {
        const table = button.closest('.card').querySelector('table');
        if (table) {
            const wb = XLSX.utils.table_to_book(table);
            const cleanFilename = filename.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            XLSX.writeFile(wb, `${cleanFilename}_activity_report.xlsx`);
        }
    }
</script>
{% endblock %}